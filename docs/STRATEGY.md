# TP/SL 백테스팅 전략 상세 설명

## 📋 목차
1. [전략 개요](#전략-개요)
2. [수학적 근거](#수학적-근거)
3. [전략 파라미터](#전략-파라미터)
4. [청산 로직](#청산-로직)
5. [전략 장점 및 한계](#전략-장점-및-한계)
6. [백테스팅 결과 해석](#백테스팅-결과-해석)

---

## 전략 개요

이 백테스팅 시스템은 **AI 예측 기반 진입 + 분할 청산 전략**을 사용합니다.

### 핵심 컨셉
- **진입**: AI 모델이 상승 확률이 높다고 판단한 시점에만 매수 (pred_proba_up ≥ 0.6)
- **포지션 사이징**: Kelly Criterion으로 과학적 리스크 관리
- **청산**: 단일 전량 청산이 아닌, 수익률과 시간에 따른 **분할 청산**

### 왜 분할 청산인가?
전통적인 "ALL-IN 진입 → ALL-OUT 청산" 방식의 문제점:
- ✗ 최적 청산 시점을 알 수 없음 (과거 데이터만 봤을 때는 명확, 실시간에서는 불가능)
- ✗ 수익 실현과 추가 상승 포착 사이의 트레이드오프 해결 불가
- ✗ 시간 가치 감소(Time Decay) 무시

분할 청산의 장점:
- ✓ 수익 구간별로 점진적 이익 실현
- ✓ 나머지 포지션으로 추가 상승 포착 가능
- ✓ 장기 보유에 따른 리스크 증가 반영 (Time-Decay)

---

## 수학적 근거

### 1. Kelly Criterion (포지션 사이징)

**공식**:
```
F = (R × W - (1-W)) / R
```

- `F`: Kelly Fraction (투자 비율, 0~1)
- `W`: Win Probability (승률, pred_proba_up 사용)
- `R`: Risk-Reward Ratio = (TP - Entry) / (Entry - SL)

**적용 예시**:
```
- 진입가: 5,000,000원
- TP: 5,150,000원 (+3%)
- SL: 4,900,000원 (-2%)
- pred_proba_up: 0.70 (70% 확률로 상승 예측)

R = (5,150,000 - 5,000,000) / (5,000,000 - 4,900,000) = 1.5
F = (1.5 × 0.70 - 0.30) / 1.5 = 0.50 (50% 투자)
```

**보정**:
```
최종 투자 비율 = Kelly Fraction × Confidence
```

- `Confidence`: AI 모델의 신뢰도 (max_proba - 0.5) / 0.5
- 예: max_proba=0.8 → confidence=0.6 → 투자 비율 = 0.50 × 0.6 = 0.30 (30%)

**수학적 정당성**:
- Kelly Criterion은 **장기 복리 성장률을 최대화**하는 최적 투자 비율
- 과대 투자 방지: 예측이 틀렸을 때 과도한 손실 방지
- 수학적으로 증명된 방법 (Claude Shannon, Ed Thorp)

---

### 2. Profit Ladder (계단식 익절)

**개념**: 수익률이 일정 구간(5%, 10%, 20%)에 도달할 때마다 점진적으로 포지션을 청산합니다.

**설정**:
```java
PROFIT_LEVEL_1 = 5%   → EXIT_RATIO_1 = 30% 청산
PROFIT_LEVEL_2 = 10%  → EXIT_RATIO_2 = 30% 청산
PROFIT_LEVEL_3 = 20%  → EXIT_RATIO_3 = 40% 청산
```

**작동 원리**:
1. 수익률 5% 도달 → 포지션의 30% 청산 (이익 실현)
2. 수익률 10% 도달 → 남은 포지션의 30% 청산 (추가 이익)
3. 수익률 20% 도달 → 남은 포지션의 40% 청산 (큰 상승 포착)

**수학적 근거 (Utility Theory)**:
- 인간의 효용(Utility)은 **수익 증가에 따라 체감**합니다 (Diminishing Marginal Utility)
- 예: 첫 100만원 이익의 기쁨 > 이미 1000만원 벌고 나서 추가 100만원 이익의 기쁨
- 따라서 **수익이 클수록 점진적으로 포지션을 줄여 확정 이익을 늘리는 것이 합리적**

**상위 레벨 발동 시 하위 레벨 자동 발동**:
```
예: 수익률이 한 번에 12%로 점프
→ Level 1 (5%) 자동 발동: 30% 청산
→ Level 2 (10%) 자동 발동: 30% 청산
→ 총 60% 청산, 40% 포지션 유지
```

---

### 3. Time-Decay (시간 기반 청산)

**개념**: 보유 기간이 길어질수록 포지션을 줄여 리스크를 낮춥니다.

**설정**:
```java
TIME_DECAY_DAY_1 = 6일 → TIME_DECAY_RATIO_1 = 20% 청산
TIME_DECAY_DAY_2 = 7일 → TIME_DECAY_RATIO_2 = 40% 청산
```

**작동 원리**:
1. 6일차 종가 시점 → 포지션의 20% 청산
2. 7일차 종가 시점 → 포지션의 40% 청산
3. 8일차 종가 시점 → 남은 포지션 전량 청산 (TIMEOUT)

**수학적 근거 (Option Theta 유사 개념)**:
- 옵션의 **Theta (시간 가치 감소율)**와 유사한 개념
- 시간이 지날수록 "예측의 신뢰도"는 감소합니다 (정보의 시간 가치 감소)
- 예: "오늘 상승 예측"은 신뢰도 높음, "8일 후에도 상승 중"은 불확실성 증가
- 따라서 **시간이 지날수록 포지션을 줄여 불확실성을 회피**하는 것이 합리적

**Profit Ladder와의 차이**:
- **Profit Ladder**: 수익률 기준 (시장이 유리하게 움직일 때)
- **Time-Decay**: 시간 기준 (시장이 횡보하거나 불리할 때도 작동)
- **보완 관계**: 둘 다 트리거될 수 있음 (예: 5% 수익률 + 6일차 → 30% + 20% = 50% 청산)

---

## 전략 파라미터

### 진입 조건
```java
// AI 예측 임계값
pred_proba_up >= 0.6  // 60% 이상 상승 확률일 때만 진입

// 진입 시각
매 예측일 오전 9:00 첫 1분봉 시가
```

### TP/SL 설정
```java
// 익절가 (Take Profit)
TP = Entry Price × 1.03  // +3%

// 손절가 (Stop Loss)
SL = Entry Price × 0.98  // -2%
```

### Profit Ladder 설정
```java
private static final BigDecimal PROFIT_LEVEL_1 = new BigDecimal("0.05"); // 5%
private static final BigDecimal PROFIT_LEVEL_2 = new BigDecimal("0.10"); // 10%
private static final BigDecimal PROFIT_LEVEL_3 = new BigDecimal("0.20"); // 20%

private static final BigDecimal EXIT_RATIO_1 = new BigDecimal("0.30"); // 30%
private static final BigDecimal EXIT_RATIO_2 = new BigDecimal("0.30"); // 30%
private static final BigDecimal EXIT_RATIO_3 = new BigDecimal("0.40"); // 40%
```

### Time-Decay 설정
```java
private static final int TIME_DECAY_DAY_1 = 6; // 6일차
private static final int TIME_DECAY_DAY_2 = 7; // 7일차

private static final BigDecimal TIME_DECAY_RATIO_1 = new BigDecimal("0.20"); // 20%
private static final BigDecimal TIME_DECAY_RATIO_2 = new BigDecimal("0.40"); // 40%
```

### 수수료 및 비용
```java
FEE_RATE = 0.0005  // 0.05% (업비트 편도 수수료)
→ 매수 + 매도 = 0.1% (왕복 수수료)
```

---

## 청산 로직

### 청산 우선순위 (Priority)

**매 1분봉마다 다음 순서로 청산 조건 체크:**

```
1. ⚠️ Stop Loss (최우선) - 저가(low price) 체크
   → 저가 <= SL 가격 → 즉시 전량 청산 (손실 제한)

2. 🎯 Take Profit (고우선) - 고가(high price) 체크
   → 고가 >= TP 가격 → 즉시 전량 청산 (목표 수익 달성)

3. 📈 Profit Ladder (중우선) - 종가(close price) 체크
   → 수익률 >= 5%, 10%, 20% → 점진적 부분 청산

4. ⏱️ Time-Decay (중우선) - 종가(close price) 체크
   → 보유 일수 >= 6일, 7일 → 점진적 부분 청산

5. ⏰ Timeout (최종) - 8일차 종가
   → 남은 포지션 전량 청산
```

### 예시 시나리오

**시나리오 1: 빠른 상승 후 익절**
```
- Day 0, 09:00: 5,000,000원에 진입 (포지션 1000원)
- Day 1, 14:30: 5,250,000원 도달 (수익률 5%)
  → Level 1 트리거: 300원 청산 (30%)
  → 남은 포지션: 700원
- Day 2, 11:00: 5,500,000원 도달 (수익률 10%)
  → Level 2 트리거: 210원 청산 (30% of 700원)
  → 남은 포지션: 490원
- Day 3, 10:00: 고가 5,150,000원 (TP 도달)
  → Take Profit 트리거: 490원 전량 청산
  → 총 청산: 100% (평균 청산가: 5,316,326원)
```

**시나리오 2: 횡보 후 Time-Decay**
```
- Day 0, 09:00: 5,000,000원에 진입 (포지션 1000원)
- Day 1~5: 5,000,000원 ~ 5,100,000원 사이 횡보
  → 수익률 2~4% 유지 (Profit Ladder 미발동)
- Day 6, 15:00: 종가 5,125,000원 (2.5% 수익)
  → Time-Decay Day 6 트리거: 200원 청산 (20%)
  → 남은 포지션: 800원
- Day 7, 15:00: 종가 5,150,000원 (3% 수익)
  → Time-Decay Day 7 트리거: 320원 청산 (40% of 800원)
  → 남은 포지션: 480원
- Day 8, 15:00: 종가 5,100,000원 (2% 수익)
  → Timeout 트리거: 480원 전량 청산
  → 총 청산: 100% (평균 청산가: 5,129,166원)
```

**시나리오 3: 급락 후 손절**
```
- Day 0, 09:00: 5,000,000원에 진입 (포지션 1000원)
- Day 1, 10:30: 저가 4,900,000원 (SL 도달)
  → Stop Loss 트리거: 1000원 전량 청산
  → 총 손실: -2%
```

---

## 전략 장점 및 한계

### 장점

#### 1. 수학적으로 근거 있는 포지션 사이징
- ✓ Kelly Criterion: 장기 복리 성장률 최대화 (수학적 증명)
- ✓ 과대 투자 방지: 예측 불확실성에 따라 자동 조절
- ✓ 모델 신뢰도 반영: Confidence로 2차 보정

#### 2. 점진적 이익 실현 (Profit Ladder)
- ✓ 수익 구간별 확정 이익 증가
- ✓ 추가 상승 시 나머지 포지션으로 포착 가능
- ✓ Utility Theory 기반 합리적 행동

#### 3. 시간 리스크 관리 (Time-Decay)
- ✓ 예측 정확도의 시간 감소 반영
- ✓ 장기 보유 리스크 자동 감소
- ✓ 횡보장에서도 작동 (Profit Ladder 보완)

#### 4. 명확한 청산 우선순위
- ✓ Stop Loss 최우선: 손실 제한
- ✓ Take Profit 고우선: 목표 수익 확정
- ✓ Profit Ladder / Time-Decay 중우선: 점진적 청산
- ✓ Timeout 최종: 강제 청산

#### 5. 1분봉 정밀 시뮬레이션
- ✓ 실제 시장 움직임을 정밀하게 추적 (8일 × 1440분 = 11,520개 데이터 포인트)
- ✓ 고가/저가/종가 각각의 역할 명확히 구분
- ✓ 현실적인 슬리피지 및 수수료 반영

---

### 한계

#### 1. 과거 데이터 기반
- ✗ 백테스팅은 **과거 데이터**로만 검증
- ✗ 미래 시장은 과거와 다를 수 있음 (블랙 스완 이벤트)
- ✗ Overfitting 위험: 과거에 최적이었던 파라미터가 미래에도 유효한지 불확실

#### 2. 슬리피지 및 유동성
- ✗ 백테스팅에서는 "원하는 가격에 체결"을 가정
- ✗ 실제 시장에서는 대량 주문 시 슬리피지 발생 가능
- ✗ 급등/급락 시 유동성 부족으로 원하는 가격 체결 불가능

#### 3. 수수료 간소화
- ✗ 업비트 수수료 0.05% (편도) 가정
- ✗ 실제로는 거래량, VIP 등급에 따라 변동
- ✗ 분할 청산으로 거래 횟수 증가 → 수수료 누적

#### 4. AI 예측 정확도 의존
- ✗ 전략의 수익성은 **AI 모델의 예측 정확도에 직접 의존**
- ✗ AI 모델이 부정확하면 Kelly Criterion도 실패
- ✗ 모델 재학습 및 지속적 성능 모니터링 필요

#### 5. 심리적 요인 무시
- ✗ 백테스팅은 "감정 없는 로봇"을 가정
- ✗ 실제 거래에서는 공포/탐욕에 의한 판단 오류 발생
- ✗ "손실 회피 편향", "확증 편향" 등 행동 경제학적 요인 무시

---

## 백테스팅 결과 해석

### 주요 지표

#### 1. 수익률 (Total Return %)
```
수익률 = (최종 자본 - 초기 자본) / 초기 자본 × 100
```
- **해석**: 전체 백테스팅 기간 동안의 수익률
- **목표**: 0% 이상 (양수면 수익, 음수면 손실)
- **주의**: 단일 지표만 보지 말고 리스크 지표와 함께 분석

#### 2. 승률 (Win Rate %)
```
승률 = (수익 거래 수 / 전체 거래 수) × 100
```
- **해석**: 전체 거래 중 수익을 낸 거래 비율
- **기준**:
  - 50% 이상: 양호
  - 60% 이상: 우수
  - 70% 이상: 매우 우수
- **주의**: 승률이 높아도 평균 손실이 크면 전체 수익률은 마이너스일 수 있음

#### 3. 최대 낙폭 (Maximum Drawdown, MDD %)
```
MDD = max((Peak - Trough) / Peak) × 100
```
- **해석**: 백테스팅 기간 중 최고점 대비 최대 하락폭
- **기준**:
  - 10% 이하: 안정적
  - 10~20%: 보통
  - 20% 이상: 고위험
- **중요**: **투자자의 심리적 한계를 나타내는 핵심 지표**

#### 4. Sharpe Ratio
```
Sharpe Ratio = (평균 수익률) / (수익률의 표준편차)
```
- **해석**: 위험 대비 수익률 (높을수록 좋음)
- **기준**:
  - 1 이상: 양호
  - 2 이상: 우수
  - 3 이상: 매우 우수
- **의미**: "같은 수익률이라면 변동성이 낮은 전략이 더 우수"

#### 5. 손익비 (Win/Loss Ratio)
```
손익비 = (평균 수익) / (평균 손실)
```
- **해석**: 수익 거래의 평균 대비 손실 거래의 평균 비율
- **기준**:
  - 1.5 이상: 양호
  - 2.0 이상: 우수
- **의미**: "이기면 크게, 지면 작게" 전략의 효과성

#### 6. 평균 보유 기간 (Avg Holding Days)
```
평균 보유 기간 = Σ(각 거래의 보유 일수) / 전체 거래 수
```
- **해석**: 포지션을 평균적으로 며칠 보유했는지
- **기준**:
  - 1~3일: 단기 전략
  - 4~6일: 중기 전략
  - 7~8일: 장기 보유 (Timeout 비율 높음)

---

### 청산 유형별 분석

#### 1. 익절 (Take Profit) 비율
```
TP 비율 = (TP 청산 수 / 전체 거래 수) × 100
```
- **높음 (30% 이상)**: TP 설정이 적절, 목표 수익률 도달 빈도 높음
- **낮음 (10% 이하)**: TP 설정이 너무 높거나, 시장이 목표 수익에 미달

#### 2. 손절 (Stop Loss) 비율
```
SL 비율 = (SL 청산 수 / 전체 거래 수) × 100
```
- **높음 (30% 이상)**: AI 예측 정확도 낮음, SL 설정 재검토 필요
- **적정 (10~20%)**: 리스크 관리 작동 중
- **낮음 (5% 이하)**: SL이 거의 발동하지 않음 (좋은 신호)

#### 3. Timeout 비율
```
Timeout 비율 = (Timeout 청산 수 / 전체 거래 수) × 100
```
- **높음 (50% 이상)**: 횡보장 많음, Profit Ladder/Time-Decay 발동 적음
- **낮음 (20% 이하)**: 명확한 추세 장세, 조기 청산 빈번

#### 4. Profit Ladder 비율
```
Profit Ladder 비율 = (Profit Ladder 청산 수 / 전체 거래 수) × 100
```
- **높음**: 수익률이 5%, 10%, 20% 구간에 자주 도달 (분할 청산 효과 높음)
- **낮음**: 급등/급락 많거나 횡보장 (Profit Ladder 발동 기회 적음)

#### 5. Time-Decay 비율
```
Time-Decay 비율 = (Time-Decay 청산 수 / 전체 거래 수) × 100
```
- **높음**: 장기 보유가 많고, 점진적 청산 전략 작동 중
- **낮음**: 조기 청산 (TP/SL)이 빈번

---

### 모델 비교 분석

백테스팅 결과의 **"모델 비교" 탭**을 활용하여:

1. **평균 수익률 기준 정렬**
   - 어떤 AI 모델이 가장 안정적으로 수익을 내는지 파악
   - 예: GRU 평균 5.2%, LSTM 평균 3.8% → GRU 우세

2. **승률 기준 정렬**
   - 예측 정확도가 가장 높은 모델 파악
   - 예: XGBoost 승률 65%, RandomForest 승률 55% → XGBoost 우세

3. **MDD 기준 정렬**
   - 리스크가 가장 낮은 모델 파악
   - 예: LightGBM MDD 12%, CatBoost MDD 18% → LightGBM 더 안정적

4. **Sharpe Ratio 기준 정렬**
   - 위험 대비 수익률이 가장 좋은 모델 파악
   - **최종 모델 선택 기준으로 가장 중요**

---

### Fold 분석 (시장 체제별)

백테스팅 결과의 **"Fold 분석" 탭**을 활용하여:

#### 1. BULL (상승장)
- **기대**: 높은 수익률, 높은 TP 비율
- **주의**: 과최적화 위험 (상승장에서만 잘 작동하는 전략)

#### 2. BEAR (하락장)
- **기대**: 낮은 수익률 또는 손실, 높은 SL 비율
- **핵심**: **하락장에서도 손실을 최소화하는 모델이 우수**

#### 3. SIDEWAYS (횡보장)
- **기대**: 낮은 수익률, 높은 Timeout 비율
- **핵심**: 횡보장에서도 소폭 수익을 내는 모델이 우수

**이상적인 모델**:
- 상승장: 큰 수익
- 하락장: 작은 손실 (손실 제한)
- 횡보장: 소폭 수익 또는 보합

---

## 실전 적용 시 주의사항

### ⚠️ 절대 금지
1. **백테스팅 결과를 맹신하지 마세요**
   - 과거 성과 ≠ 미래 성과
   - 충분한 모의 거래 필수

2. **처음부터 큰 금액 투자 금지**
   - 소액으로 시작 (예: 10만원)
   - 점진적으로 금액 증가

3. **감정적 거래 금지**
   - 계획된 전략을 벗어난 즉흥적 거래
   - "이번엔 다를 거야" 사고방식

### ✅ 권장 사항
1. **지속적인 모니터링**
   - 실제 거래 결과와 백테스팅 결과 비교
   - 성능 저하 시 즉시 전략 중단

2. **정기적인 모델 재학습**
   - 시장 환경 변화에 따라 AI 모델 성능 저하
   - 3~6개월마다 재학습 권장

3. **리스크 관리 우선**
   - 최대 손실 한도 설정 (예: 총 자산의 10%)
   - MDD가 한도를 초과하면 즉시 거래 중단

---

## 결론

이 TP/SL 백테스팅 전략은:

- ✓ **Kelly Criterion** (포지션 사이징)
- ✓ **Profit Ladder** (수익률 기반 분할 청산)
- ✓ **Time-Decay** (시간 기반 분할 청산)

위 세 가지 수학적 근거를 바탕으로 설계되었습니다.

**핵심 철학**:
> "단일 청산 시점을 맞추려 하지 말고, 구간별로 점진적으로 대응하라."

**목표**:
- 상승장: 큰 수익
- 하락장: 작은 손실 (Stop Loss로 제한)
- 횡보장: 소폭 수익 또는 보합 (Time-Decay로 리스크 감소)

**최종 선택**:
- 백테스팅 결과에서 **Sharpe Ratio**가 가장 높은 모델 선택
- 단, **MDD**가 심리적 한계 이내여야 함
- 모든 시장 체제(BULL/BEAR/SIDEWAYS)에서 **일관된 성능**을 보이는 모델 우선

---

**마지막 업데이트**: 2025-12-05
**버전**: 1.0.0
**개발자**: 최기영, 박신영
