# TP/SL 백테스팅 사용 설명서

## 📋 목차
1. [시작하기](#시작하기)
2. [데이터 준비](#데이터-준비)
3. [백테스팅 실행](#백테스팅-실행)
4. [결과 분석](#결과-분석)
5. [FAQ](#faq)

---

## 🚀 시작하기

### 접속 방법
1. 웹 브라우저에서 애플리케이션 접속
2. 상단 네비게이션 바에서 **"TP/SL 백테스팅"** 클릭
3. URL: `http://localhost:8080/backtest/tp-sl`

---

## 📊 데이터 준비

백테스팅을 실행하기 전에 필요한 데이터를 모두 적재해야 합니다.

### 1단계: 데이터 상태 확인
페이지 상단의 **"데이터 준비"** 섹션에서 다음 항목을 확인하세요:
- ✅ **일봉 시세**: 완료 (2,000+ 건)
- ✅ **AI 예측값**: 완료 (10,000+ 건)
- ✅ **1분봉 데이터**: 완료 (100만+ 건)

### 2단계: 데이터 적재 (필요 시)

#### 일봉 시세 적재
- Upbit API에서 ETH 일봉 데이터를 가져옵니다
- 소요 시간: **약 1-2분**
- API: `POST /api/v1/data/init-ohlcv-all`

#### AI 예측값 적재
- 12개 AI 모델의 예측 데이터를 CSV에서 로드합니다
- 소요 시간: **약 30초**
- API: `POST /api/v1/data/init-multi-model-predictions-all`

#### 1분봉 데이터 적재 ⚠️
- **가장 중요하고 시간이 오래 걸리는 작업입니다**
- 2022-12-07 ~ 2025-10-21 기간의 1분봉 데이터
- 약 **100만 개** 데이터 (약 100MB)
- 소요 시간: **약 15-20분**
- 버튼: **"1분봉 적재"** 클릭

```
⏰ 중요: 1분봉 적재는 15-20분이 소요됩니다.
적재 중에는 다른 작업을 하지 마세요.
```

---

## ⚙️ 백테스팅 실행

### 설정 방법

#### 옵션 1: 프리셋 사용 (추천)
빠르게 시작하려면 프리셋 버튼을 클릭하세요:

1. **전체 (12모델 × Fold1-7)**
   - 모든 AI 모델에 대해 전체 백테스팅
   - 총 84개 조합 (약 10-15분 소요)
   - 가장 포괄적인 결과

2. **딥러닝 (3모델 × Fold1-7)**
   - GRU, LSTM, BiLSTM만 테스트
   - 총 21개 조합 (약 3-5분 소요)
   - 딥러닝 모델 성능 비교

3. **앙상블 (9모델 × Fold1-7)**
   - XGBoost, LightGBM 등 앙상블 모델
   - 총 63개 조합 (약 8-12분 소요)
   - 전통적 ML 모델 성능 비교

4. **GRU only (Fold1-7)**
   - GRU 모델만 테스트
   - 총 7개 조합 (약 1-2분 소요)
   - 빠른 테스트용

#### 옵션 2: 커스텀 설정
특정 모델과 Fold를 선택하려면:

1. **AI 모델 선택**
   - 12개 모델 중 원하는 모델 체크
   - 모델 종류:
     - 딥러닝: GRU, LSTM, BiLSTM
     - 그래디언트 부스팅: XGBoost, LightGBM, CatBoost, GradientBoosting, HistGradientBoosting
     - 기타: RandomForest, AdaBoost, LogisticRegression, StackingEnsemble

2. **Fold 선택**
   - Fold 1~7 중 원하는 구간 체크
   - 각 Fold는 다른 시장 체제를 나타냅니다:
     - Fold 1-2: 하락장 (BEAR)
     - Fold 3-4: 횡보장 (SIDEWAYS)
     - Fold 5-7: 상승장 (BULL)

3. **파라미터 설정**
   - **초기 자본**: 10,000원 (기본값)
   - **pred_proba_up 임계값**: 0.6 (기본값, 0.0~1.0)
     - 높을수록: 진입 횟수 감소, 신뢰도 높은 거래만
     - 낮을수록: 진입 횟수 증가, 더 공격적
   - **보유 기간**: 8일 (기본값)
     - 8일 동안 1분봉 추적하여 TP/SL 체크

### 실행하기

1. 설정이 완료되면 **"배치 백테스팅 실행"** 버튼 클릭
2. 진행 상황 섹션이 자동으로 나타남
3. 실시간으로 진행 상황 확인:
   - 전체 진행률 프로그레스바
   - 모델별 카드 상태 (대기 중 → 완료)
   - 실시간 로그 메시지

```
💡 팁: 비동기 처리로 브라우저를 닫아도 백그라운드에서 계속 실행됩니다.
진행 상황은 2초마다 자동으로 업데이트됩니다.
```

---

## 📈 결과 분석

백테스팅이 완료되면 4개의 탭으로 결과를 확인할 수 있습니다.

### 1. 전체 요약 탭
전체 백테스팅 결과를 한눈에 확인:
- **평균 수익률**: 모든 조합의 평균 수익률
- **최고 수익률**: 가장 성과가 좋았던 조합
- **최저 수익률**: 가장 성과가 나빴던 조합
- **총 거래 수**: 전체 거래 횟수
- **평균 승률**: 수익을 낸 거래 비율
- **테스트 조합 수**: 실행된 총 조합 수

### 2. 모델 비교 탭
각 AI 모델별 성능 비교:
- 모델별 평균/최대/최소 수익률
- 모델별 평균 승률
- 모델별 총 거래 수

```
💡 활용: 어떤 AI 모델이 가장 안정적인 수익을 내는지 파악
```

### 3. Fold 분석 탭
각 Fold(시장 구간)별 성능 분석:
- Fold별 시장 체제 (BULL/BEAR/SIDEWAYS)
- Fold별 평균/최대/최소 수익률
- Fold별 평균 승률
- Fold별 총 거래 수

```
💡 활용: 어떤 시장 상황에서 전략이 잘 작동하는지 파악
예: 상승장에서는 좋지만 하락장에서는 손실
```

### 4. 상세 내역 탭
모든 백테스팅 결과를 상세 테이블로 확인:
- 모델명, Fold, 시장 체제
- 수익률, 거래 수
- 익절/손절/시간만료 횟수
- 승률, MDD, Sharpe Ratio

정렬 가능하여 원하는 기준으로 결과를 정렬할 수 있습니다.

---

## ❓ FAQ

### Q1: 백테스팅이 너무 오래 걸려요
**A:** 정상입니다. 전체 84개 조합은 10-15분이 소요됩니다.
- 해결책 1: 프리셋 "GRU only"로 빠른 테스트 (1-2분)
- 해결책 2: 특정 모델과 Fold만 선택하여 실행
- 해결책 3: 브라우저를 닫고 나중에 다시 확인 (비동기 처리)

### Q2: 1분봉 적재가 실패해요
**A:** 다음을 확인하세요:
- 인터넷 연결 상태
- Upbit API 서버 상태
- DB 저장 공간 (약 100MB 필요)
- 로그 확인: `application.log`

### Q3: 결과가 0건이에요
**A:** 데이터 적재 상태를 확인하세요:
1. AI 예측 데이터가 적재되었는지 확인
2. 1분봉 데이터가 적재되었는지 확인
3. 선택한 모델과 Fold에 데이터가 있는지 확인

### Q4: 수익률이 마이너스인데 정상인가요?
**A:** 네, 정상입니다. 백테스팅 결과는:
- 모델과 Fold에 따라 다름
- 시장 상황에 따라 다름
- TP/SL 전략이 모든 상황에서 수익을 보장하지 않음
- 여러 조합을 비교하여 가장 안정적인 전략을 찾는 것이 목적

### Q5: 실제 거래에 바로 적용해도 되나요?
**A:** ❌ **절대 금지!**
- 백테스팅 결과는 **과거 데이터 기반**입니다
- 실제 시장은 수수료, 슬리피지, 유동성 등 추가 변수가 있습니다
- **충분한 모의 거래** 후 소액으로 테스트하세요
- 투자 손실에 대한 책임은 본인에게 있습니다

### Q6: 백테스팅 중에 에러가 발생했어요
**A:** 다음을 확인하세요:
1. 브라우저 콘솔 (F12) 에러 메시지 확인
2. 서버 로그 확인
3. 데이터베이스 연결 상태 확인
4. 페이지 새로고침 후 재시도

---

## 🛠️ 기술 사양

### 백테스팅 전략
- **진입 조건**: pred_proba_up ≥ 0.6 (기본값)
- **진입 시각**: 예측일 오전 9:00 첫 1분봉 시가
- **포지션 사이징**: Kelly Criterion × Confidence
  - 공식: `((R × W - (1-W)) / R) × confidence`
  - R: Risk-Reward Ratio = (TP - entry) / (entry - SL)
  - W: Win Probability = pred_proba_up
- **보유 기간**: 8일 (11,520개 1분봉)
- **출구 전략**:
  1. **익절 (TP)**: 고가가 take_profit_price 이상
  2. **손절 (SL)**: 저가가 stop_loss_price 이하
  3. **시간만료**: 8일 경과 시 종가로 매도
- **수수료**: 0.1% (왕복, 편도 0.05%)

### 성능 지표
- **수익률 (Return)**: (최종 자본 - 초기 자본) / 초기 자본 × 100
- **승률 (Win Rate)**: 수익 거래 / 전체 거래 × 100
- **MDD (Maximum Drawdown)**: 최대 낙폭
- **Sharpe Ratio**: 위험 대비 수익률
- **평균 보유 기간**: 거래별 평균 보유 일수

---

## 📞 문의

문제가 발생하거나 추가 기능이 필요하면:
- GitHub Issues: [프로젝트 레포지토리]
- 개발자: 최기영, 박신영

---

**마지막 업데이트**: 2025-12-02
**버전**: 1.0.0
