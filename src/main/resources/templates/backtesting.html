<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>백테스팅</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-main: #FFFFFF;
            --text-main: #313647;
            --nav-bg: #313647;
            --accent-dark: #435663;
            --accent-green: #A3B087;
        }
        body { background-color: var(--bg-main); color: var(--text-main); font-family: 'Segoe UI', sans-serif; }

        /* Navbar 수정됨 */
        .navbar { background-color: var(--nav-bg) !important; padding: 1rem 0; }
        .navbar-brand { color: #FFFFFF !important; font-weight: 800; }
        .navbar .nav-link { color: rgba(255,255,255,0.6) !important; padding: 0.5rem 1rem; margin: 0 0.2rem; transition: all 0.3s; }
        .navbar .nav-link:hover { color: #FFFFFF !important; }
        .navbar .nav-link.active { background-color: var(--accent-green); color: #FFFFFF !important; font-weight: 700; border-radius: 8px; }

        .card { border: 1px solid #e0e0e0; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); background: #FFFFFF; margin-bottom: 20px; }
        .card-header { background-color: var(--accent-dark); color: #FFFFFF; border-radius: 12px 12px 0 0 !important; font-weight: 600; padding: 1rem 1.5rem; }

        .btn-primary { background-color: var(--text-main); border: none; }
        .btn-success { background-color: var(--accent-green); border: none; }

        /* Tabs Customization */
        .nav-tabs .nav-link {
            color: rgba(49, 54, 71, 0.5) !important;
            font-weight: 600;
            border: none;
        }
        .nav-tabs .nav-link:hover {
            color: var(--text-main) !important;
        }
        .nav-tabs .nav-link.active {
            color: var(--text-main) !important;
            border-bottom: 3px solid var(--accent-green);
            font-weight: 800;
            background: transparent;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark sticky-top">
    <div class="container">
        <a class="navbar-brand" href="/trading/dashboard"><i class="fas fa-chart-line me-2"></i>AI Engine</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"><span class="navbar-toggler-icon"></span></button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link" href="/trading/dashboard">대시보드</a></li>
                <li class="nav-item"><a class="nav-link" href="/trading/history">거래내역</a></li>
                <li class="nav-item"><a class="nav-link" href="/trading/mypage">마이페이지</a></li>
                <li class="nav-item"><a class="nav-link active" href="/backtest">백테스팅</a></li>
            </ul>
        </div>
    </div>
</nav>

<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1100; margin-top: 60px;">
    <div id="dataToast" class="toast" role="alert">
        <div class="toast-header">
            <i id="toastIcon" class="fas fa-info-circle me-2"></i>
            <strong class="me-auto" id="toastTitle">알림</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="toastMessage"></div>
    </div>
</div>

<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-database me-2"></i>데이터 준비</span>
                    <a href="/predictions" class="btn btn-sm btn-outline-light">적재 데이터 확인 ></a>
                </div>
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <p class="mb-2">OHLCV 시세: <span id="ohlcvStatus" class="badge bg-secondary">확인 중</span> <span id="ohlcvCount" class="small text-muted"></span></p>
                            <p class="mb-0">AI 예측값: <span id="aiStatus" class="badge bg-secondary">확인 중</span> <span id="aiCount" class="small text-muted"></span></p>
                        </div>
                        <div class="col-md-6 text-end">
                            <button class="btn btn-primary btn-sm me-2" onclick="loadOhlcvData()" id="btnOhlcv"><i class="fas fa-download me-1"></i> 시세 적재</button>
                            <button class="btn btn-success btn-sm" onclick="loadMultiModelData()" id="btnMultiModel"><i class="fas fa-brain me-1"></i> AI 적재</button>
                        </div>
                    </div>
                </div>
            </div>

            <ul class="nav nav-tabs mb-4" id="backtestTabs" role="tablist">
                <li class="nav-item"><button class="nav-link active" id="single-tab" data-bs-toggle="tab" data-bs-target="#single">단일 구간 (Fold)</button></li>
                <li class="nav-item"><button class="nav-link" id="sequential-tab" data-bs-toggle="tab" data-bs-target="#sequential">연속 백테스팅</button></li>
            </ul>

            <div class="tab-content">
                <div class="tab-pane fade show active" id="single">
                    <div class="card">
                        <div class="card-body p-4">
                            <h5 class="card-title mb-4 fw-bold text-dark">단일 구간 시뮬레이션</h5>
                            <form action="/backtest/result" method="get">
                                <div class="row g-3 mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label">기간 선택 (Fold)</label>
                                        <select class="form-select" name="foldNumber" required>
                                            <option value="" disabled selected>선택...</option>
                                            <option th:each="fold : ${folds}" th:value="${fold.foldNumber}" th:text="${'Fold ' + fold.foldNumber + ' (' + fold.regime + ')'}"></option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">초기 자본 (KRW)</label>
                                        <input type="number" class="form-control" name="initialCapital" value="10000" step="1000">
                                    </div>
                                </div>
                                <div class="row g-3 mb-4">
                                    <div class="col-md-6">
                                        <label class="form-label">진입 임계값 (0.0 ~ 0.5)</label>
                                        <input type="number" class="form-control" name="confidenceThreshold" value="0.1" step="0.01">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">포지션 비율 (%, 비우면 Kelly)</label>
                                        <input type="number" class="form-control" name="positionSizePercent" placeholder="자동 계산">
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary w-100 py-2 fw-bold">시뮬레이션 실행</button>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="sequential">
                    <div class="card">
                        <div class="card-body p-4">
                            <h5 class="card-title mb-4 fw-bold text-dark">연속 구간 복리 테스트</h5>
                            <form action="/backtest/sequential-result" method="get">
                                <div class="row g-3 mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label">시작 Fold</label>
                                        <select class="form-select" name="startFold">
                                            <option value="1" selected>Fold 1</option>
                                            <option th:each="i : ${#numbers.sequence(2,7)}" th:value="${i}" th:text="${'Fold ' + i}"></option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">종료 Fold</label>
                                        <select class="form-select" name="endFold">
                                            <option th:each="i : ${#numbers.sequence(1,7)}" th:value="${i}" th:text="${'Fold ' + i}" th:selected="${i==7}"></option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row g-3 mb-4">
                                    <div class="col-md-6">
                                        <label class="form-label">초기 자본</label>
                                        <input type="number" class="form-control" name="initialCapital" value="10000" step="1000">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">진입 임계값</label>
                                        <input type="number" class="form-control" name="confidenceThreshold" value="0.1" step="0.01">
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary w-100 py-2 fw-bold">연속 테스트 실행</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', checkDataStatus);

    function checkDataStatus() {
        fetch('/api/v1/data/status').then(r=>r.json()).then(d => {
            const ob = document.getElementById('ohlcvStatus');
            const ab = document.getElementById('aiStatus');
            const btnOh = document.getElementById('btnOhlcv');
            const btnAi = document.getElementById('btnMultiModel');

            if(d.ohlcvLoaded) {
                ob.textContent='완료';
                ob.className='badge bg-success';
                document.getElementById('ohlcvCount').textContent=`(${d.ohlcvCount}건)`;
                btnOh.disabled=true;
                btnOh.innerHTML='<i class="fas fa-check me-1"></i> 적재 완료';
            } else {
                btnOh.disabled=false;
                btnOh.innerHTML='<i class="fas fa-download me-1"></i> 시세 적재';
            }

            if(d.aiPredictionsLoaded) {
                ab.textContent='완료';
                ab.className='badge bg-success';
                document.getElementById('aiCount').textContent=`(${d.aiPredictionCount}건)`;
                btnAi.disabled=true;
                btnAi.innerHTML='<i class="fas fa-check me-1"></i> 적재 완료';
            } else {
                btnAi.disabled=false;
                btnAi.innerHTML='<i class="fas fa-brain me-1"></i> AI 적재';
            }
        });
    }

    function showToast(msg, isSuccess = true) {
        const t = document.getElementById('dataToast');
        document.getElementById('toastMessage').textContent = msg;
        const icon = document.getElementById('toastIcon');
        if (isSuccess) {
            icon.className = "fas fa-check-circle me-2 text-success";
            document.getElementById('toastTitle').innerText = "완료";
        } else {
            icon.className = "fas fa-exclamation-circle me-2 text-danger";
            document.getElementById('toastTitle').innerText = "오류";
        }
        new bootstrap.Toast(t, { delay: 3000 }).show();
    }

    function loadOhlcvData() {
        const btn = document.getElementById('btnOhlcv');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 적재 중...';
        fetch('/api/v1/data/init-ohlcv-all', {method:'POST'})
        .then(r=>r.text())
        .then(m=>{
            showToast(m, true);
            checkDataStatus();
        })
        .catch(e => {
            console.error(e);
            showToast('데이터 적재 중 오류가 발생했습니다.', false);
            checkDataStatus();
        });
    }

    function loadMultiModelData() {
        const btn = document.getElementById('btnMultiModel');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 적재 중...';
        fetch('/api/v1/data/init-multi-model-predictions-all', {method:'POST'})
        .then(r=>r.text())
        .then(m=>{
            showToast(m, true);
            checkDataStatus();
        })
        .catch(e => {
            console.error(e);
            showToast('데이터 적재 중 오류가 발생했습니다.', false);
            checkDataStatus();
        });
    }
</script>
</body>
</html>