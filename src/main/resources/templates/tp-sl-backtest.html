<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>TP/SL 백테스팅</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        :root {
            --bg-main: #FFFFFF;
            --text-main: #313647;
            --nav-bg: #313647;
            --accent-dark: #435663;
            --accent-green: #A3B087;
            --accent-blue: #6C91BF;
            --accent-red: #E07856;
        }
        body { background-color: var(--bg-main); color: var(--text-main); font-family: 'Segoe UI', sans-serif; }

        /* Navbar */
        .navbar { background-color: var(--nav-bg) !important; padding: 1rem 0; }
        .navbar-brand { color: #FFFFFF !important; font-weight: 800; }
        .navbar .nav-link { color: rgba(255,255,255,0.6) !important; padding: 0.5rem 1rem; margin: 0 0.2rem; transition: all 0.3s; }
        .navbar .nav-link:hover { color: #FFFFFF !important; }
        .navbar .nav-link.active { background-color: var(--accent-green); color: #FFFFFF !important; font-weight: 700; border-radius: 8px; }

        .card { border: 1px solid #e0e0e0; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); background: #FFFFFF; margin-bottom: 20px; }
        .card-header { background-color: var(--accent-dark); color: #FFFFFF; border-radius: 12px 12px 0 0 !important; font-weight: 600; padding: 1rem 1.5rem; }

        .btn-primary { background-color: var(--text-main); border: none; }
        .btn-success { background-color: var(--accent-green); border: none; }
        .btn-info { background-color: var(--accent-blue); border: none; }
        .btn-danger { background-color: var(--accent-red); border: none; }

        /* Preset buttons */
        .preset-btn { min-width: 150px; margin: 0.5rem; padding: 0.75rem 1.5rem; font-weight: 600; }

        /* Progress section */
        #progressSection { display: none; }
        .progress-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; margin-top: 20px; }
        .model-progress-card { border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; background: #f8f9fa; }
        .model-progress-card.completed { background: #d4edda; border-color: #28a745; }
        .model-progress-card.running { background: #fff3cd; border-color: #ffc107; }
        .model-progress-card.pending { background: #f8f9fa; border-color: #e0e0e0; }

        /* Results section */
        #resultsSection { display: none; }

        /* Tabs */
        .nav-tabs .nav-link {
            color: rgba(49, 54, 71, 0.5) !important;
            font-weight: 600;
            border: none;
        }
        .nav-tabs .nav-link:hover {
            color: var(--text-main) !important;
        }
        .nav-tabs .nav-link.active {
            color: var(--text-main) !important;
            border-bottom: 3px solid var(--accent-green);
            font-weight: 800;
            background: transparent;
        }

        /* Result tables */
        .result-table { font-size: 0.95rem; }
        .result-table th { background-color: var(--accent-dark); color: #FFFFFF; font-weight: 600; }
        .result-table th[onclick] { user-select: none; transition: background-color 0.2s; }
        .result-table th[onclick]:hover { background-color: var(--accent-green); }
        .result-table td { vertical-align: middle; }

        /* Badges */
        .badge-win { background-color: #28a745; }
        .badge-loss { background-color: #dc3545; }
        .badge-neutral { background-color: #6c757d; }

        /* Loading spinner */
        .spinner-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999; display: none; justify-content: center; align-items: center; }
        .spinner-overlay.active { display: flex; }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark sticky-top">
    <div class="container">
        <a class="navbar-brand" href="/trading/dashboard"><i class="fas fa-chart-line me-2"></i>AI Engine</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"><span class="navbar-toggler-icon"></span></button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link" href="/trading/dashboard">대시보드</a></li>
                <li class="nav-item"><a class="nav-link" href="/trading/history">거래내역</a></li>
                <li class="nav-item"><a class="nav-link" href="/trading/mypage">마이페이지</a></li>
                <li class="nav-item"><a class="nav-link active" href="/backtest/tp-sl">백테스팅</a></li>
            </ul>
        </div>
    </div>
</nav>

<!-- Toast notification -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1100; margin-top: 60px;">
    <div id="dataToast" class="toast" role="alert">
        <div class="toast-header">
            <i id="toastIcon" class="fas fa-info-circle me-2"></i>
            <strong class="me-auto" id="toastTitle">알림</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="toastMessage"></div>
    </div>
</div>

<!-- Loading spinner -->
<div class="spinner-overlay" id="spinnerOverlay">
    <div class="text-center text-white">
        <div class="spinner-border" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3 fs-5" id="spinnerMessage">처리 중...</p>
    </div>
</div>

<div class="container py-4">
    <!-- Data Preparation Section -->
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-database me-2"></i>데이터 준비 (TP/SL 전략)</span>
                </div>
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <p class="mb-2">AI 예측값: <span id="aiStatus" class="badge bg-secondary">확인 중</span> <span id="aiCount" class="small text-muted"></span></p>
                            <p class="mb-0">1분봉 데이터: <span id="minuteStatus" class="badge bg-secondary">확인 중</span> <span id="minuteCount" class="small text-muted"></span></p>
                        </div>
                        <div class="col-md-4 text-end">
                            <button class="btn btn-warning btn-sm me-2 mb-2" onclick="loadAiPredictions()" id="btnAi">
                                <i class="fas fa-brain me-1"></i> AI 예측값 적재
                            </button>
                            <button class="btn btn-primary btn-sm mb-2" onclick="loadMinuteCandles()" id="btnMinute">
                                <i class="fas fa-download me-1"></i> 1분봉 적재
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CUSUM 신호 기반 백테스팅 (별도 카드) -->
            <div class="card" style="border: 2px solid #A3B087;">
                <div class="card-header" style="background-color: #A3B087; color: #FFFFFF;">
                    <i class="fas fa-filter me-2"></i>CUSUM 신호 기반 백테스팅 (Triple Barrier Method)
                </div>
                <div class="card-body p-4">
                    <div class="row align-items-center mb-3">
                        <div class="col-md-8">
                            <p class="mb-1"><strong>새로운 ML 파이프라인:</strong> CUSUM 필터 → Triple Barrier 라벨링 → AI 검증</p>
                            <p class="mb-0">CUSUM 데이터: <span id="cusumStatus" class="badge bg-secondary">확인 중</span> <span id="cusumCount" class="small text-muted"></span></p>
                        </div>
                        <div class="col-md-4 text-end">
                            <button class="btn btn-success btn-sm" onclick="loadCusumData()" id="btnCusum">
                                <i class="fas fa-download me-1"></i> CUSUM 데이터 로드
                            </button>
                        </div>
                    </div>
                    <div class="row g-3 mb-3" id="cusumOptions" style="display: none;">
                        <div class="col-md-3">
                            <label class="form-label fw-bold">전략 선택</label>
                            <select class="form-select" id="cusumStrategy">
                                <option value="">전체 전략</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold">모델 선택</label>
                            <select class="form-select" id="cusumModel">
                                <option value="">전체 모델</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold">Fold 선택</label>
                            <select class="form-select" id="cusumFold">
                                <option value="">전체 Fold</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold">초기 자본 (KRW)</label>
                            <input type="number" class="form-control" id="cusumInitialCapital" value="10000000" step="1000000">
                        </div>
                    </div>
                    <button type="button" class="btn btn-success w-100 py-3 fw-bold fs-5" onclick="runCusumBacktest()" id="btnCusumRun" style="display: none;">
                        <i class="fas fa-play me-2"></i>CUSUM 백테스팅 실행
                    </button>
                </div>
            </div>

            <!-- 이전 백테스팅 설정 (Legacy) -->
            <div class="card">
                <div class="card-header" style="background-color: #6c757d; color: #FFFFFF;">
                    <i class="fas fa-history me-2"></i>이전 백테스팅 설정 (AI 예측 기반)
                </div>
                <div class="card-body p-4">
                    <div class="alert alert-secondary mb-3">
                        <i class="fas fa-info-circle me-2"></i>
                        기존 AI 예측값과 1분봉 데이터를 사용하는 레거시 백테스팅입니다. 새로운 CUSUM 기반 백테스팅 사용을 권장합니다.
                    </div>

                    <h6 class="fw-bold mb-3">프리셋 선택</h6>
                    <div class="d-flex flex-wrap justify-content-center mb-4">
                        <button class="btn btn-secondary preset-btn" onclick="setPreset('all')">
                            <i class="fas fa-globe me-2"></i>전체 (12모델 × Fold1-7)
                        </button>
                        <button class="btn btn-secondary preset-btn" onclick="setPreset('deeplearning')">
                            <i class="fas fa-brain me-2"></i>딥러닝 (3모델 × Fold1-7)
                        </button>
                        <button class="btn btn-secondary preset-btn" onclick="setPreset('ensemble')">
                            <i class="fas fa-layer-group me-2"></i>앙상블 (9모델 × Fold1-7)
                        </button>
                        <button class="btn btn-secondary preset-btn" onclick="setPreset('gru')">
                            <i class="fas fa-robot me-2"></i>GRU only (Fold1-7)
                        </button>
                    </div>

                    <h6 class="fw-bold mb-3">커스텀 설정</h6>
                    <div class="row g-3 mb-3">
                        <div class="col-md-12">
                            <label class="form-label fw-bold">AI 모델 선택</label>
                            <div class="row g-2">
                                <div class="col-md-3"><input type="checkbox" class="form-check-input me-2" value="GRU" id="model_GRU"><label for="model_GRU">GRU</label></div>
                                <div class="col-md-3"><input type="checkbox" class="form-check-input me-2" value="LSTM" id="model_LSTM"><label for="model_LSTM">LSTM</label></div>
                                <div class="col-md-3"><input type="checkbox" class="form-check-input me-2" value="BiLSTM" id="model_BiLSTM"><label for="model_BiLSTM">BiLSTM</label></div>
                                <div class="col-md-3"><input type="checkbox" class="form-check-input me-2" value="XGBoost" id="model_XGBoost"><label for="model_XGBoost">XGBoost</label></div>
                                <div class="col-md-3"><input type="checkbox" class="form-check-input me-2" value="LightGBM" id="model_LightGBM"><label for="model_LightGBM">LightGBM</label></div>
                                <div class="col-md-3"><input type="checkbox" class="form-check-input me-2" value="CatBoost" id="model_CatBoost"><label for="model_CatBoost">CatBoost</label></div>
                                <div class="col-md-3"><input type="checkbox" class="form-check-input me-2" value="RandomForest" id="model_RandomForest"><label for="model_RandomForest">RandomForest</label></div>
                                <div class="col-md-3"><input type="checkbox" class="form-check-input me-2" value="AdaBoost" id="model_AdaBoost"><label for="model_AdaBoost">AdaBoost</label></div>
                                <div class="col-md-3"><input type="checkbox" class="form-check-input me-2" value="GradientBoosting" id="model_GradientBoosting"><label for="model_GradientBoosting">GradientBoosting</label></div>
                                <div class="col-md-3"><input type="checkbox" class="form-check-input me-2" value="HistGradientBoosting" id="model_HistGradientBoosting"><label for="model_HistGradientBoosting">HistGradientBoosting</label></div>
                                <div class="col-md-3"><input type="checkbox" class="form-check-input me-2" value="LogisticRegression" id="model_LogisticRegression"><label for="model_LogisticRegression">LogisticRegression</label></div>
                                <div class="col-md-3"><input type="checkbox" class="form-check-input me-2" value="StackingEnsemble" id="model_StackingEnsemble"><label for="model_StackingEnsemble">StackingEnsemble</label></div>
                            </div>
                        </div>
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-md-12">
                            <label class="form-label fw-bold">Fold 선택</label>
                            <div class="row g-2">
                                <div class="col-md-2"><input type="checkbox" class="form-check-input me-2" value="1" id="fold_1"><label for="fold_1">Fold 1</label></div>
                                <div class="col-md-2"><input type="checkbox" class="form-check-input me-2" value="2" id="fold_2"><label for="fold_2">Fold 2</label></div>
                                <div class="col-md-2"><input type="checkbox" class="form-check-input me-2" value="3" id="fold_3"><label for="fold_3">Fold 3</label></div>
                                <div class="col-md-2"><input type="checkbox" class="form-check-input me-2" value="4" id="fold_4"><label for="fold_4">Fold 4</label></div>
                                <div class="col-md-2"><input type="checkbox" class="form-check-input me-2" value="5" id="fold_5"><label for="fold_5">Fold 5</label></div>
                                <div class="col-md-2"><input type="checkbox" class="form-check-input me-2" value="6" id="fold_6"><label for="fold_6">Fold 6</label></div>
                                <div class="col-md-2"><input type="checkbox" class="form-check-input me-2" value="7" id="fold_7"><label for="fold_7">Fold 7</label></div>
                            </div>
                        </div>
                    </div>

                    <div class="row g-3 mb-4">
                        <div class="col-md-4">
                            <label class="form-label fw-bold">초기 자본 (KRW)</label>
                            <input type="number" class="form-control" id="initialCapital" value="10000" step="1000">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">pred_proba_up 임계값</label>
                            <input type="number" class="form-control" id="predProbaThreshold" value="0.6" step="0.01" min="0" max="1">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">보유 기간 (일)</label>
                            <input type="number" class="form-control" id="holdingPeriodDays" value="8" step="1" min="1">
                        </div>
                    </div>

                    <button type="button" class="btn btn-secondary w-100 py-3 fw-bold fs-5" onclick="runBatchBacktest()">
                        <i class="fas fa-play me-2"></i>이전 방식 백테스팅 실행
                    </button>
                </div>
            </div>

            <!-- Progress Section -->
            <div class="card" id="progressSection">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-tasks me-2"></i>진행 상황</span>
                    <span id="overallProgress" class="badge bg-info">0 / 0 완료</span>
                </div>
                <div class="card-body">
                    <div class="progress mb-3" style="height: 30px;">
                        <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-success"
                             role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                    </div>
                    <div id="progressGrid" class="progress-grid"></div>
                    <div id="progressLogs" class="mt-3 p-3 bg-light rounded" style="max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 0.85rem;"></div>
                </div>
            </div>

            <!-- Results Section -->
            <div class="card" id="resultsSection">
                <div class="card-header">
                    <i class="fas fa-chart-bar me-2"></i>백테스팅 결과
                </div>
                <div class="card-body">
                    <ul class="nav nav-tabs mb-4" id="resultTabs" role="tablist">
                        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabModels">모델 비교</button></li>
                        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabCapitalTracking">자본 변화 추적</button></li>
                        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabDetails">상세 내역</button></li>
                        <li class="nav-item" id="cusumTabItem" style="display: none;"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabCusumAnalysis"><i class="fas fa-filter me-1"></i>CUSUM 분석</button></li>
                    </ul>

                    <div class="tab-content">
                        <!-- Model Comparison Tab -->
                        <div class="tab-pane fade show active" id="tabModels">
                            <div id="modelContent"></div>
                        </div>

                        <!-- Capital Tracking Tab -->
                        <div class="tab-pane fade" id="tabCapitalTracking">
                            <!-- 기본 필터 -->
                            <div class="row mb-3">
                                <div class="col-md-3">
                                    <label class="form-label fw-bold">모델 선택</label>
                                    <select class="form-select" id="chartModelFilter" onchange="updateCapitalChart()">
                                        <option value="">전체 모델</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-bold">Fold 선택</label>
                                    <select class="form-select" id="chartFoldFilter" onchange="updateCapitalChart()">
                                        <option value="">전체 Fold</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-bold">체제 필터</label>
                                    <select class="form-select" id="chartRegimeFilter" onchange="updateCapitalChart()">
                                        <option value="">전체</option>
                                        <option value="CUSUM">CUSUM만</option>
                                        <option value="NON_CUSUM">기존 백테스팅만</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-bold">최대 표시 개수</label>
                                    <select class="form-select" id="chartMaxLines" onchange="updateCapitalChart()">
                                        <option value="5">상위 5개</option>
                                        <option value="10" selected>상위 10개</option>
                                        <option value="20">상위 20개</option>
                                        <option value="0">전체 (주의)</option>
                                    </select>
                                </div>
                            </div>

                            <!-- CUSUM 전용 필터 (CUSUM 결과가 있을 때만 표시) -->
                            <div class="row mb-3" id="cusumChartFilters" style="display: none;">
                                <div class="col-md-4">
                                    <label class="form-label fw-bold"><i class="fas fa-chess-knight me-1"></i>CUSUM 전략</label>
                                    <select class="form-select" id="chartCusumStrategy" onchange="updateCapitalChart()">
                                        <option value="">전체 전략</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold"><i class="fas fa-robot me-1"></i>CUSUM ML 모델</label>
                                    <select class="form-select" id="chartCusumMlModel" onchange="updateCapitalChart()">
                                        <option value="">전체 ML 모델</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold"><i class="fas fa-clock me-1"></i>타임프레임</label>
                                    <select class="form-select" id="chartCusumTimeframe" onchange="updateCapitalChart()">
                                        <option value="">전체</option>
                                        <option value="4h">4시간</option>
                                        <option value="12h">12시간</option>
                                        <option value="24h">24시간</option>
                                        <option value="48h">48시간</option>
                                    </select>
                                </div>
                            </div>

                            <!-- 경고 메시지 -->
                            <div class="alert alert-warning mb-3" id="chartWarning" style="display: none;">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <span id="chartWarningMessage"></span>
                            </div>

                            <!-- 차트 옵션 -->
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div>
                                    <span class="text-muted" id="chartResultCount">0개 결과 표시 중</span>
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="chartShowLegend" checked onchange="updateCapitalChart()">
                                    <label class="form-check-label" for="chartShowLegend">레전드 표시</label>
                                </div>
                            </div>

                            <div style="position: relative; height: 500px;">
                                <canvas id="capitalChart"></canvas>
                            </div>
                        </div>

                        <!-- Details Tab -->
                        <div class="tab-pane fade" id="tabDetails">
                            <div id="detailsContent"></div>
                        </div>

                        <!-- CUSUM Analysis Tab -->
                        <div class="tab-pane fade" id="tabCusumAnalysis">
                            <div id="cusumAnalysisContent"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Exit Details Modal -->
<div class="modal fade" id="exitDetailsModal" tabindex="-1" aria-labelledby="exitDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header" style="background-color: var(--accent-dark); color: #FFFFFF;">
                <h5 class="modal-title" id="exitDetailsModalLabel"><i class="fas fa-chart-line me-2"></i>분할 청산 상세 내역</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Trade Summary -->
                <div class="row g-3 mb-4">
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h6 class="text-muted">모델</h6>
                                <h5 id="modalModelName">-</h5>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h6 class="text-muted">Fold</h6>
                                <h5 id="modalFold">-</h5>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h6 class="text-muted">총 거래 수</h6>
                                <h5 id="modalTotalTrades">-</h5>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h6 class="text-muted">수익률</h6>
                                <h5 id="modalReturn">-</h5>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Trade History with Exit Events -->
                <h6 class="fw-bold mb-3">거래 내역 및 분할 청산</h6>
                <div id="modalTradeHistory" style="max-height: 500px; overflow-y: auto;"></div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const ALL_MODELS = ['GRU', 'LSTM', 'BiLSTM', 'XGBoost', 'LightGBM', 'CatBoost',
                       'RandomForest', 'AdaBoost', 'GradientBoosting', 'HistGradientBoosting',
                       'LogisticRegression', 'StackingEnsemble'];
    const DEEPLEARNING_MODELS = ['GRU', 'LSTM', 'BiLSTM'];
    const ENSEMBLE_MODELS = ['XGBoost', 'LightGBM', 'CatBoost', 'RandomForest', 'AdaBoost',
                            'GradientBoosting', 'HistGradientBoosting', 'LogisticRegression', 'StackingEnsemble'];

    let backtestResults = [];
    let capitalChart = null;

    // Sorting state for details table
    let sortColumn = 'sharpeRatio';
    let sortDirection = 'desc';

    // Filter state
    let filterReturnMin = -Infinity;
    let filterReturnMax = Infinity;
    let filterMddMin = -Infinity;
    let filterMddMax = Infinity;
    let filterSharpeMin = -Infinity;
    let filterSharpeMax = Infinity;
    let filterFold = null; // Fold 필터 (null = 전체)

    // CUSUM 관련 변수
    let cusumDataLoaded = false;
    let cusumStrategies = [];
    let cusumModels = [];
    let cusumFolds = [];
    let isCusumMode = false; // CUSUM 백테스팅 결과인지 여부

    document.addEventListener('DOMContentLoaded', function() {
        checkDataStatus();
        checkCusumStatus();
    });

    function checkDataStatus() {
        fetch('/api/v1/data/status').then(r=>r.json()).then(d => {
            // AI Predictions
            const aiPredBadge = document.getElementById('aiStatus');
            if(d.aiPredictionsLoaded) {
                aiPredBadge.textContent='완료';
                aiPredBadge.className='badge bg-success';
                document.getElementById('aiCount').textContent=`(${d.aiPredictionCount}건)`;
                document.getElementById('btnAi').disabled=true;
                document.getElementById('btnAi').innerHTML='<i class="fas fa-check me-1"></i> 적재 완료';
            } else {
                aiPredBadge.textContent='미적재';
                aiPredBadge.className='badge bg-danger';
            }
        }).catch(e => console.error(e));

        // Minute candles (separate endpoint)
        fetch('/api/v1/data/minute-candles/stats').then(r=>r.text()).then(stats => {
            const minBadge = document.getElementById('minuteStatus');
            if (stats.includes('없음')) {
                minBadge.textContent='미적재';
                minBadge.className='badge bg-danger';
            } else {
                minBadge.textContent='완료';
                minBadge.className='badge bg-success';
                document.getElementById('minuteCount').textContent=`(${stats})`;
                document.getElementById('btnMinute').disabled=true;
                document.getElementById('btnMinute').innerHTML='<i class="fas fa-check me-1"></i> 적재 완료';
            }
        }).catch(e => console.error(e));
    }

    function showToast(msg, isSuccess = true) {
        const t = document.getElementById('dataToast');
        document.getElementById('toastMessage').textContent = msg;
        const icon = document.getElementById('toastIcon');
        if (isSuccess) {
            icon.className = "fas fa-check-circle me-2 text-success";
            document.getElementById('toastTitle').innerText = "완료";
        } else {
            icon.className = "fas fa-exclamation-circle me-2 text-danger";
            document.getElementById('toastTitle').innerText = "오류";
        }
        new bootstrap.Toast(t, { delay: 5000 }).show();
    }

    function loadAiPredictions() {
        const btn = document.getElementById('btnAi');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 적재 중... (2-3분 소요)';

        showToast('AI 예측값 데이터 적재를 시작합니다. 약 2-3분이 소요됩니다.', true);

        fetch('/api/v1/data/init-multi-model-predictions-all', {method:'POST'})
        .then(r=>r.text())
        .then(m=>{
            showToast(m, true);
            checkDataStatus();
        })
        .catch(e => {
            console.error(e);
            showToast('AI 예측값 데이터 적재 중 오류가 발생했습니다.', false);
            checkDataStatus();
        });
    }

    function loadMinuteCandles() {
        const btn = document.getElementById('btnMinute');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 적재 중... (15-20분 소요)';

        showToast('1분봉 데이터 적재를 시작합니다. 약 15-20분이 소요됩니다.', true);

        fetch('/api/v1/data/init-minute-candles', {method:'POST'})
        .then(r=>r.text())
        .then(m=>{
            showToast(m, true);
            checkDataStatus();
        })
        .catch(e => {
            console.error(e);
            showToast('1분봉 데이터 적재 중 오류가 발생했습니다.', false);
            checkDataStatus();
        });
    }

    function setPreset(preset) {
        // Clear all
        ALL_MODELS.forEach(m => document.getElementById(`model_${m}`).checked = false);
        for(let i=1; i<=7; i++) document.getElementById(`fold_${i}`).checked = false;

        // Set based on preset
        let models = [];
        if (preset === 'all') models = ALL_MODELS;
        else if (preset === 'deeplearning') models = DEEPLEARNING_MODELS;
        else if (preset === 'ensemble') models = ENSEMBLE_MODELS;
        else if (preset === 'gru') models = ['GRU'];

        models.forEach(m => document.getElementById(`model_${m}`).checked = true);
        for(let i=1; i<=7; i++) document.getElementById(`fold_${i}`).checked = true;

        showToast(`프리셋 "${preset}" 적용됨: ${models.length}개 모델 × Fold 1-7`, true);
    }

    function getSelectedModels() {
        return ALL_MODELS.filter(m => document.getElementById(`model_${m}`).checked);
    }

    function getSelectedFolds() {
        return Array.from({length: 7}, (_, i) => i + 1).filter(f => document.getElementById(`fold_${f}`).checked);
    }

    async function runBatchBacktest() {
        const models = getSelectedModels();
        const folds = getSelectedFolds();

        if (models.length === 0 || folds.length === 0) {
            showToast('모델과 Fold를 선택해주세요.', false);
            return;
        }

        const initialCapital = parseFloat(document.getElementById('initialCapital').value);
        const predProbaThreshold = parseFloat(document.getElementById('predProbaThreshold').value);
        const holdingPeriodDays = parseInt(document.getElementById('holdingPeriodDays').value);

        // Show progress section
        document.getElementById('progressSection').style.display = 'block';
        document.getElementById('resultsSection').style.display = 'none';
        backtestResults = [];

        const totalTasks = models.length * folds.length;

        document.getElementById('overallProgress').textContent = `0 / ${totalTasks} 완료`;
        updateProgressBar(0, totalTasks);
        initializeProgressGrid(models, folds);

        const logs = document.getElementById('progressLogs');
        logs.innerHTML = '';
        addLog(`배치 백테스팅 시작: ${models.length}개 모델 × ${folds.length}개 Fold = 총 ${totalTasks}건`);

        // Execute batch backtest (ASYNC)
        const batchRequest = {
            modelNames: models,
            foldNumbers: folds,
            initialCapital: initialCapital,
            predProbaThreshold: predProbaThreshold,
            holdingPeriodDays: holdingPeriodDays
        };

        try {
            // 1. 비동기 작업 시작
            const response = await fetch('/api/backtest/tp-sl/run-batch-async', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(batchRequest)
            });

            if (!response.ok) {
                throw new Error('Failed to start batch backtest');
            }

            const jobData = await response.json();
            const jobId = jobData.jobId;

            addLog(`작업이 시작되었습니다. (Job ID: ${jobId})`);
            addLog(`진행 상황을 확인 중입니다...`);

            // 2. 폴링으로 진행 상황 조회 (2초마다)
            const pollInterval = setInterval(async () => {
                try {
                    const statusResponse = await fetch(`/api/backtest/tp-sl/job/${jobId}`);
                    if (!statusResponse.ok) {
                        clearInterval(pollInterval);
                        throw new Error('Failed to get job status');
                    }

                    const status = await statusResponse.json();

                    // 진행 상황 업데이트
                    document.getElementById('overallProgress').textContent =
                        `${status.completedTasks + status.failedTasks} / ${status.totalTasks} 완료`;
                    updateProgressBar(status.completedTasks + status.failedTasks, status.totalTasks);

                    addLog(`진행 중: ${status.completedTasks}개 성공, ${status.failedTasks}개 실패 (${status.progress}%)`);

                    // 완료 또는 실패 시 폴링 중단
                    if (status.status === 'COMPLETED' || status.status === 'FAILED') {
                        clearInterval(pollInterval);

                        if (status.status === 'COMPLETED') {
                            addLog(`백테스팅 완료! ${status.completedTasks}/${status.totalTasks}건 성공`);
                            showToast(`배치 백테스팅 완료! ${status.completedTasks}/${status.totalTasks}건 성공`, true);

                            // 3. 완료 후 결과 조회 (동기 API 재호출)
                            addLog(`결과를 조회하는 중...`);
                            await fetchResults(batchRequest);
                        } else {
                            addLog(`백테스팅 실패: ${status.errorMessage}`);
                            showToast('배치 백테스팅이 실패했습니다.', false);
                        }
                    }
                } catch (error) {
                    clearInterval(pollInterval);
                    console.error('Polling error:', error);
                    addLog(`진행 상황 조회 실패: ${error.message}`);
                }
            }, 2000); // 2초마다 폴링

        } catch (error) {
            console.error(error);
            addLog(`오류 발생: ${error.message}`);
            showToast('배치 백테스팅 중 오류가 발생했습니다.', false);
        }
    }

    // 완료 후 결과 조회 (동기 API 재호출 + Buy & Hold 추가)
    async function fetchResults(batchRequest) {
        try {
            addLog(`AI 모델 결과 조회 중...`);

            // 1. AI 모델 결과 조회
            const response = await fetch('/api/backtest/tp-sl/run-batch', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(batchRequest)
            });

            if (!response.ok) {
                throw new Error('Failed to fetch AI model results');
            }

            const aiResults = await response.json();
            addLog(`AI 모델 결과 조회 완료: ${aiResults.length}건`);

            // 2. Buy & Hold 결과 조회 (동일한 Fold에 대해)
            addLog(`Buy & Hold 벤치마크 실행 중...`);
            const buyHoldResponse = await fetch('/api/backtest/buy-hold/run-batch', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    foldNumbers: batchRequest.foldNumbers,
                    initialCapital: batchRequest.initialCapital
                })
            });

            let buyHoldResults = [];
            if (buyHoldResponse.ok) {
                buyHoldResults = await buyHoldResponse.json();
                addLog(`Buy & Hold 결과 조회 완료: ${buyHoldResults.length}건`);
            } else {
                addLog(`Buy & Hold 실패 (건너뜀)`);
            }

            // 3. 결과 합치기 (Buy & Hold를 맨 앞에 배치)
            backtestResults = [...buyHoldResults, ...aiResults];

            markAllCompleted();
            displayResults();
            addLog(`전체 결과 조회 완료: ${backtestResults.length}건 (Buy & Hold: ${buyHoldResults.length}, AI 모델: ${aiResults.length})`);
        } catch (error) {
            console.error('Result fetch error:', error);
            addLog(`결과 조회 실패: ${error.message}`);
            showToast('결과 조회에 실패했습니다. 페이지를 새로고침 후 다시 시도하세요.', false);
        }
    }

    function initializeProgressGrid(models, folds) {
        const grid = document.getElementById('progressGrid');
        grid.innerHTML = '';

        models.forEach(model => {
            folds.forEach(fold => {
                const card = document.createElement('div');
                card.className = 'model-progress-card pending';
                card.id = `progress_${model}_${fold}`;
                card.innerHTML = `
                    <div class="fw-bold">${model}</div>
                    <div class="small text-muted">Fold ${fold}</div>
                    <div class="small"><i class="fas fa-clock"></i> 대기 중</div>
                `;
                grid.appendChild(card);
            });
        });
    }

    function markAllCompleted() {
        backtestResults.forEach(result => {
            const card = document.getElementById(`progress_${result.modelName}_${result.foldNumber}`);
            if (card) {
                card.className = 'model-progress-card completed';
                card.innerHTML = `
                    <div class="fw-bold">${result.modelName}</div>
                    <div class="small text-muted">Fold ${result.foldNumber}</div>
                    <div class="small text-success"><i class="fas fa-check"></i> 완료 (${result.totalReturnPct.toFixed(2)}%)</div>
                `;
            }
        });
    }

    function updateProgressBar(completed, total) {
        const percent = Math.round((completed / total) * 100);
        const bar = document.getElementById('progressBar');
        bar.style.width = percent + '%';
        bar.textContent = percent + '%';
        bar.setAttribute('aria-valuenow', percent);
    }

    function addLog(message) {
        const logs = document.getElementById('progressLogs');
        const timestamp = new Date().toLocaleTimeString();
        logs.innerHTML += `[${timestamp}] ${message}<br>`;
        logs.scrollTop = logs.scrollHeight;
    }

    function displayResults() {
        document.getElementById('resultsSection').style.display = 'block';

        // CUSUM 결과가 있는지 확인
        const hasCusumResults = backtestResults.some(r => r.regime === 'CUSUM');

        // CUSUM 분석 탭 표시/숨김
        document.getElementById('cusumTabItem').style.display = hasCusumResults ? 'block' : 'none';

        // Model Comparison Tab
        displayModelComparison();

        // Capital Tracking Tab
        displayCapitalTracking();

        // Details Tab
        displayDetails();

        // CUSUM Analysis Tab (CUSUM 결과가 있을 때만)
        if (hasCusumResults) {
            displayCusumAnalysis();
        }
    }

    function displayModelComparison() {
        const content = document.getElementById('modelContent');
        const modelStats = {};

        // 모델별로 Fold 결과 수집
        backtestResults.forEach(r => {
            if (!modelStats[r.modelName]) {
                modelStats[r.modelName] = {
                    folds: []
                };
            }
            modelStats[r.modelName].folds.push(r);
        });

        // Prepare data for charts
        const modelNames = Object.keys(modelStats);
        const totalReturns = [];
        const totalMDDs = [];
        const totalSharpes = [];
        const totalWinRates = [];
        const maxReturns = [];
        const minReturns = [];
        const totalTrades = [];

        // 각 모델별 전체 기간 지표 계산
        Object.entries(modelStats).forEach(([model, stats]) => {
            // Fold를 번호순으로 정렬
            const sortedFolds = stats.folds.sort((a, b) => a.foldNumber - b.foldNumber);

            // 1. 전체 수익률 계산 (복리)
            const initialCapital = sortedFolds[0].initialCapital;
            const finalCapital = sortedFolds[sortedFolds.length - 1].finalCapital;
            const totalReturn = ((finalCapital - initialCapital) / initialCapital) * 100;

            // 2. Fold별 수익률 (최대/최소용)
            const foldReturns = sortedFolds.map(f => parseFloat(f.totalReturnPct));
            const maxReturn = Math.max(...foldReturns);
            const minReturn = Math.min(...foldReturns);

            // 3. 전체 거래 수집
            let allTrades = [];
            sortedFolds.forEach(fold => {
                if (fold.tradeHistory && fold.tradeHistory.length > 0) {
                    allTrades = allTrades.concat(fold.tradeHistory);
                }
            });

            // 4. 전체 승률 계산
            const winningTrades = allTrades.filter(t => parseFloat(t.profit) > 0).length;
            const totalWinRate = allTrades.length > 0 ? (winningTrades / allTrades.length) * 100 : 0;

            // 5. 전체 MDD 계산 (모든 거래의 자본 변화 추적)
            let peak = initialCapital;
            let maxDD = 0;
            allTrades.forEach(trade => {
                const current = parseFloat(trade.capitalAfter);
                if (current > peak) peak = current;
                const drawdown = ((peak - current) / peak) * 100;
                if (drawdown > maxDD) maxDD = drawdown;
            });

            // 6. 전체 Sharpe Ratio 계산 (모든 거래 기준)
            let totalSharpe = 0;
            if (allTrades.length >= 2) {
                const avgReturn = allTrades.reduce((sum, t) => sum + parseFloat(t.returnPct), 0) / allTrades.length;
                const variance = allTrades.reduce((sum, t) => {
                    const diff = parseFloat(t.returnPct) - avgReturn;
                    return sum + (diff * diff);
                }, 0) / allTrades.length;
                const stdDev = Math.sqrt(variance);
                totalSharpe = stdDev > 0 ? avgReturn / stdDev : 0;
            }

            // 통계 저장
            stats.totalReturn = totalReturn;
            stats.maxReturn = maxReturn;
            stats.minReturn = minReturn;
            stats.totalWinRate = totalWinRate;
            stats.totalMDD = maxDD;
            stats.totalSharpe = totalSharpe;
            stats.totalTrades = allTrades.length;
        });

        let tableHTML = `
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header" style="background-color: var(--accent-dark); color: #FFFFFF;">
                            <i class="fas fa-chart-bar me-2"></i>모델별 전체 수익률 비교
                        </div>
                        <div class="card-body">
                            <canvas id="modelReturnChart" style="max-height: 300px;"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header" style="background-color: var(--accent-dark); color: #FFFFFF;">
                            <i class="fas fa-chart-bar me-2"></i>모델별 MDD & Sharpe Ratio
                        </div>
                        <div class="card-body">
                            <canvas id="modelRiskChart" style="max-height: 300px;"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header" style="background-color: var(--accent-dark); color: #FFFFFF;">
                            <i class="fas fa-radar-chart me-2"></i>모델별 종합 성능 비교
                        </div>
                        <div class="card-body">
                            <canvas id="modelRadarChart" style="max-height: 400px;"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <table class="table table-striped result-table">
                <thead><tr>
                    <th>모델</th>
                    <th>전체 수익률</th>
                    <th>최대 수익률 (Fold)</th>
                    <th>최소 수익률 (Fold)</th>
                    <th>전체 승률</th>
                    <th>전체 MDD</th>
                    <th>전체 Sharpe</th>
                    <th>총 거래 수</th>
                </tr></thead>
                <tbody>
        `;

        Object.entries(modelStats).forEach(([model, stats]) => {
            totalReturns.push(stats.totalReturn);
            totalMDDs.push(stats.totalMDD);
            totalSharpes.push(stats.totalSharpe);
            totalWinRates.push(stats.totalWinRate);
            maxReturns.push(stats.maxReturn);
            minReturns.push(stats.minReturn);
            totalTrades.push(stats.totalTrades);

            // Buy & Hold는 배경색 강조
            const isBuyHold = model === 'Buy & Hold';
            const rowStyle = isBuyHold ? 'style="background-color: #fff3cd;"' : '';
            const modelLabel = isBuyHold ? `<i class="fas fa-chart-line me-1"></i>${model} <span class="badge bg-warning text-dark">벤치마크</span>` : model;

            tableHTML += `
                <tr ${rowStyle}>
                    <td class="fw-bold">${modelLabel}</td>
                    <td class="${stats.totalReturn >= 0 ? 'text-success' : 'text-danger'} fw-bold">${stats.totalReturn.toFixed(2)}%</td>
                    <td class="text-success">${stats.maxReturn.toFixed(2)}%</td>
                    <td class="text-danger">${stats.minReturn.toFixed(2)}%</td>
                    <td>${stats.totalWinRate.toFixed(2)}%</td>
                    <td class="${stats.totalMDD <= 10 ? 'text-success' : stats.totalMDD <= 20 ? 'text-warning' : 'text-danger'}">${stats.totalMDD.toFixed(2)}%</td>
                    <td class="${stats.totalSharpe >= 2 ? 'text-success' : stats.totalSharpe >= 1 ? 'text-warning' : 'text-danger'}">${stats.totalSharpe.toFixed(2)}</td>
                    <td>${stats.totalTrades}</td>
                </tr>
            `;
        });

        tableHTML += '</tbody></table>';
        content.innerHTML = tableHTML;

        // Create Return Bar Chart
        const returnCtx = document.getElementById('modelReturnChart').getContext('2d');
        new Chart(returnCtx, {
            type: 'bar',
            data: {
                labels: modelNames,
                datasets: [{
                    label: '전체 수익률 (%)',
                    data: totalReturns,
                    backgroundColor: totalReturns.map((r, idx) => {
                        if (modelNames[idx] === 'Buy & Hold') return '#ffc107'; // 골드
                        return r >= 0 ? '#A3B087' : '#E07856';
                    }),
                    borderColor: totalReturns.map((r, idx) => {
                        if (modelNames[idx] === 'Buy & Hold') return '#ffc107'; // 골드
                        return r >= 0 ? '#A3B087' : '#E07856';
                    }),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `수익률: ${context.parsed.y.toFixed(2)}%`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: '수익률 (%)',
                            color: '#313647',
                            font: { size: 12, weight: '600' }
                        },
                        ticks: { color: '#313647' },
                        grid: { color: '#e0e0e0' }
                    },
                    x: {
                        ticks: { color: '#313647' },
                        grid: { color: '#e0e0e0' }
                    }
                }
            }
        });

        // Create Risk Chart (MDD & Sharpe)
        const riskCtx = document.getElementById('modelRiskChart').getContext('2d');
        new Chart(riskCtx, {
            type: 'bar',
            data: {
                labels: modelNames,
                datasets: [
                    {
                        label: 'MDD (%)',
                        data: totalMDDs,
                        backgroundColor: '#E07856',
                        borderColor: '#E07856',
                        borderWidth: 1,
                        yAxisID: 'y'
                    },
                    {
                        label: 'Sharpe Ratio',
                        data: totalSharpes,
                        backgroundColor: '#6C91BF',
                        borderColor: '#6C91BF',
                        borderWidth: 1,
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            font: { size: 11, family: 'Segoe UI' },
                            color: '#313647'
                        }
                    }
                },
                scales: {
                    y: {
                        type: 'linear',
                        position: 'left',
                        title: {
                            display: true,
                            text: 'MDD (%)',
                            color: '#E07856',
                            font: { size: 11, weight: '600' }
                        },
                        ticks: { color: '#313647' },
                        grid: { color: '#e0e0e0' }
                    },
                    y1: {
                        type: 'linear',
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Sharpe Ratio',
                            color: '#6C91BF',
                            font: { size: 11, weight: '600' }
                        },
                        ticks: { color: '#313647' },
                        grid: { display: false }
                    },
                    x: {
                        ticks: { color: '#313647' },
                        grid: { color: '#e0e0e0' }
                    }
                }
            }
        });

        // Create Radar Chart (Normalized metrics)
        const radarCtx = document.getElementById('modelRadarChart').getContext('2d');

        // Normalize metrics to 0-100 scale for radar chart
        const maxReturn = Math.max(...totalReturns.map(Math.abs));
        const maxWinRate = Math.max(...totalWinRates);
        const maxMDD = Math.max(...totalMDDs);
        const maxSharpe = Math.max(...totalSharpes);

        const radarDatasets = modelNames.map((model, idx) => {
            const normalizedReturn = (totalReturns[idx] / maxReturn) * 100;
            const normalizedWinRate = (totalWinRates[idx] / maxWinRate) * 100;
            const normalizedMDD = 100 - (totalMDDs[idx] / maxMDD) * 100; // Invert MDD (lower is better)
            const normalizedSharpe = (totalSharpes[idx] / maxSharpe) * 100;

            const colors = ['#A3B087', '#6C91BF', '#E07856', '#435663', '#28a745', '#dc3545', '#ffc107', '#17a2b8', '#6610f2', '#e83e8c', '#fd7e14', '#20c997'];
            const color = colors[idx % colors.length];

            return {
                label: model,
                data: [normalizedReturn, normalizedWinRate, normalizedMDD, normalizedSharpe],
                backgroundColor: color + '33',
                borderColor: color,
                borderWidth: 2,
                pointBackgroundColor: color,
                pointBorderColor: '#fff',
                pointHoverBackgroundColor: '#fff',
                pointHoverBorderColor: color
            };
        });

        new Chart(radarCtx, {
            type: 'radar',
            data: {
                labels: ['전체 수익률', '전체 승률', '낮은 MDD', 'Sharpe Ratio'],
                datasets: radarDatasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            font: { size: 11, family: 'Segoe UI' },
                            color: '#313647',
                            padding: 10
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const modelIdx = context.datasetIndex;
                                const metricIdx = context.dataIndex;
                                const metrics = ['전체 수익률', '전체 승률', 'MDD', 'Sharpe'];
                                const values = [
                                    `${totalReturns[modelIdx].toFixed(2)}%`,
                                    `${totalWinRates[modelIdx].toFixed(2)}%`,
                                    `${totalMDDs[modelIdx].toFixed(2)}%`,
                                    totalSharpes[modelIdx].toFixed(2)
                                ];
                                return `${context.dataset.label} - ${metrics[metricIdx]}: ${values[metricIdx]}`;
                            }
                        }
                    }
                },
                scales: {
                    r: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            stepSize: 20,
                            color: '#313647'
                        },
                        grid: {
                            color: '#e0e0e0'
                        },
                        pointLabels: {
                            color: '#313647',
                            font: { size: 12, weight: '600' }
                        }
                    }
                }
            }
        });
    }

    function sortResults(column) {
        if (sortColumn === column) {
            sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            sortColumn = column;
            sortDirection = 'desc';
        }
        displayDetails();
    }

    function applyFilters() {
        const fold = document.getElementById('filterFold').value;
        const returnMin = parseFloat(document.getElementById('filterReturnMin').value) || -Infinity;
        const returnMax = parseFloat(document.getElementById('filterReturnMax').value) || Infinity;
        const mddMin = parseFloat(document.getElementById('filterMddMin').value) || -Infinity;
        const mddMax = parseFloat(document.getElementById('filterMddMax').value) || Infinity;
        const sharpeMin = parseFloat(document.getElementById('filterSharpeMin').value) || -Infinity;
        const sharpeMax = parseFloat(document.getElementById('filterSharpeMax').value) || Infinity;

        filterFold = fold ? parseInt(fold) : null;
        filterReturnMin = returnMin;
        filterReturnMax = returnMax;
        filterMddMin = mddMin;
        filterMddMax = mddMax;
        filterSharpeMin = sharpeMin;
        filterSharpeMax = sharpeMax;

        displayDetails();
    }

    function resetFilters() {
        document.getElementById('filterFold').value = '';
        document.getElementById('filterReturnMin').value = '';
        document.getElementById('filterReturnMax').value = '';
        document.getElementById('filterMddMin').value = '';
        document.getElementById('filterMddMax').value = '';
        document.getElementById('filterSharpeMin').value = '';
        document.getElementById('filterSharpeMax').value = '';

        filterFold = null;
        filterReturnMin = -Infinity;
        filterReturnMax = Infinity;
        filterMddMin = -Infinity;
        filterMddMax = Infinity;
        filterSharpeMin = -Infinity;
        filterSharpeMax = Infinity;

        displayDetails();
    }

    function exportToCSV() {
        if (backtestResults.length === 0) {
            showToast('내보낼 데이터가 없습니다.', false);
            return;
        }

        // Apply same filtering as display
        let filteredResults = backtestResults.filter(r => {
            const foldMatch = filterFold === null || r.foldNumber === filterFold;
            return foldMatch &&
                   r.totalReturnPct >= filterReturnMin && r.totalReturnPct <= filterReturnMax &&
                   r.maxDrawdown >= filterMddMin && r.maxDrawdown <= filterMddMax &&
                   r.sharpeRatio >= filterSharpeMin && r.sharpeRatio <= filterSharpeMax;
        });

        // CSV header
        const headers = ['모델', 'Fold', '체제', '수익률(%)', '거래수', '익절', '손절', 'Profit Ladder', 'Time-Decay', '시간만료', '승률(%)', 'MDD(%)', 'Sharpe'];
        let csvContent = headers.join(',') + '\n';

        // CSV rows
        filteredResults.forEach(r => {
            let profitLadderCount = 0;
            let timeDecayCount = 0;

            if (r.tradeHistory) {
                r.tradeHistory.forEach(trade => {
                    if (trade.exitEvents && Array.isArray(trade.exitEvents)) {
                        trade.exitEvents.forEach(event => {
                            if (event.exitReason === 'PROFIT_LADDER') profitLadderCount++;
                            else if (event.exitReason === 'TIME_DECAY') timeDecayCount++;
                        });
                    }
                });
            }

            const row = [
                r.modelName,
                r.foldNumber,
                r.regime,
                r.totalReturnPct.toFixed(2),
                r.totalTrades,
                r.takeProfitExits,
                r.stopLossExits,
                profitLadderCount,
                timeDecayCount,
                r.timeoutExits,
                r.winRate.toFixed(2),
                r.maxDrawdown.toFixed(2),
                r.sharpeRatio.toFixed(2)
            ];
            csvContent += row.join(',') + '\n';
        });

        // Download file
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
        link.setAttribute('href', url);
        link.setAttribute('download', `backtest_results_${timestamp}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        showToast(`CSV 파일이 다운로드되었습니다. (${filteredResults.length}건)`, true);
    }

    function displayDetails() {
        const content = document.getElementById('detailsContent');

        // Filter controls UI
        const getSortIndicator = (column) => {
            if (sortColumn === column) {
                return sortDirection === 'asc' ? ' ↑' : ' ↓';
            }
            return '';
        };

        let filterHTML = `
            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center" style="background-color: var(--accent-dark); color: #FFFFFF;">
                    <span><i class="fas fa-filter me-2"></i>필터 및 내보내기</span>
                    <button class="btn btn-sm btn-success" onclick="exportToCSV()">
                        <i class="fas fa-download me-1"></i>CSV 내보내기
                    </button>
                </div>
                <div class="card-body">
                    <div class="row g-3 mb-3">
                        <div class="col-md-3">
                            <label class="form-label fw-bold"><i class="fas fa-layer-group me-1"></i>Fold</label>
                            <select class="form-select form-select-sm" id="filterFold">
                                <option value="">전체</option>
                                <option value="1">Fold 1 (BEAR)</option>
                                <option value="2">Fold 2 (BEAR)</option>
                                <option value="3">Fold 3 (SIDEWAYS)</option>
                                <option value="4">Fold 4 (SIDEWAYS)</option>
                                <option value="5">Fold 5 (BULL)</option>
                                <option value="6">Fold 6 (BULL)</option>
                                <option value="7">Fold 7 (BULL)</option>
                                <option value="8">Fold 8 (MIXED)</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold"><i class="fas fa-percentage me-1"></i>수익률 (%)</label>
                            <div class="input-group input-group-sm">
                                <input type="number" class="form-control" id="filterReturnMin" placeholder="최소" step="0.1">
                                <span class="input-group-text">~</span>
                                <input type="number" class="form-control" id="filterReturnMax" placeholder="최대" step="0.1">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold"><i class="fas fa-chart-line me-1"></i>MDD (%)</label>
                            <div class="input-group input-group-sm">
                                <input type="number" class="form-control" id="filterMddMin" placeholder="최소" step="0.1">
                                <span class="input-group-text">~</span>
                                <input type="number" class="form-control" id="filterMddMax" placeholder="최대" step="0.1">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold"><i class="fas fa-chart-bar me-1"></i>Sharpe Ratio</label>
                            <div class="input-group input-group-sm">
                                <input type="number" class="form-control" id="filterSharpeMin" placeholder="최소" step="0.1">
                                <span class="input-group-text">~</span>
                                <input type="number" class="form-control" id="filterSharpeMax" placeholder="최대" step="0.1">
                            </div>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-12 text-end">
                            <button class="btn btn-sm btn-primary" onclick="applyFilters()">
                                <i class="fas fa-check me-1"></i>필터 적용
                            </button>
                            <button class="btn btn-sm btn-secondary ms-2" onclick="resetFilters()">
                                <i class="fas fa-undo me-1"></i>초기화
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Apply filters
        let filteredResults = backtestResults.filter(r => {
            const foldMatch = filterFold === null || r.foldNumber === filterFold;
            return foldMatch &&
                   r.totalReturnPct >= filterReturnMin && r.totalReturnPct <= filterReturnMax &&
                   r.maxDrawdown >= filterMddMin && r.maxDrawdown <= filterMddMax &&
                   r.sharpeRatio >= filterSharpeMin && r.sharpeRatio <= filterSharpeMax;
        });

        // Apply sorting
        filteredResults.sort((a, b) => {
            let aVal, bVal;

            switch(sortColumn) {
                case 'modelName':
                    aVal = a.modelName;
                    bVal = b.modelName;
                    break;
                case 'foldNumber':
                    aVal = a.foldNumber;
                    bVal = b.foldNumber;
                    break;
                case 'totalReturnPct':
                    aVal = parseFloat(a.totalReturnPct);
                    bVal = parseFloat(b.totalReturnPct);
                    break;
                case 'totalTrades':
                    aVal = a.totalTrades;
                    bVal = b.totalTrades;
                    break;
                case 'winRate':
                    aVal = parseFloat(a.winRate);
                    bVal = parseFloat(b.winRate);
                    break;
                case 'maxDrawdown':
                    aVal = parseFloat(a.maxDrawdown);
                    bVal = parseFloat(b.maxDrawdown);
                    break;
                case 'sharpeRatio':
                    aVal = parseFloat(a.sharpeRatio);
                    bVal = parseFloat(b.sharpeRatio);
                    break;
                default:
                    aVal = 0;
                    bVal = 0;
            }

            if (typeof aVal === 'string') {
                return sortDirection === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
            } else {
                return sortDirection === 'asc' ? aVal - bVal : bVal - aVal;
            }
        });

        // CUSUM 결과가 있는지 확인
        const hasCusumResults = filteredResults.some(r => r.regime === 'CUSUM');
        const hasNonCusumResults = filteredResults.some(r => r.regime !== 'CUSUM');

        let tableHTML = `
            <div class="mb-2 text-muted">
                <i class="fas fa-info-circle me-1"></i>총 ${filteredResults.length}건 (전체 ${backtestResults.length}건 중)
                ${filteredResults.length < backtestResults.length ? ' - 필터가 적용되었습니다.' : ''}
                ${hasCusumResults ? ' <span class="badge bg-success"><i class="fas fa-filter me-1"></i>CUSUM 결과 포함</span>' : ''}
            </div>
            <table class="table table-striped table-hover result-table">
                <thead><tr>
                    <th onclick="sortResults('modelName')" style="cursor: pointer;">모델${getSortIndicator('modelName')}</th>
                    <th onclick="sortResults('foldNumber')" style="cursor: pointer;">Fold${getSortIndicator('foldNumber')}</th>
                    <th>체제</th>
                    <th onclick="sortResults('totalReturnPct')" style="cursor: pointer;">수익률${getSortIndicator('totalReturnPct')}</th>
                    <th onclick="sortResults('totalTrades')" style="cursor: pointer;">거래 수${getSortIndicator('totalTrades')}</th>
                    <th>익절</th>
                    <th>손절</th>
                    ${hasNonCusumResults ? '<th>Profit Ladder</th><th>Time-Decay</th>' : ''}
                    ${hasCusumResults ? '<th>확신도</th><th>투자비중</th>' : ''}
                    <th>시간만료</th>
                    <th onclick="sortResults('winRate')" style="cursor: pointer;">승률${getSortIndicator('winRate')}</th>
                    <th onclick="sortResults('maxDrawdown')" style="cursor: pointer;">MDD${getSortIndicator('maxDrawdown')}</th>
                    <th onclick="sortResults('sharpeRatio')" style="cursor: pointer;">Sharpe${getSortIndicator('sharpeRatio')}</th>
                    <th>상세 보기</th>
                </tr></thead>
                <tbody>
        `;

        filteredResults.forEach((r, idx) => {
            // Count Profit Ladder and Time-Decay events from tradeHistory
            let profitLadderCount = 0;
            let timeDecayCount = 0;

            if (r.tradeHistory) {
                r.tradeHistory.forEach(trade => {
                    if (trade.exitEvents && Array.isArray(trade.exitEvents)) {
                        trade.exitEvents.forEach(event => {
                            if (event.exitReason === 'PROFIT_LADDER') profitLadderCount++;
                            else if (event.exitReason === 'TIME_DECAY') timeDecayCount++;
                        });
                    }
                });
            }

            // Find the original index in backtestResults for showExitDetails()
            const originalIdx = backtestResults.findIndex(result =>
                result.modelName === r.modelName && result.foldNumber === r.foldNumber
            );

            // Buy & Hold는 배경색 강조
            const isBuyHold = r.modelName === 'Buy & Hold';
            const rowStyle = isBuyHold ? 'style="background-color: #fff3cd;"' : '';
            const modelLabel = isBuyHold ? `<i class="fas fa-chart-line me-1"></i>${r.modelName} <span class="badge bg-warning text-dark">벤치마크</span>` : r.modelName;

            // CUSUM 결과인지 확인
            const isCusum = r.regime === 'CUSUM';
            const confidence = r.avgConfidence ? (parseFloat(r.avgConfidence) * 100).toFixed(1) : '-';
            const investRatio = r.avgInvestmentRatio ? (parseFloat(r.avgInvestmentRatio) * 100).toFixed(0) : '-';

            tableHTML += `
                <tr ${rowStyle}>
                    <td class="fw-bold">${modelLabel}</td>
                    <td>Fold ${r.foldNumber}</td>
                    <td><span class="badge ${isCusum ? 'bg-success' : 'bg-secondary'}">${r.regime}</span></td>
                    <td class="${r.totalReturnPct >= 0 ? 'text-success' : 'text-danger'} fw-bold">${r.totalReturnPct.toFixed(2)}%</td>
                    <td>${r.totalTrades}</td>
                    <td class="text-success">${r.takeProfitExits}</td>
                    <td class="text-danger">${r.stopLossExits}</td>
                    ${hasNonCusumResults ? `<td><span class="badge" style="background-color: #A3B087;">${profitLadderCount}</span></td>
                    <td><span class="badge" style="background-color: #6C91BF;">${timeDecayCount}</span></td>` : ''}
                    ${hasCusumResults ? `<td>${isCusum ? '<span class="badge" style="background-color: #A3B087;">' + confidence + '%</span>' : '-'}</td>
                    <td>${isCusum ? investRatio + '%' : '-'}</td>` : ''}
                    <td class="text-warning">${r.timeoutExits}</td>
                    <td>${r.winRate.toFixed(2)}%</td>
                    <td>${r.maxDrawdown.toFixed(2)}%</td>
                    <td>${r.sharpeRatio.toFixed(2)}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="showExitDetails(${originalIdx})">
                            <i class="fas fa-eye"></i> 보기
                        </button>
                    </td>
                </tr>
            `;
        });

        tableHTML += '</tbody></table>';
        content.innerHTML = filterHTML + tableHTML;
    }

    function displayCapitalTracking() {
        // CUSUM 결과가 있는지 확인
        const hasCusumResults = backtestResults.some(r => r.regime === 'CUSUM');

        // Populate model filter
        const modelFilter = document.getElementById('chartModelFilter');
        const uniqueModels = [...new Set(backtestResults.map(r => r.modelName))];
        modelFilter.innerHTML = '<option value="">전체 모델</option>';
        uniqueModels.forEach(model => {
            modelFilter.innerHTML += `<option value="${model}">${model}</option>`;
        });

        // Populate fold filter
        const foldFilter = document.getElementById('chartFoldFilter');
        const uniqueFolds = [...new Set(backtestResults.map(r => r.foldNumber))].sort((a,b) => a-b);
        foldFilter.innerHTML = '<option value="">전체 Fold</option>';
        uniqueFolds.forEach(fold => {
            foldFilter.innerHTML += `<option value="${fold}">Fold ${fold}</option>`;
        });

        // CUSUM 전용 필터 (CUSUM 결과가 있을 때만 표시)
        const cusumFiltersDiv = document.getElementById('cusumChartFilters');
        if (hasCusumResults) {
            cusumFiltersDiv.style.display = 'flex';

            // CUSUM 전략 필터
            const cusumResults = backtestResults.filter(r => r.regime === 'CUSUM');
            const cusumStrategiesSet = [...new Set(cusumResults.map(r => r.strategy).filter(Boolean))];
            const strategySelect = document.getElementById('chartCusumStrategy');
            strategySelect.innerHTML = '<option value="">전체 전략</option>';
            cusumStrategiesSet.sort().forEach(s => {
                strategySelect.innerHTML += `<option value="${s}">${s}</option>`;
            });

            // CUSUM ML 모델 필터
            const cusumMlModelsSet = [...new Set(cusumResults.map(r => r.mlModel).filter(Boolean))];
            const mlModelSelect = document.getElementById('chartCusumMlModel');
            mlModelSelect.innerHTML = '<option value="">전체 ML 모델</option>';
            cusumMlModelsSet.sort().forEach(m => {
                mlModelSelect.innerHTML += `<option value="${m}">${m}</option>`;
            });
        } else {
            cusumFiltersDiv.style.display = 'none';
        }

        // Initialize chart
        updateCapitalChart();
    }

    function updateCapitalChart() {
        const modelFilter = document.getElementById('chartModelFilter').value;
        const foldFilter = document.getElementById('chartFoldFilter').value;
        const regimeFilter = document.getElementById('chartRegimeFilter').value;
        const maxLines = parseInt(document.getElementById('chartMaxLines').value) || 0;
        const showLegend = document.getElementById('chartShowLegend').checked;

        // CUSUM 전용 필터
        const cusumStrategy = document.getElementById('chartCusumStrategy')?.value || '';
        const cusumMlModel = document.getElementById('chartCusumMlModel')?.value || '';
        const cusumTimeframe = document.getElementById('chartCusumTimeframe')?.value || '';

        // Filter results
        let filteredResults = backtestResults;

        // 기본 필터
        if (modelFilter) {
            filteredResults = filteredResults.filter(r => r.modelName === modelFilter);
        }
        if (foldFilter) {
            filteredResults = filteredResults.filter(r => r.foldNumber == foldFilter);
        }

        // 체제 필터
        if (regimeFilter === 'CUSUM') {
            filteredResults = filteredResults.filter(r => r.regime === 'CUSUM');
        } else if (regimeFilter === 'NON_CUSUM') {
            filteredResults = filteredResults.filter(r => r.regime !== 'CUSUM');
        }

        // CUSUM 전용 필터 적용
        if (cusumStrategy) {
            filteredResults = filteredResults.filter(r => r.strategy === cusumStrategy);
        }
        if (cusumMlModel) {
            filteredResults = filteredResults.filter(r => r.mlModel === cusumMlModel);
        }
        if (cusumTimeframe) {
            filteredResults = filteredResults.filter(r => r.strategyTimeframe === cusumTimeframe);
        }

        // 거래 내역이 있는 결과만 필터링
        filteredResults = filteredResults.filter(r => r.tradeHistory && r.tradeHistory.length > 0);

        // 수익률 기준 정렬 (상위 N개 선택용)
        filteredResults.sort((a, b) => parseFloat(b.totalReturnPct) - parseFloat(a.totalReturnPct));

        // 경고 메시지 처리
        const warningDiv = document.getElementById('chartWarning');
        const warningMsg = document.getElementById('chartWarningMessage');
        const totalCount = filteredResults.length;

        if (maxLines > 0 && totalCount > maxLines) {
            warningDiv.style.display = 'block';
            warningMsg.textContent = `총 ${totalCount}개 결과 중 수익률 상위 ${maxLines}개만 표시됩니다. 더 많은 결과를 보려면 '최대 표시 개수'를 조정하거나 필터를 사용하세요.`;
            filteredResults = filteredResults.slice(0, maxLines);
        } else if (totalCount > 20) {
            warningDiv.style.display = 'block';
            warningMsg.textContent = `${totalCount}개의 그래프가 표시됩니다. 가독성을 위해 필터를 사용하거나 표시 개수를 제한하는 것을 권장합니다.`;
        } else {
            warningDiv.style.display = 'none';
        }

        // 결과 개수 표시
        document.getElementById('chartResultCount').textContent = `${filteredResults.length}개 결과 표시 중 (전체 ${totalCount}개)`;

        // Prepare datasets
        const datasets = [];
        const colorPalette = [
            '#A3B087', // accent-green
            '#6C91BF', // accent-blue
            '#E07856', // accent-red
            '#435663', // accent-dark
            '#28a745', '#dc3545', '#ffc107', '#17a2b8',
            '#6610f2', '#e83e8c', '#fd7e14', '#20c997'
        ];

        filteredResults.forEach((result, idx) => {
            // 라벨 생성 (CUSUM인 경우 간결하게)
            let label;
            if (result.regime === 'CUSUM') {
                const strategyShort = result.strategy ? result.strategy.replace('target_', '') : '';
                label = `${strategyShort} (${result.mlModel || ''}) F${result.foldNumber}`;
            } else {
                label = `${result.modelName} - Fold ${result.foldNumber}`;
            }

            const color = colorPalette[idx % colorPalette.length];

            // Prepare data points
            const dataPoints = result.tradeHistory.map(trade => ({
                x: new Date(trade.exitDateTime),
                y: parseFloat(trade.capitalAfter),
                trade: trade
            }));

            // Add initial capital as first point
            if (dataPoints.length > 0) {
                dataPoints.unshift({
                    x: new Date(result.tradeHistory[0].entryDateTime),
                    y: parseFloat(result.initialCapital),
                    trade: null
                });
            }

            // Determine point colors based on exit reason
            const pointBackgroundColors = dataPoints.map(point => {
                if (!point.trade) return color; // Initial capital point
                if (point.trade.exitReason === 'TAKE_PROFIT') return '#28a745'; // Green
                if (point.trade.exitReason === 'STOP_LOSS') return '#dc3545'; // Red
                return '#6c757d'; // Gray for TIMEOUT
            });

            datasets.push({
                label: label,
                data: dataPoints,
                borderColor: color,
                backgroundColor: color + '33', // Semi-transparent
                pointBackgroundColor: pointBackgroundColors,
                pointBorderColor: pointBackgroundColors,
                pointRadius: filteredResults.length > 10 ? 3 : 5, // 많으면 포인트 작게
                pointHoverRadius: 7,
                tension: 0.1,
                fill: false,
                borderWidth: filteredResults.length > 10 ? 1.5 : 2 // 많으면 선 얇게
            });
        });

        // Destroy previous chart if exists
        if (capitalChart) {
            capitalChart.destroy();
        }

        // Create new chart
        const ctx = document.getElementById('capitalChart').getContext('2d');
        capitalChart = new Chart(ctx, {
            type: 'line',
            data: { datasets: datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'nearest',
                    intersect: false
                },
                plugins: {
                    legend: {
                        display: showLegend,
                        position: 'top',
                        labels: {
                            font: { size: 11, family: 'Segoe UI' },
                            color: '#313647',
                            boxWidth: 12,
                            padding: 8
                        }
                    },
                    tooltip: {
                        callbacks: {
                            title: function(context) {
                                const point = context[0].raw;
                                const modelInfo = context[0].dataset.label;
                                if (!point.trade) return `${modelInfo} - 시작 시점`;
                                return `${modelInfo} - 거래 #${point.trade.tradeNumber}`;
                            },
                            label: function(context) {
                                const point = context.raw;
                                if (!point.trade) {
                                    return `초기 자본: ${point.y.toLocaleString('ko-KR')}원`;
                                }
                                const trade = point.trade;
                                const lines = [
                                    `거래 후 자본: ${point.y.toLocaleString('ko-KR')}원`,
                                    `손익: ${parseFloat(trade.profit).toLocaleString('ko-KR')}원 (${parseFloat(trade.returnPct).toFixed(2)}%)`,
                                    `청산 사유: ${trade.exitReason === 'TAKE_PROFIT' ? '익절' : trade.exitReason === 'STOP_LOSS' ? '손절' : '타임아웃'}`
                                ];
                                // CUSUM 거래인 경우 추가 정보
                                if (trade.strategy || trade.mlModel) {
                                    lines.push(`확신도: ${trade.confidence ? (parseFloat(trade.confidence) * 100).toFixed(1) + '%' : '-'}`);
                                }
                                return lines;
                            }
                        },
                        backgroundColor: 'rgba(49, 54, 71, 0.95)',
                        titleColor: '#FFFFFF',
                        bodyColor: '#FFFFFF',
                        padding: 12,
                        displayColors: false
                    }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'day',
                            displayFormats: {
                                day: 'yyyy-MM-dd'
                            }
                        },
                        title: {
                            display: true,
                            text: '거래 청산 시간',
                            color: '#313647',
                            font: { size: 14, weight: '600' }
                        },
                        ticks: {
                            color: '#313647'
                        },
                        grid: {
                            color: '#e0e0e0'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: '자본 (원)',
                            color: '#313647',
                            font: { size: 14, weight: '600' }
                        },
                        ticks: {
                            color: '#313647',
                            callback: function(value) {
                                return value.toLocaleString('ko-KR');
                            }
                        },
                        grid: {
                            color: '#e0e0e0'
                        }
                    }
                }
            }
        });
    }

    function showExitDetails(resultIdx) {
        const result = backtestResults[resultIdx];

        // Populate modal header info
        document.getElementById('modalModelName').textContent = result.modelName;
        document.getElementById('modalFold').textContent = `Fold ${result.foldNumber}`;
        document.getElementById('modalTotalTrades').textContent = result.totalTrades;
        document.getElementById('modalReturn').textContent = `${result.totalReturnPct.toFixed(2)}%`;
        document.getElementById('modalReturn').className = result.totalReturnPct >= 0 ? 'text-success' : 'text-danger';

        // Populate trade history with exit events
        const historyContainer = document.getElementById('modalTradeHistory');

        if (!result.tradeHistory || result.tradeHistory.length === 0) {
            historyContainer.innerHTML = '<p class="text-center text-muted">거래 내역이 없습니다.</p>';
        } else {
            let historyHTML = '';

            result.tradeHistory.forEach((trade, idx) => {
                const hasExitEvents = trade.exitEvents && Array.isArray(trade.exitEvents) && trade.exitEvents.length > 0;

                // Determine exit reason badge
                let exitReasonBadge = '';
                if (trade.exitReason === 'TAKE_PROFIT') {
                    exitReasonBadge = '<span class="badge bg-success">익절 (TP)</span>';
                } else if (trade.exitReason === 'STOP_LOSS') {
                    exitReasonBadge = '<span class="badge bg-danger">손절 (SL)</span>';
                } else if (trade.exitReason === 'TIMEOUT') {
                    exitReasonBadge = '<span class="badge bg-warning">시간만료</span>';
                } else {
                    exitReasonBadge = `<span class="badge bg-secondary">${trade.exitReason}</span>`;
                }

                // CUSUM 거래인지 확인
                const isCusumTrade = trade.strategy || trade.mlModel || trade.cusumSelectivity;
                const cusumInfoHTML = isCusumTrade ? `
                    <div class="row g-3 mb-3" style="background-color: #f0f7f0; padding: 10px; border-radius: 8px; margin-top: 5px;">
                        <div class="col-12">
                            <small class="fw-bold text-success"><i class="fas fa-filter me-1"></i>CUSUM 신호 정보</small>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted">전략</small><br>
                            <strong>${trade.strategy || '-'}</strong>
                        </div>
                        <div class="col-md-2">
                            <small class="text-muted">ML 모델</small><br>
                            <span class="badge bg-primary">${trade.mlModel || '-'}</span>
                        </div>
                        <div class="col-md-2">
                            <small class="text-muted">확신도</small><br>
                            <span class="badge" style="background-color: #A3B087;">${trade.confidence ? (parseFloat(trade.confidence) * 100).toFixed(1) + '%' : '-'}</span>
                        </div>
                        <div class="col-md-2">
                            <small class="text-muted">투자 비중</small><br>
                            <strong>${trade.investmentRatio ? (parseFloat(trade.investmentRatio) * 100).toFixed(0) + '%' : '-'}</strong>
                        </div>
                        <div class="col-md-2">
                            <small class="text-muted">CUSUM 선별율</small><br>
                            <span class="badge" style="background-color: #E07856;">${trade.cusumSelectivity ? parseFloat(trade.cusumSelectivity).toFixed(1) + '%' : '-'}</span>
                        </div>
                        <div class="col-md-1">
                            <small class="text-muted">정확</small><br>
                            ${trade.isCorrect === true ? '<i class="fas fa-check-circle text-success"></i>' : trade.isCorrect === false ? '<i class="fas fa-times-circle text-danger"></i>' : '-'}
                        </div>
                    </div>
                ` : '';

                historyHTML += `
                    <div class="card mb-3">
                        <div class="card-header d-flex justify-content-between align-items-center" style="background-color: ${isCusumTrade ? '#e8f5e9' : '#f8f9fa'};">
                            <span class="fw-bold">거래 #${idx + 1} ${isCusumTrade ? '<span class="badge bg-success ms-2">CUSUM</span>' : ''}</span>
                            ${exitReasonBadge}
                        </div>
                        <div class="card-body">
                            ${cusumInfoHTML}
                            <div class="row g-3 mb-3">
                                <div class="col-md-3">
                                    <small class="text-muted">진입 시각</small><br>
                                    <strong>${new Date(trade.entryDateTime).toLocaleString('ko-KR')}</strong>
                                </div>
                                <div class="col-md-3">
                                    <small class="text-muted">청산 시각</small><br>
                                    <strong>${new Date(trade.exitDateTime).toLocaleString('ko-KR')}</strong>
                                </div>
                                <div class="col-md-3">
                                    <small class="text-muted">진입가</small><br>
                                    <strong>${parseFloat(trade.entryPrice).toLocaleString('ko-KR')}원</strong>
                                </div>
                                <div class="col-md-3">
                                    <small class="text-muted">최종 청산가</small><br>
                                    <strong>${parseFloat(trade.exitPrice).toLocaleString('ko-KR')}원</strong>
                                </div>
                            </div>
                            <div class="row g-3 mb-3">
                                <div class="col-md-3">
                                    <small class="text-muted">투자 금액</small><br>
                                    <strong>${(trade.positionSize || trade.investmentAmount) ? parseFloat(trade.positionSize || trade.investmentAmount).toLocaleString('ko-KR') + '원' : '-'}</strong>
                                </div>
                                <div class="col-md-3">
                                    <small class="text-muted">손익</small><br>
                                    <strong class="${parseFloat(trade.profit) >= 0 ? 'text-success' : 'text-danger'}">
                                        ${parseFloat(trade.profit).toLocaleString('ko-KR')}원
                                    </strong>
                                </div>
                                <div class="col-md-3">
                                    <small class="text-muted">수익률</small><br>
                                    <strong class="${parseFloat(trade.returnPct) >= 0 ? 'text-success' : 'text-danger'}">
                                        ${parseFloat(trade.returnPct).toFixed(2)}%
                                    </strong>
                                </div>
                                <div class="col-md-3">
                                    <small class="text-muted">보유 기간</small><br>
                                    <strong>${parseFloat(trade.holdingDays || trade.holdingPeriodDays || 0).toFixed(1)}일</strong>
                                </div>
                            </div>
                            ${hasExitEvents ? `
                                <hr>
                                <h6 class="fw-bold mb-3"><i class="fas fa-layer-group me-2"></i>분할 청산 이벤트 (${trade.exitEvents.length}건)</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm table-bordered">
                                        <thead class="table-light">
                                            <tr>
                                                <th style="width: 5%;">#</th>
                                                <th style="width: 20%;">청산 시각</th>
                                                <th style="width: 15%;">청산 가격</th>
                                                <th style="width: 12%;">청산 비율</th>
                                                <th style="width: 15%;">청산 금액</th>
                                                <th style="width: 12%;">손익</th>
                                                <th style="width: 10%;">수익률</th>
                                                <th style="width: 18%;">청산 사유</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${trade.exitEvents.map((event, eventIdx) => {
                                                let eventBadge = '';
                                                let badgeColor = '';
                                                if (event.exitReason === 'PROFIT_LADDER') {
                                                    eventBadge = `Profit Ladder (${event.triggerCondition})`;
                                                    badgeColor = '#A3B087';
                                                } else if (event.exitReason === 'TIME_DECAY') {
                                                    eventBadge = `Time-Decay (${event.triggerCondition})`;
                                                    badgeColor = '#6C91BF';
                                                } else if (event.exitReason === 'TAKE_PROFIT') {
                                                    eventBadge = '익절 (TP)';
                                                    badgeColor = '#28a745';
                                                } else if (event.exitReason === 'STOP_LOSS') {
                                                    eventBadge = '손절 (SL)';
                                                    badgeColor = '#dc3545';
                                                } else {
                                                    eventBadge = event.exitReason;
                                                    badgeColor = '#6c757d';
                                                }

                                                return `
                                                    <tr>
                                                        <td class="text-center">${eventIdx + 1}</td>
                                                        <td>${new Date(event.exitDateTime).toLocaleString('ko-KR', {
                                                            year: 'numeric',
                                                            month: '2-digit',
                                                            day: '2-digit',
                                                            hour: '2-digit',
                                                            minute: '2-digit'
                                                        })}</td>
                                                        <td class="text-end">${parseFloat(event.exitPrice).toLocaleString('ko-KR')}원</td>
                                                        <td class="text-center"><span class="badge bg-secondary">${(parseFloat(event.exitRatio) * 100).toFixed(0)}%</span></td>
                                                        <td class="text-end">${parseFloat(event.exitAmount).toLocaleString('ko-KR')}원</td>
                                                        <td class="text-end ${parseFloat(event.profit) >= 0 ? 'text-success' : 'text-danger'} fw-bold">
                                                            ${parseFloat(event.profit).toLocaleString('ko-KR')}원
                                                        </td>
                                                        <td class="text-end ${parseFloat(event.returnPct) >= 0 ? 'text-success' : 'text-danger'} fw-bold">
                                                            ${parseFloat(event.returnPct).toFixed(2)}%
                                                        </td>
                                                        <td>
                                                            <span class="badge" style="background-color: ${badgeColor}; font-size: 0.75rem;">
                                                                ${eventBadge}
                                                            </span>
                                                        </td>
                                                    </tr>
                                                `;
                                            }).join('')}
                                        </tbody>
                                        <tfoot class="table-light">
                                            <tr class="fw-bold">
                                                <td colspan="4" class="text-end">합계:</td>
                                                <td class="text-end">${trade.exitEvents.reduce((sum, e) => sum + parseFloat(e.exitAmount), 0).toLocaleString('ko-KR')}원</td>
                                                <td class="text-end ${parseFloat(trade.profit) >= 0 ? 'text-success' : 'text-danger'}">
                                                    ${parseFloat(trade.profit).toLocaleString('ko-KR')}원
                                                </td>
                                                <td class="text-end ${parseFloat(trade.returnPct) >= 0 ? 'text-success' : 'text-danger'}">
                                                    ${parseFloat(trade.returnPct).toFixed(2)}%
                                                </td>
                                                <td></td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            ` : '<p class="text-muted text-center">분할 청산 이벤트가 없습니다.</p>'}
                        </div>
                    </div>
                `;
            });

            historyContainer.innerHTML = historyHTML;
        }

        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('exitDetailsModal'));
        modal.show();
    }

    // =====================================================
    // CUSUM 신호 기반 백테스팅 함수들
    // =====================================================

    function checkCusumStatus() {
        fetch('/api/backtest/cusum/status')
            .then(r => r.json())
            .then(data => {
                const statusBadge = document.getElementById('cusumStatus');
                const countSpan = document.getElementById('cusumCount');
                const loadBtn = document.getElementById('btnCusum');
                const optionsDiv = document.getElementById('cusumOptions');
                const runBtn = document.getElementById('btnCusumRun');

                // API 응답 형식에 맞춤: dataLoaded, totalSignals, availableStrategies, etc.
                if (data.dataLoaded) {
                    cusumDataLoaded = true;
                    statusBadge.textContent = '완료';
                    statusBadge.className = 'badge bg-success';
                    countSpan.textContent = `(${data.totalSignals.toLocaleString()}건)`;
                    loadBtn.disabled = true;
                    loadBtn.innerHTML = '<i class="fas fa-check me-1"></i> 로드 완료';

                    // 옵션 영역 표시
                    optionsDiv.style.display = 'flex';
                    runBtn.style.display = 'block';

                    // 드롭다운 옵션 채우기
                    populateCusumOptions(data);
                } else {
                    cusumDataLoaded = false;
                    statusBadge.textContent = '미적재';
                    statusBadge.className = 'badge bg-danger';
                    countSpan.textContent = '';
                    optionsDiv.style.display = 'none';
                    runBtn.style.display = 'none';
                }
            })
            .catch(e => {
                console.error('CUSUM status check failed:', e);
                const statusBadge = document.getElementById('cusumStatus');
                statusBadge.textContent = '확인 실패';
                statusBadge.className = 'badge bg-warning';
            });
    }

    function populateCusumOptions(data) {
        // 전략 드롭다운 (API 응답: availableStrategies)
        const strategySelect = document.getElementById('cusumStrategy');
        strategySelect.innerHTML = '<option value="">전체 전략</option>';
        if (data.availableStrategies) {
            data.availableStrategies.forEach(s => {
                strategySelect.innerHTML += `<option value="${s}">${s}</option>`;
            });
            cusumStrategies = data.availableStrategies;
        }

        // 모델 드롭다운 (API 응답: availableModels)
        const modelSelect = document.getElementById('cusumModel');
        modelSelect.innerHTML = '<option value="">전체 모델</option>';
        if (data.availableModels) {
            data.availableModels.forEach(m => {
                modelSelect.innerHTML += `<option value="${m}">${m}</option>`;
            });
            cusumModels = data.availableModels;
        }

        // Fold 드롭다운 (API 응답: availableFolds)
        const foldSelect = document.getElementById('cusumFold');
        foldSelect.innerHTML = '<option value="">전체 Fold</option>';
        if (data.availableFolds) {
            data.availableFolds.forEach(f => {
                foldSelect.innerHTML += `<option value="${f}">Fold ${f}</option>`;
            });
            cusumFolds = data.availableFolds;
        }
    }

    /**
     * CUSUM 전용 분석 탭 표시
     * - 전략별/모델별/타임프레임별 비교 분석
     */
    function displayCusumAnalysis() {
        const content = document.getElementById('cusumAnalysisContent');
        const cusumResults = backtestResults.filter(r => r.regime === 'CUSUM');

        if (cusumResults.length === 0) {
            content.innerHTML = '<div class="alert alert-info">CUSUM 백테스팅 결과가 없습니다.</div>';
            return;
        }

        // 1. 전략별 집계
        const strategyStats = {};
        // 2. 모델별 집계 (LGBM, XGB, CAT, ET)
        const modelStats = {};
        // 3. 타임프레임별 집계
        const timeframeStats = {};
        // 4. 전략 타입별 집계 (Scalp, Balanced, Classic, Trend, Jackpot)
        const strategyTypeStats = {};

        cusumResults.forEach(r => {
            // 전략별
            const strategyKey = r.strategy || r.modelName;
            if (!strategyStats[strategyKey]) {
                strategyStats[strategyKey] = { results: [], totalReturn: 0, totalTrades: 0, wins: 0, totalConfidence: 0, totalSelectivity: 0, count: 0 };
            }
            strategyStats[strategyKey].results.push(r);
            strategyStats[strategyKey].totalReturn += parseFloat(r.totalReturnPct) || 0;
            strategyStats[strategyKey].totalTrades += r.totalTrades || 0;
            strategyStats[strategyKey].wins += r.takeProfitExits || 0;
            strategyStats[strategyKey].totalConfidence += parseFloat(r.avgConfidence) || 0;
            strategyStats[strategyKey].totalSelectivity += parseFloat(r.avgSelectivity) || 0;
            strategyStats[strategyKey].count++;

            // 모델별
            const modelKey = r.mlModel || 'Unknown';
            if (!modelStats[modelKey]) {
                modelStats[modelKey] = { results: [], totalReturn: 0, totalTrades: 0, wins: 0, count: 0 };
            }
            modelStats[modelKey].results.push(r);
            modelStats[modelKey].totalReturn += parseFloat(r.totalReturnPct) || 0;
            modelStats[modelKey].totalTrades += r.totalTrades || 0;
            modelStats[modelKey].wins += r.takeProfitExits || 0;
            modelStats[modelKey].count++;

            // 타임프레임별
            const tfKey = r.strategyTimeframe || '4h';
            if (!timeframeStats[tfKey]) {
                timeframeStats[tfKey] = { results: [], totalReturn: 0, totalTrades: 0, wins: 0, count: 0 };
            }
            timeframeStats[tfKey].results.push(r);
            timeframeStats[tfKey].totalReturn += parseFloat(r.totalReturnPct) || 0;
            timeframeStats[tfKey].totalTrades += r.totalTrades || 0;
            timeframeStats[tfKey].wins += r.takeProfitExits || 0;
            timeframeStats[tfKey].count++;

            // 전략 타입별
            const typeKey = r.strategyType || 'Unknown';
            if (!strategyTypeStats[typeKey]) {
                strategyTypeStats[typeKey] = { results: [], totalReturn: 0, totalTrades: 0, wins: 0, count: 0 };
            }
            strategyTypeStats[typeKey].results.push(r);
            strategyTypeStats[typeKey].totalReturn += parseFloat(r.totalReturnPct) || 0;
            strategyTypeStats[typeKey].totalTrades += r.totalTrades || 0;
            strategyTypeStats[typeKey].wins += r.takeProfitExits || 0;
            strategyTypeStats[typeKey].count++;
        });

        let html = `
            <!-- CUSUM 요약 정보 -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card text-center" style="border-left: 4px solid #A3B087;">
                        <div class="card-body">
                            <h6 class="text-muted"><i class="fas fa-chart-line me-1"></i>총 결과</h6>
                            <h3 class="mb-0">${cusumResults.length}건</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center" style="border-left: 4px solid #6C91BF;">
                        <div class="card-body">
                            <h6 class="text-muted"><i class="fas fa-exchange-alt me-1"></i>총 거래 수</h6>
                            <h3 class="mb-0">${cusumResults.reduce((sum, r) => sum + (r.totalTrades || 0), 0)}회</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center" style="border-left: 4px solid #A3B087;">
                        <div class="card-body">
                            <h6 class="text-muted"><i class="fas fa-brain me-1"></i>평균 확신도</h6>
                            <h3 class="mb-0">${(cusumResults.reduce((sum, r) => sum + (parseFloat(r.avgConfidence) || 0), 0) / cusumResults.length * 100).toFixed(1)}%</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center" style="border-left: 4px solid #E07856;">
                        <div class="card-body">
                            <h6 class="text-muted"><i class="fas fa-filter me-1"></i>평균 선별율</h6>
                            <h3 class="mb-0">${(cusumResults.reduce((sum, r) => sum + (parseFloat(r.avgSelectivity) || 0), 0) / cusumResults.length).toFixed(1)}%</h3>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ML 모델별 성과 비교 -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header" style="background-color: #435663; color: #FFFFFF;">
                            <i class="fas fa-robot me-2"></i>ML 모델별 성과 비교
                        </div>
                        <div class="card-body">
                            <canvas id="cusumModelChart" style="max-height: 250px;"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header" style="background-color: #435663; color: #FFFFFF;">
                            <i class="fas fa-clock me-2"></i>타임프레임별 성과 비교
                        </div>
                        <div class="card-body">
                            <canvas id="cusumTimeframeChart" style="max-height: 250px;"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 전략 타입별 성과 테이블 -->
            <div class="card mb-4">
                <div class="card-header" style="background-color: #A3B087; color: #FFFFFF;">
                    <i class="fas fa-chess-knight me-2"></i>전략 타입별 성과 비교 (Scalp / Balanced / Classic / Trend / Jackpot)
                </div>
                <div class="card-body">
                    <table class="table table-striped result-table">
                        <thead><tr>
                            <th>전략 타입</th>
                            <th>결과 수</th>
                            <th>총 거래</th>
                            <th>평균 수익률</th>
                            <th>승률</th>
                        </tr></thead>
                        <tbody>
        `;

        // 전략 타입별 테이블 행
        const strategyTypeOrder = ['Scalp', 'Balanced', 'Classic', 'Trend', 'Jackpot'];
        strategyTypeOrder.forEach(type => {
            const stats = strategyTypeStats[type];
            if (stats) {
                const avgReturn = stats.count > 0 ? stats.totalReturn / stats.count : 0;
                const winRate = stats.totalTrades > 0 ? (stats.wins / stats.totalTrades) * 100 : 0;
                html += `
                    <tr>
                        <td class="fw-bold">${type}</td>
                        <td>${stats.count}</td>
                        <td>${stats.totalTrades}</td>
                        <td class="${avgReturn >= 0 ? 'text-success' : 'text-danger'} fw-bold">${avgReturn.toFixed(2)}%</td>
                        <td>${winRate.toFixed(1)}%</td>
                    </tr>
                `;
            }
        });

        html += `
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ML 모델별 상세 테이블 -->
            <div class="card mb-4">
                <div class="card-header" style="background-color: #6C91BF; color: #FFFFFF;">
                    <i class="fas fa-brain me-2"></i>ML 모델별 상세 성과 (LGBM / XGB / CAT / ET)
                </div>
                <div class="card-body">
                    <table class="table table-striped result-table">
                        <thead><tr>
                            <th>ML 모델</th>
                            <th>결과 수</th>
                            <th>총 거래</th>
                            <th>평균 수익률</th>
                            <th>승률</th>
                            <th>총 수익률</th>
                        </tr></thead>
                        <tbody>
        `;

        // ML 모델별 테이블 행
        Object.entries(modelStats).sort((a, b) => b[1].totalReturn - a[1].totalReturn).forEach(([model, stats]) => {
            const avgReturn = stats.count > 0 ? stats.totalReturn / stats.count : 0;
            const winRate = stats.totalTrades > 0 ? (stats.wins / stats.totalTrades) * 100 : 0;
            html += `
                <tr>
                    <td class="fw-bold"><span class="badge bg-primary">${model}</span></td>
                    <td>${stats.count}</td>
                    <td>${stats.totalTrades}</td>
                    <td class="${avgReturn >= 0 ? 'text-success' : 'text-danger'} fw-bold">${avgReturn.toFixed(2)}%</td>
                    <td>${winRate.toFixed(1)}%</td>
                    <td class="${stats.totalReturn >= 0 ? 'text-success' : 'text-danger'} fw-bold">${stats.totalReturn.toFixed(2)}%</td>
                </tr>
            `;
        });

        html += `
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- CUSUM 상세 결과 테이블 -->
            <div class="card">
                <div class="card-header" style="background-color: var(--accent-dark); color: #FFFFFF;">
                    <i class="fas fa-list me-2"></i>CUSUM 상세 결과 (확신도, 투자 비중, 선별율 포함)
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover result-table" style="font-size: 0.85rem;">
                            <thead><tr>
                                <th>전략</th>
                                <th>모델</th>
                                <th>Fold</th>
                                <th>타임프레임</th>
                                <th>수익률</th>
                                <th>거래 수</th>
                                <th>승률</th>
                                <th>평균 확신도</th>
                                <th>투자 비중</th>
                                <th>CUSUM 선별율</th>
                                <th>MDD</th>
                            </tr></thead>
                            <tbody>
        `;

        // CUSUM 상세 결과 테이블
        cusumResults.sort((a, b) => (parseFloat(b.totalReturnPct) || 0) - (parseFloat(a.totalReturnPct) || 0)).forEach(r => {
            const confidence = r.avgConfidence ? (parseFloat(r.avgConfidence) * 100).toFixed(1) : '-';
            const investRatio = r.avgInvestmentRatio ? (parseFloat(r.avgInvestmentRatio) * 100).toFixed(0) : '-';
            const selectivity = r.avgSelectivity ? parseFloat(r.avgSelectivity).toFixed(1) : '-';

            html += `
                <tr>
                    <td class="fw-bold">${r.strategy || '-'}</td>
                    <td><span class="badge bg-secondary">${r.mlModel || '-'}</span></td>
                    <td>Fold ${r.foldNumber || '-'}</td>
                    <td><span class="badge" style="background-color: #6C91BF;">${r.strategyTimeframe || '-'}</span></td>
                    <td class="${parseFloat(r.totalReturnPct) >= 0 ? 'text-success' : 'text-danger'} fw-bold">${parseFloat(r.totalReturnPct).toFixed(2)}%</td>
                    <td>${r.totalTrades || 0}</td>
                    <td>${parseFloat(r.winRate).toFixed(1)}%</td>
                    <td><span class="badge" style="background-color: #A3B087;">${confidence}%</span></td>
                    <td>${investRatio}%</td>
                    <td><span class="badge" style="background-color: #E07856;">${selectivity}%</span></td>
                    <td>${parseFloat(r.maxDrawdown).toFixed(1)}%</td>
                </tr>
            `;
        });

        html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;

        content.innerHTML = html;

        // 차트 생성
        setTimeout(() => {
            // ML 모델별 차트
            const modelLabels = Object.keys(modelStats);
            const modelReturns = modelLabels.map(m => modelStats[m].count > 0 ? modelStats[m].totalReturn / modelStats[m].count : 0);
            const modelColors = modelLabels.map(m => {
                const avgRet = modelStats[m].count > 0 ? modelStats[m].totalReturn / modelStats[m].count : 0;
                return avgRet >= 0 ? '#A3B087' : '#E07856';
            });

            new Chart(document.getElementById('cusumModelChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: modelLabels,
                    datasets: [{
                        label: '평균 수익률 (%)',
                        data: modelReturns,
                        backgroundColor: modelColors,
                        borderColor: modelColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: '평균 수익률 (%)' } }
                    }
                }
            });

            // 타임프레임별 차트
            const tfOrder = ['4h', '12h', '24h', '48h'];
            const tfLabels = tfOrder.filter(tf => timeframeStats[tf]);
            const tfReturns = tfLabels.map(tf => timeframeStats[tf].count > 0 ? timeframeStats[tf].totalReturn / timeframeStats[tf].count : 0);
            const tfColors = tfReturns.map(r => r >= 0 ? '#6C91BF' : '#E07856');

            new Chart(document.getElementById('cusumTimeframeChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: tfLabels,
                    datasets: [{
                        label: '평균 수익률 (%)',
                        data: tfReturns,
                        backgroundColor: tfColors,
                        borderColor: tfColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: '평균 수익률 (%)' } }
                    }
                }
            });
        }, 100);
    }

    function loadCusumData() {
        const btn = document.getElementById('btnCusum');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 로딩 중... (CSV 파싱)';

        showToast('CUSUM 신호 데이터 로드를 시작합니다. 데이터 크기에 따라 시간이 소요될 수 있습니다.', true);

        fetch('/api/backtest/cusum/load', { method: 'POST' })
            .then(r => {
                if (!r.ok) throw new Error('CUSUM 데이터 로드 실패');
                return r.json();
            })
            .then(data => {
                // API 응답 형식: loadedSignals (not signalCount)
                const count = data.loadedSignals || 0;
                showToast(`CUSUM 데이터 로드 완료! ${count.toLocaleString()}건 적재됨`, true);
                checkCusumStatus();
            })
            .catch(e => {
                console.error(e);
                showToast('CUSUM 데이터 로드 중 오류가 발생했습니다. CSV 파일을 확인해주세요.', false);
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-download me-1"></i> CUSUM 데이터 로드';
            });
    }

    async function runCusumBacktest() {
        if (!cusumDataLoaded) {
            showToast('먼저 CUSUM 데이터를 로드해주세요.', false);
            return;
        }

        const strategy = document.getElementById('cusumStrategy').value;
        const model = document.getElementById('cusumModel').value;
        const fold = document.getElementById('cusumFold').value;
        const initialCapital = parseFloat(document.getElementById('cusumInitialCapital').value) || 10000000;

        // 요청 파라미터 구성 (백엔드 CusumBatchRequest 형식에 맞춤)
        const requestBody = {
            initialCapital: initialCapital
        };
        // 백엔드는 List를 기대하므로 단일 값을 배열로 감싸서 전송
        if (strategy) requestBody.strategies = [strategy];
        if (model) requestBody.models = [model];
        if (fold) requestBody.foldNumbers = [parseInt(fold)];

        // 스피너 표시
        document.getElementById('spinnerOverlay').classList.add('active');
        document.getElementById('spinnerMessage').textContent = 'CUSUM 백테스팅 실행 중...';

        // 로그 초기화 및 진행 섹션 표시
        document.getElementById('progressSection').style.display = 'block';
        document.getElementById('resultsSection').style.display = 'none';
        const logs = document.getElementById('progressLogs');
        logs.innerHTML = '';
        addLog(`CUSUM 백테스팅 시작 - 전략: ${strategy || '전체'}, 모델: ${model || '전체'}, Fold: ${fold || '전체'}`);

        try {
            // 배치 실행 (여러 조합)
            const response = await fetch('/api/backtest/cusum/run-batch', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                throw new Error('CUSUM 백테스팅 실행 실패');
            }

            const results = await response.json();
            addLog(`CUSUM 백테스팅 완료! ${results.length}건의 결과`);

            // 결과를 기존 backtestResults에 추가 (CUSUM 태그 추가)
            // 백엔드 Response 필드: strategy, mlModel, foldNumber, strategyTimeframe, strategyType 등
            const cusumResults = results.map(r => ({
                ...r,
                modelName: `[CUSUM] ${r.strategy || ''} - ${r.mlModel || ''}`,
                foldNumber: r.foldNumber || 0,
                regime: 'CUSUM',
                // 기본값 설정 (API 응답에 없는 경우)
                takeProfitExits: r.takeProfitExits || 0,
                stopLossExits: r.stopLossExits || 0,
                timeoutExits: r.timeoutExits || 0,
                tradeHistory: r.tradeHistory || []
            }));

            // 기존 결과에 CUSUM 결과 추가
            backtestResults = [...backtestResults.filter(r => !r.modelName.startsWith('[CUSUM]')), ...cusumResults];

            displayResults();
            showToast(`CUSUM 백테스팅 완료! ${results.length}건 결과`, true);

        } catch (e) {
            console.error(e);
            addLog(`오류 발생: ${e.message}`);
            showToast('CUSUM 백테스팅 중 오류가 발생했습니다.', false);
        } finally {
            document.getElementById('spinnerOverlay').classList.remove('active');
        }
    }
</script>
</body>
</html>
