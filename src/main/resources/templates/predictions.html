<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>데이터 확인</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --bg-main: #FFFFFF; --text-main: #313647; --nav-bg: #313647; --accent-green: #A3B087; }
        body { background-color: var(--bg-main); color: var(--text-main); font-family: 'Segoe UI', sans-serif; }

        /* Sub Header */
        .navbar { background-color: var(--nav-bg); padding: 0.8rem 0; }
        .btn-back { color: #FFFFFF; font-weight: 600; text-decoration: none; }
        .btn-back:hover { color: var(--accent-green); }

        .card { border: 1px solid #e0e0e0; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); background: #FFFFFF; margin-bottom: 20px; }
        .card-header { background-color: var(--text-main); color: #FFFFFF; border-radius: 12px 12px 0 0 !important; font-weight: 600; padding: 1rem 1.5rem; }

        .stat-val { font-size: 1.5rem; font-weight: 800; color: var(--text-main); }
        .btn-primary { background-color: var(--text-main); border: none; }
        .table thead th { background-color: #f8f9fa; border-bottom: 2px solid var(--text-main); }
    </style>
</head>
<body>
<nav class="navbar sticky-top">
    <div class="container-fluid px-4">
        <a class="btn-back" href="/backtest"><i class="fas fa-chevron-left me-2"></i>백테스팅 페이지로 이동</a>
    </div>
</nav>

<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1100; margin-top: 60px;">
    <div id="predToast" class="toast" role="alert">
        <div class="toast-header">
            <i id="toastIcon" class="fas fa-info-circle me-2"></i>
            <strong class="me-auto" id="toastTitle">알림</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="toastMessage"></div>
    </div>
</div>

<div class="container py-4">
    <h4 class="fw-bold mb-4 text-dark"><i class="fas fa-table me-2"></i>적재 데이터 조회</h4>

    <div class="row g-3 mb-4 text-center">
        <div class="col-md-3"><div class="card py-3 h-100"><div class="text-muted small">총 데이터</div><div class="stat-val" id="totalCount">-</div></div></div>
        <div class="col-md-3"><div class="card py-3 h-100"><div class="text-muted small">정확도</div><div class="stat-val text-success" id="accuracy">-</div></div></div>
        <div class="col-md-3"><div class="card py-3 h-100"><div class="text-muted small">평균 확신도</div><div class="stat-val" id="avgConfidence">-</div></div></div>
        <div class="col-md-3"><div class="card py-3 h-100"><div class="text-muted small">평균 수익률</div><div class="stat-val" id="avgReturn">-</div></div></div>
    </div>

    <div class="card">
        <div class="card-body">
            <div class="row g-2 align-items-end">
                <div class="col-md-4">
                    <label class="form-label fw-bold small">모델 선택</label>
                    <select class="form-select" id="modelFilter">
                        <option value="">전체 모델</option>
                        <option value="GRU">GRU</option>
                        <option value="LSTM">LSTM</option>
                        <option value="BiLSTM">BiLSTM</option>
                        <option value="XGBoost">XGBoost</option>
                        <option value="LightGBM">LightGBM</option>
                        <option value="CatBoost">CatBoost</option>
                        <option value="AdaBoost">AdaBoost</option>
                        <option value="RandomForest">RandomForest</option>
                        <option value="GradientBoosting">GradientBoosting</option>
                        <option value="HistGradientBoosting">HistGradientBoosting</option>
                        <option value="LogisticRegression">LogisticRegression</option>
                        <option value="StackingEnsemble">StackingEnsemble</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label fw-bold small">Fold 선택</label>
                    <select class="form-select" id="foldFilter">
                        <option value="">전체 Fold</option>
                        <option value="1">Fold 1</option>
                        <option value="2">Fold 2</option>
                        <option value="3">Fold 3</option>
                        <option value="4">Fold 4</option>
                        <option value="5">Fold 5</option>
                        <option value="6">Fold 6</option>
                        <option value="7">Fold 7</option>
                        <option value="8">Fold 8 (Test)</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <button class="btn btn-primary w-100" onclick="loadPredictions()">조회하기</button>
                </div>
            </div>
        </div>
    </div>

    <div id="loading" class="text-center py-5" style="display:none;"><i class="fas fa-spinner fa-spin fa-2x text-secondary"></i></div>

    <div class="card border-0 shadow-none">
        <div class="table-responsive">
            <table class="table table-hover align-middle" id="predictionsTable" style="display:none;">
                <thead>
                <tr>
                    <th>날짜</th>
                    <th>모델</th>
                    <th>Fold</th>
                    <th>예측</th>
                    <th>정보</th>
                    <th>결과</th>
                    <th>수익률</th>
                </tr>
                </thead>
                <tbody id="predictionsBody"></tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', loadPredictions);

    // 토스트 함수 추가
    function showToast(msg, isSuccess = true) {
        const t = document.getElementById('predToast');
        document.getElementById('toastMessage').textContent = msg;
        const icon = document.getElementById('toastIcon');
        if (isSuccess) {
            icon.className = "fas fa-check-circle me-2 text-success";
            document.getElementById('toastTitle').innerText = "성공";
        } else {
            icon.className = "fas fa-exclamation-circle me-2 text-danger";
            document.getElementById('toastTitle').innerText = "오류";
        }
        new bootstrap.Toast(t, { delay: 3000 }).show();
    }

    function loadPredictions() {
        const m=document.getElementById('modelFilter').value, f=document.getElementById('foldFilter').value;
        let u='/api/v1/data/predictions?'; if(m)u+=`modelName=${m}&`; if(f)u+=`foldNumber=${f}&`;
        document.getElementById('loading').style.display='block'; document.getElementById('predictionsTable').style.display='none';

        fetch(u).then(r=>r.json()).then(d=>{
            if(!Array.isArray(d))d=[];
            display(d);
            stats(d);
            document.getElementById('loading').style.display='none';
            document.getElementById('predictionsTable').style.display='table';
        }).catch(e=>{
            console.error(e);
            document.getElementById('loading').style.display='none';
            showToast('데이터 로드에 실패했습니다.', false); // Alert 제거 및 Toast 적용
        });
    }
    function display(d) {
        const b=document.getElementById('predictionsBody'); b.innerHTML='';
        if(!d.length){ b.innerHTML='<tr><td colspan="7" class="text-center py-4">데이터 없음</td></tr>'; return; }
        d.forEach(i=>{
            const r=document.createElement('tr');
            const pBad = i.predDirection===1?'<span class="badge" style="background:#A3B087">상승</span>':'<span class="badge bg-secondary">하락</span>';
            const cor = i.correct===1?'<span class="text-success fw-bold">적중</span>':'<span class="text-muted">실패</span>';
            r.innerHTML=`<td>${i.predictionDate}</td><td><span class="badge bg-dark">${i.modelName}</span></td><td>${i.foldNumber}</td><td>${pBad}</td><td><small class="text-muted">Prob: ${(i.predProbaUp*100).toFixed(0)}%</small></td><td>${cor}</td><td>${(i.actualReturn*100).toFixed(2)}%</td>`;
            b.appendChild(r);
        });
    }
    function stats(d) {
        if(!d.length)return;
        document.getElementById('totalCount').textContent=d.length.toLocaleString();
        document.getElementById('accuracy').textContent=((d.filter(i=>i.correct===1).length/d.length)*100).toFixed(1)+'%';
        document.getElementById('avgConfidence').textContent=(d.reduce((a,b)=>a+b.confidence,0)/d.length).toFixed(3);
        document.getElementById('avgReturn').textContent=(d.reduce((a,b)=>a+b.actualReturn,0)/d.length*100).toFixed(2)+'%';
    }
</script>
</body>
</html>