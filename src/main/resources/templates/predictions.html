<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 예측 데이터 조회 - CoinReaders Engine</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px 0;
        }

        .container {
            max-width: 1400px;
        }

        .card {
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            padding: 20px;
        }

        .filter-section {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .table-container {
            max-height: 600px;
            overflow-y: auto;
        }

        .table {
            font-size: 0.9rem;
        }

        .table thead {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: #343a40;
            color: white;
        }

        .badge-up {
            background-color: #28a745;
        }

        .badge-down {
            background-color: #dc3545;
        }

        .badge-correct {
            background-color: #17a2b8;
        }

        .badge-wrong {
            background-color: #6c757d;
        }

        .confidence-high {
            color: #28a745;
            font-weight: bold;
        }

        .confidence-medium {
            color: #ffc107;
            font-weight: bold;
        }

        .confidence-low {
            color: #dc3545;
            font-weight: bold;
        }

        .btn-back {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .stats-card {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-bottom: 10px;
        }

        .stats-card h3 {
            margin: 0;
            font-size: 2rem;
        }

        .stats-card p {
            margin: 0;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 헤더 -->
        <div class="card">
            <div class="card-header">
                <h3 class="mb-0">
                    <i class="fas fa-chart-line"></i> AI 예측 데이터 조회
                </h3>
            </div>
            <div class="card-body">
                <!-- 통계 -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="stats-card">
                            <h3 id="totalCount">0</h3>
                            <p>총 데이터</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card">
                            <h3 id="accuracy">0%</h3>
                            <p>평균 정확도</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card">
                            <h3 id="avgConfidence">0</h3>
                            <p>평균 신뢰도</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card">
                            <h3 id="avgReturn">0%</h3>
                            <p>평균 수익률</p>
                        </div>
                    </div>
                </div>

                <!-- 필터 -->
                <div class="filter-section">
                    <div class="row">
                        <div class="col-md-4">
                            <label class="form-label">
                                <i class="fas fa-robot"></i> 모델 선택
                            </label>
                            <select class="form-select" id="modelFilter">
                                <option value="">전체 모델</option>
                                <option value="XGBoost">XGBoost (80.9%)</option>
                                <option value="AdaBoost">AdaBoost (80.5%)</option>
                                <option value="CatBoost">CatBoost (80.5%)</option>
                                <option value="HistGradientBoosting">HistGradientBoosting (79.7%)</option>
                                <option value="LightGBM">LightGBM (79.3%)</option>
                                <option value="StackingEnsemble">StackingEnsemble (80.5%)</option>
                                <option value="GradientBoosting">GradientBoosting (76.3%)</option>
                                <option value="RandomForest">RandomForest (71.8%)</option>
                                <option value="GRU">GRU (66.8%)</option>
                                <option value="BiLSTM">BiLSTM (65.9%)</option>
                                <option value="LogisticRegression">LogisticRegression (63.5%)</option>
                                <option value="LSTM">LSTM (57.3%)</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">
                                <i class="fas fa-layer-group"></i> Fold 선택
                            </label>
                            <select class="form-select" id="foldFilter">
                                <option value="">전체 Fold</option>
                                <option value="1">Fold 1 (Training)</option>
                                <option value="2">Fold 2 (Training)</option>
                                <option value="3">Fold 3 (Training)</option>
                                <option value="4">Fold 4 (Training)</option>
                                <option value="5">Fold 5 (Training)</option>
                                <option value="6">Fold 6 (Training)</option>
                                <option value="7">Fold 7 (Training)</option>
                                <option value="8">Fold 8 (Test - Final Holdout)</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">&nbsp;</label>
                            <button class="btn btn-primary w-100" onclick="loadPredictions()">
                                <i class="fas fa-search"></i> 조회
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 데이터 테이블 -->
                <div class="table-container">
                    <div id="loading" class="loading" style="display: none;">
                        <i class="fas fa-spinner fa-spin fa-3x text-primary"></i>
                        <p class="mt-3">데이터 로딩 중...</p>
                    </div>

                    <table class="table table-striped table-hover" id="predictionsTable" style="display: none;">
                        <thead>
                            <tr>
                                <th>날짜</th>
                                <th>모델</th>
                                <th>Fold</th>
                                <th>예측 방향</th>
                                <th>실제 방향</th>
                                <th>예측 확률</th>
                                <th>신뢰도</th>
                                <th>정확도</th>
                                <th>실제 수익률</th>
                                <th>익절가</th>
                                <th>손절가</th>
                            </tr>
                        </thead>
                        <tbody id="predictionsBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 뒤로가기 버튼 -->
    <a href="/" class="btn btn-primary btn-lg btn-back">
        <i class="fas fa-arrow-left"></i> 메인으로
    </a>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 페이지 로드 시 자동 조회
        document.addEventListener('DOMContentLoaded', function() {
            loadPredictions();
        });

        // 데이터 로드 함수
        function loadPredictions() {
            const model = document.getElementById('modelFilter').value;
            const fold = document.getElementById('foldFilter').value;

            // 로딩 표시
            document.getElementById('loading').style.display = 'block';
            document.getElementById('predictionsTable').style.display = 'none';

            // API 호출
            let url = '/api/v1/data/predictions?';
            if (model) url += `modelName=${model}&`;
            if (fold) url += `foldNumber=${fold}&`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    displayPredictions(data);
                    calculateStats(data);
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('predictionsTable').style.display = 'table';
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('loading').style.display = 'none';
                    alert('데이터 로딩 실패: ' + error.message);
                });
        }

        // 통계 계산
        function calculateStats(data) {
            if (data.length === 0) {
                document.getElementById('totalCount').textContent = '0';
                document.getElementById('accuracy').textContent = '0%';
                document.getElementById('avgConfidence').textContent = '0';
                document.getElementById('avgReturn').textContent = '0%';
                return;
            }

            const totalCount = data.length;
            const correctCount = data.filter(d => d.correct === 1).length;
            const accuracy = ((correctCount / totalCount) * 100).toFixed(1);
            const avgConfidence = (data.reduce((sum, d) => sum + d.confidence, 0) / totalCount).toFixed(3);
            const avgReturn = ((data.reduce((sum, d) => sum + d.actualReturn, 0) / totalCount) * 100).toFixed(2);

            document.getElementById('totalCount').textContent = totalCount.toLocaleString();
            document.getElementById('accuracy').textContent = accuracy + '%';
            document.getElementById('avgConfidence').textContent = avgConfidence;
            document.getElementById('avgReturn').textContent = avgReturn + '%';
        }

        // 테이블 렌더링
        function displayPredictions(data) {
            const tbody = document.getElementById('predictionsBody');
            tbody.innerHTML = '';

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11" class="text-center">데이터가 없습니다.</td></tr>';
                return;
            }

            data.forEach(pred => {
                const row = document.createElement('tr');

                // 신뢰도 색상
                let confidenceClass = 'confidence-low';
                if (pred.confidence >= 0.15) confidenceClass = 'confidence-high';
                else if (pred.confidence >= 0.08) confidenceClass = 'confidence-medium';

                row.innerHTML = `
                    <td>${pred.predictionDate}</td>
                    <td><span class="badge bg-info">${pred.modelName}</span></td>
                    <td>Fold ${pred.foldNumber}</td>
                    <td><span class="badge ${pred.predDirection === 1 ? 'badge-up' : 'badge-down'}">
                        ${pred.predDirection === 1 ? '↑ 상승' : '↓ 하락'}
                    </span></td>
                    <td><span class="badge ${pred.actualDirection === 1 ? 'badge-up' : 'badge-down'}">
                        ${pred.actualDirection === 1 ? '↑ 상승' : '↓ 하락'}
                    </span></td>
                    <td>
                        <small>UP: ${(pred.predProbaUp * 100).toFixed(1)}%</small><br>
                        <small>DN: ${(pred.predProbaDown * 100).toFixed(1)}%</small>
                    </td>
                    <td class="${confidenceClass}">${pred.confidence.toFixed(3)}</td>
                    <td><span class="badge ${pred.correct === 1 ? 'badge-correct' : 'badge-wrong'}">
                        ${pred.correct === 1 ? '✓ 맞음' : '✗ 틀림'}
                    </span></td>
                    <td class="${pred.actualReturn >= 0 ? 'text-success' : 'text-danger'}">
                        ${(pred.actualReturn * 100).toFixed(2)}%
                    </td>
                    <td><small>${pred.takeProfitPrice ? pred.takeProfitPrice.toLocaleString() + '원' : '-'}</small></td>
                    <td><small>${pred.stopLossPrice ? pred.stopLossPrice.toLocaleString() + '원' : '-'}</small></td>
                `;

                tbody.appendChild(row);
            });
        }
    </script>
</body>
</html>
