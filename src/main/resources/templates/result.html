<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backtest Result - Fold [[${foldNumber}]]</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: #f5f7fa;
            padding: 2rem 0;
        }
        .result-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 15px 15px 0 0;
            margin-bottom: 0;
        }
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
            transition: transform 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }
        .stat-card.winner {
            border: 3px solid #28a745;
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        }
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin: 0.5rem 0;
        }
        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .positive {
            color: #28a745;
        }
        .negative {
            color: #dc3545;
        }
        .badge-regime {
            font-size: 0.9rem;
            padding: 0.5rem 1rem;
        }
        .chart-container {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        .back-button {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            padding: 0.75rem 2rem;
            font-weight: bold;
        }
        .back-button:hover {
            background: #667eea;
            color: white;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid #dee2e6;
        }
        .info-row:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="result-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1><i class="fas fa-chart-bar"></i> Backtest Result</h1>
                    <p class="mb-0">Fold [[${foldNumber}]] | [[${result.regime}]] Market</p>
                </div>
                <span th:class="${'badge ' + (result.regime == 'BULL' ? 'bg-success' : (result.regime == 'BEAR' ? 'bg-danger' : 'bg-info'))} + ' badge-regime'">
                    [[${result.regime}]]
                </span>
            </div>
            <div class="mt-3">
                <small><i class="fas fa-calendar-alt"></i> [[${result.startDate}]] ~ [[${result.endDate}]]</small>
            </div>
        </div>

        <!-- Winner Banner -->
        <div th:if="${result.winner == 'KELLY'}" class="alert alert-success text-center mb-4" style="border-radius: 0 0 15px 15px;">
            <h4><i class="fas fa-trophy"></i> Kelly Strategy Wins! (+[[${#numbers.formatDecimal(result.alpha, 1, 2)}]]% Alpha)</h4>
        </div>
        <div th:if="${result.winner != 'KELLY'}" class="alert alert-warning text-center mb-4" style="border-radius: 0 0 15px 15px;">
            <h4><i class="fas fa-info-circle"></i> Buy & Hold Wins! ([[${#numbers.formatDecimal(result.alpha, 1, 2)}]]% Alpha)</h4>
        </div>

        <!-- Summary Cards -->
        <div class="row">
            <!-- Kelly Strategy -->
            <div class="col-md-6">
                <div th:class="${result.winner == 'KELLY' ? 'stat-card winner' : 'stat-card'}">
                    <h5><i class="fas fa-brain"></i> Kelly Strategy
                        <span th:if="${positionSizePercent != null}" class="badge bg-info">[[${positionSizePercent}]]% Fixed</span>
                        <span th:if="${positionSizePercent == null}" class="badge bg-primary">Auto Kelly</span>
                    </h5>
                    <div class="row mt-3">
                        <div class="col-6">
                            <div class="stat-label">Total Return</div>
                            <div th:class="${result.kellyStrategy.totalReturnPct >= 0 ? 'stat-value positive' : 'stat-value negative'}">
                                [[${#numbers.formatDecimal(result.kellyStrategy.totalReturnPct, 1, 2)}]]%
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stat-label">Final Capital</div>
                            <div class="stat-value">
                                ₩[[${#numbers.formatDecimal(result.kellyStrategy.finalCapital, 1, 0)}]]
                            </div>
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-4">
                            <div class="stat-label">Win Rate</div>
                            <div class="stat-value" style="font-size: 1.3rem;">
                                [[${#numbers.formatDecimal(result.kellyStrategy.winRate, 1, 1)}]]%
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="stat-label">Trades</div>
                            <div class="stat-value" style="font-size: 1.3rem;">
                                [[${result.kellyStrategy.totalTrades}]]
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="stat-label">Max DD</div>
                            <div class="stat-value negative" style="font-size: 1.3rem;">
                                [[${#numbers.formatDecimal(result.kellyStrategy.maxDrawdown, 1, 2)}]]%
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Buy & Hold -->
            <div class="col-md-6">
                <div th:class="${result.winner == 'BUY_AND_HOLD' ? 'stat-card winner' : 'stat-card'}">
                    <h5><i class="fas fa-hand-holding-usd"></i> Buy & Hold Strategy</h5>
                    <div class="row mt-3">
                        <div class="col-6">
                            <div class="stat-label">Total Return</div>
                            <div th:class="${result.buyHoldStrategy.totalReturnPct >= 0 ? 'stat-value positive' : 'stat-value negative'}">
                                [[${#numbers.formatDecimal(result.buyHoldStrategy.totalReturnPct, 1, 2)}]]%
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stat-label">Final Capital</div>
                            <div class="stat-value">
                                ₩[[${#numbers.formatDecimal(result.buyHoldStrategy.finalCapital, 1, 0)}]]
                            </div>
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-4">
                            <div class="stat-label">Entry Price</div>
                            <div class="stat-value" style="font-size: 1.3rem;">
                                ₩[[${#numbers.formatDecimal(result.buyHoldStrategy.entryPrice, 1, 0)}]]
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="stat-label">Exit Price</div>
                            <div class="stat-value" style="font-size: 1.3rem;">
                                ₩[[${#numbers.formatDecimal(result.buyHoldStrategy.exitPrice, 1, 0)}]]
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="stat-label">Max DD</div>
                            <div class="stat-value negative" style="font-size: 1.3rem;">
                                [[${#numbers.formatDecimal(result.buyHoldStrategy.maxDrawdown, 1, 2)}]]%
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Comparison Chart -->
        <div class="chart-container">
            <h5><i class="fas fa-chart-line"></i> Return Comparison</h5>
            <canvas id="comparisonChart"></canvas>
        </div>

        <!-- Detailed Stats -->
        <div class="row">
            <div class="col-md-6">
                <div class="stat-card">
                    <h5><i class="fas fa-info-circle"></i> Kelly Strategy Details</h5>
                    <div class="info-row">
                        <span>Position Size (Kelly Fraction)</span>
                        <strong>[[${#numbers.formatDecimal(result.kellyStrategy.kellyFraction, 1, 2)}]]%</strong>
                    </div>
                    <div class="info-row">
                        <span>Win Trades</span>
                        <strong class="positive">[[${result.kellyStrategy.winTrades}]]</strong>
                    </div>
                    <div class="info-row">
                        <span>Loss Trades</span>
                        <strong class="negative">[[${result.kellyStrategy.lossTrades}]]</strong>
                    </div>
                    <div class="info-row">
                        <span>Average Win</span>
                        <strong class="positive">[[${#numbers.formatDecimal(result.kellyStrategy.avgWin, 1, 2)}]]%</strong>
                    </div>
                    <div class="info-row">
                        <span>Average Loss</span>
                        <strong class="negative">[[${#numbers.formatDecimal(result.kellyStrategy.avgLoss, 1, 2)}]]%</strong>
                    </div>
                    <div class="info-row">
                        <span>Win/Loss Ratio</span>
                        <strong>[[${#numbers.formatDecimal(result.kellyStrategy.winLossRatio, 1, 2)}]]</strong>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="stat-card">
                    <h5><i class="fas fa-cog"></i> Backtest Parameters</h5>
                    <div class="info-row">
                        <span>Initial Capital</span>
                        <strong>₩[[${#numbers.formatDecimal(initialCapital, 1, 0)}]]</strong>
                    </div>
                    <div class="info-row">
                        <span>Confidence Threshold</span>
                        <strong>[[${confidenceThreshold}]]</strong>
                    </div>
                    <div class="info-row">
                        <span>Position Size</span>
                        <strong th:if="${positionSizePercent != null}">[[${positionSizePercent}]]% (Fixed)</strong>
                        <strong th:if="${positionSizePercent == null}">Kelly Criterion (Auto)</strong>
                    </div>
                    <div class="info-row">
                        <span>Market Regime</span>
                        <strong>[[${result.regime}]]</strong>
                    </div>
                    <div class="info-row">
                        <span>Period</span>
                        <strong>[[${result.startDate}]] ~ [[${result.endDate}]]</strong>
                    </div>
                    <div class="info-row">
                        <span>Alpha</span>
                        <strong th:class="${result.alpha >= 0 ? 'positive' : 'negative'}">
                            [[${#numbers.formatDecimal(result.alpha, 1, 2)}]]%
                        </strong>
                    </div>
                </div>
            </div>
        </div>

        <!-- Back Button -->
        <div class="text-center mt-4 mb-4">
            <a href="/" class="btn back-button">
                <i class="fas fa-arrow-left"></i> Back to Home
            </a>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.js"></script>
    <script th:inline="javascript">
        const ctx = document.getElementById('comparisonChart').getContext('2d');
        const kellyReturn = /*[[${result.kellyStrategy.totalReturnPct}]]*/ 0;
        const buyHoldReturn = /*[[${result.buyHoldStrategy.totalReturnPct}]]*/ 0;
        const initialCapital = /*[[${initialCapital}]]*/ 10000;

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Kelly Strategy', 'Buy & Hold'],
                datasets: [{
                    label: 'Total Return (%)',
                    data: [kellyReturn, buyHoldReturn],
                    backgroundColor: [
                        kellyReturn >= buyHoldReturn ? 'rgba(40, 167, 69, 0.8)' : 'rgba(255, 193, 7, 0.8)',
                        buyHoldReturn >= kellyReturn ? 'rgba(40, 167, 69, 0.8)' : 'rgba(255, 193, 7, 0.8)'
                    ],
                    borderColor: [
                        kellyReturn >= buyHoldReturn ? 'rgba(40, 167, 69, 1)' : 'rgba(255, 193, 7, 1)',
                        buyHoldReturn >= kellyReturn ? 'rgba(40, 167, 69, 1)' : 'rgba(255, 193, 7, 1)'
                    ],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    },
                    title: {
                        display: true,
                        text: 'Strategy Performance Comparison',
                        font: {
                            size: 16,
                            weight: 'bold'
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                label += context.parsed.y.toFixed(2) + '%';
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Return (%)'
                        }
                    }
                }
            }
        });
    </script>
</body>
</html>
