<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>백테스팅 결과 - Fold [[${foldNumber}]]</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .tooltip-inner {
            text-align: left;
            max-width: 350px;
        }
        body {
            background: #f5f7fa;
            padding: 2rem 0;
        }
        .result-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 15px 15px 0 0;
            margin-bottom: 0;
        }
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
            transition: transform 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }
        .stat-card.winner {
            border: 3px solid #28a745;
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        }
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin: 0.5rem 0;
        }
        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .positive {
            color: #28a745;
        }
        .negative {
            color: #dc3545;
        }
        .badge-regime {
            font-size: 0.9rem;
            padding: 0.5rem 1rem;
        }
        .chart-container {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        .back-button {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            padding: 0.75rem 2rem;
            font-weight: bold;
        }
        .back-button:hover {
            background: #667eea;
            color: white;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid #dee2e6;
        }
        .info-row:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="result-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1><i class="fas fa-chart-bar"></i> 백테스팅 결과</h1>
                    <p class="mb-0">Fold [[${foldNumber}]] | [[${result.regime}]] 시장</p>
                </div>
                <span th:class="${'badge ' + (result.regime == 'BULL' ? 'bg-success' : (result.regime == 'BEAR' ? 'bg-danger' : 'bg-info'))} + ' badge-regime'">
                    [[${result.regime}]]
                </span>
            </div>
            <div class="mt-3">
                <small><i class="fas fa-calendar-alt"></i> [[${result.startDate}]] ~ [[${result.endDate}]]</small>
            </div>
        </div>

        <!-- Winner Banner -->
        <div th:if="${result.winner == 'KELLY'}" class="alert alert-success text-center mb-4" style="border-radius: 0 0 15px 15px;">
            <h4><i class="fas fa-trophy"></i> 켈리 전략 승리! (+[[${#numbers.formatDecimal(result.alpha, 1, 2)}]]% 알파)</h4>
        </div>
        <div th:if="${result.winner != 'KELLY'}" class="alert alert-warning text-center mb-4" style="border-radius: 0 0 15px 15px;">
            <h4><i class="fas fa-info-circle"></i> 매수 후 보유 승리! ([[${#numbers.formatDecimal(result.alpha, 1, 2)}]]% 알파)</h4>
        </div>

        <!-- Summary Cards -->
        <div class="row">
            <!-- Kelly Strategy -->
            <div class="col-md-6">
                <div th:class="${result.winner == 'KELLY' ? 'stat-card winner' : 'stat-card'}">
                    <h5><i class="fas fa-brain"></i> 켈리 전략
                        <span th:if="${positionSizePercent != null}" class="badge bg-info">[[${positionSizePercent}]]% 고정</span>
                        <span th:if="${positionSizePercent == null}" class="badge bg-primary">자동 켈리</span>
                    </h5>
                    <div class="row mt-3">
                        <div class="col-6">
                            <div class="stat-label">총 수익률</div>
                            <div th:class="${result.kellyStrategy.totalReturnPct >= 0 ? 'stat-value positive' : 'stat-value negative'}">
                                [[${#numbers.formatDecimal(result.kellyStrategy.totalReturnPct, 1, 2)}]]%
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stat-label">최종 자산</div>
                            <div class="stat-value">
                                ₩[[${#numbers.formatDecimal(result.kellyStrategy.finalCapital, 1, 0)}]]
                            </div>
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-4">
                            <div class="stat-label">승률</div>
                            <div class="stat-value" style="font-size: 1.3rem;">
                                [[${#numbers.formatDecimal(result.kellyStrategy.winRate, 1, 1)}]]%
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="stat-label">거래 횟수</div>
                            <div class="stat-value" style="font-size: 1.3rem;">
                                [[${result.kellyStrategy.totalTrades}]]
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="stat-label"
                                 data-bs-toggle="tooltip"
                                 data-bs-placement="top"
                                 title="최대 낙폭(Maximum Drawdown): 투자 기간 중 자산이 최고점에서 최저점까지 떨어진 최대 폭입니다. 손실 위험의 크기를 나타냅니다.">
                                최대 낙폭 <i class="fas fa-info-circle text-muted" style="font-size: 0.7rem;"></i>
                            </div>
                            <div class="stat-value negative" style="font-size: 1.3rem;">
                                [[${#numbers.formatDecimal(result.kellyStrategy.maxDrawdown, 1, 2)}]]%
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Buy & Hold -->
            <div class="col-md-6">
                <div th:class="${result.winner == 'BUY_AND_HOLD' ? 'stat-card winner' : 'stat-card'}">
                    <h5><i class="fas fa-hand-holding-usd"></i> 매수 후 보유 전략</h5>
                    <div class="row mt-3">
                        <div class="col-6">
                            <div class="stat-label">총 수익률</div>
                            <div th:class="${result.buyHoldStrategy.totalReturnPct >= 0 ? 'stat-value positive' : 'stat-value negative'}">
                                [[${#numbers.formatDecimal(result.buyHoldStrategy.totalReturnPct, 1, 2)}]]%
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stat-label">최종 자산</div>
                            <div class="stat-value">
                                ₩[[${#numbers.formatDecimal(result.buyHoldStrategy.finalCapital, 1, 0)}]]
                            </div>
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-4">
                            <div class="stat-label">진입 가격</div>
                            <div class="stat-value" style="font-size: 1.3rem;">
                                ₩[[${#numbers.formatDecimal(result.buyHoldStrategy.entryPrice, 1, 0)}]]
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="stat-label">청산 가격</div>
                            <div class="stat-value" style="font-size: 1.3rem;">
                                ₩[[${#numbers.formatDecimal(result.buyHoldStrategy.exitPrice, 1, 0)}]]
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="stat-label"
                                 data-bs-toggle="tooltip"
                                 data-bs-placement="top"
                                 title="최대 낙폭(Maximum Drawdown): 투자 기간 중 자산이 최고점에서 최저점까지 떨어진 최대 폭입니다. 손실 위험의 크기를 나타냅니다.">
                                최대 낙폭 <i class="fas fa-info-circle text-muted" style="font-size: 0.7rem;"></i>
                            </div>
                            <div class="stat-value negative" style="font-size: 1.3rem;">
                                [[${#numbers.formatDecimal(result.buyHoldStrategy.maxDrawdown, 1, 2)}]]%
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Comparison Chart -->
        <div class="chart-container">
            <h5><i class="fas fa-chart-line"></i> 수익률 비교</h5>
            <canvas id="comparisonChart"></canvas>
        </div>

        <!-- Detailed Stats -->
        <div class="row">
            <div class="col-md-6">
                <div class="stat-card">
                    <h5><i class="fas fa-info-circle"></i> 켈리 전략 세부사항</h5>
                    <div class="info-row">
                        <span data-bs-toggle="tooltip"
                              data-bs-placement="left"
                              title="포지션 크기(켈리 비율): 승률과 평균 수익/손실을 바탕으로 계산된 최적의 투자 비중입니다. AI 예측의 확신도가 높을수록 더 큰 비중으로 투자합니다.">
                            포지션 크기 (켈리 비율) <i class="fas fa-info-circle text-muted" style="font-size: 0.7rem;"></i>
                        </span>
                        <strong>[[${#numbers.formatDecimal(result.kellyStrategy.kellyFraction, 1, 2)}]]%</strong>
                    </div>
                    <div class="info-row">
                        <span>수익 거래</span>
                        <strong class="positive">[[${result.kellyStrategy.winTrades}]]건</strong>
                    </div>
                    <div class="info-row">
                        <span>손실 거래</span>
                        <strong class="negative">[[${result.kellyStrategy.lossTrades}]]건</strong>
                    </div>
                    <div class="info-row">
                        <span>평균 수익</span>
                        <strong class="positive">[[${#numbers.formatDecimal(result.kellyStrategy.avgWin, 1, 2)}]]%</strong>
                    </div>
                    <div class="info-row">
                        <span>평균 손실</span>
                        <strong class="negative">[[${#numbers.formatDecimal(result.kellyStrategy.avgLoss, 1, 2)}]]%</strong>
                    </div>
                    <div class="info-row">
                        <span data-bs-toggle="tooltip"
                              data-bs-placement="left"
                              title="수익/손실 비율: 평균 수익을 평균 손실로 나눈 값입니다. 1보다 크면 수익이 손실보다 크다는 의미입니다.">
                            수익/손실 비율 <i class="fas fa-info-circle text-muted" style="font-size: 0.7rem;"></i>
                        </span>
                        <strong>[[${#numbers.formatDecimal(result.kellyStrategy.winLossRatio, 1, 2)}]]</strong>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="stat-card">
                    <h5><i class="fas fa-cog"></i> 백테스팅 설정</h5>
                    <div class="info-row">
                        <span>초기 자산</span>
                        <strong>₩[[${#numbers.formatDecimal(initialCapital, 1, 0)}]]</strong>
                    </div>
                    <div class="info-row">
                        <span>신뢰도 임계값</span>
                        <strong>[[${confidenceThreshold}]]</strong>
                    </div>
                    <div class="info-row">
                        <span>포지션 크기</span>
                        <strong th:if="${positionSizePercent != null}">[[${positionSizePercent}]]% (고정)</strong>
                        <strong th:if="${positionSizePercent == null}">켈리 공식 (자동)</strong>
                    </div>
                    <div class="info-row">
                        <span data-bs-toggle="tooltip"
                              data-bs-placement="left"
                              title="시장 레짐: 해당 기간의 시장 상태입니다. BULL(상승장), BEAR(하락장), SIDEWAYS(횡보장)로 구분됩니다.">
                            시장 레짐 <i class="fas fa-info-circle text-muted" style="font-size: 0.7rem;"></i>
                        </span>
                        <strong>[[${result.regime}]]</strong>
                    </div>
                    <div class="info-row">
                        <span>기간</span>
                        <strong>[[${result.startDate}]] ~ [[${result.endDate}]]</strong>
                    </div>
                    <div class="info-row">
                        <span data-bs-toggle="tooltip"
                              data-bs-placement="left"
                              title="알파(초과 수익률): 켈리 전략의 수익률에서 매수 후 보유 전략의 수익률을 뺀 값입니다. 양수면 켈리 전략이 더 우수하다는 의미입니다.">
                            알파 (초과 수익률) <i class="fas fa-info-circle text-muted" style="font-size: 0.7rem;"></i>
                        </span>
                        <strong th:class="${result.alpha >= 0 ? 'positive' : 'negative'}">
                            [[${#numbers.formatDecimal(result.alpha, 1, 2)}]]%
                        </strong>
                    </div>
                </div>
            </div>
        </div>

        <!-- Back Button -->
        <div class="text-center mt-4 mb-4">
            <a href="/" class="btn back-button">
                <i class="fas fa-arrow-left"></i> 홈으로 돌아가기
            </a>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.js"></script>
    <script>
        // Enable Bootstrap tooltips
        document.addEventListener('DOMContentLoaded', function() {
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl)
            })
        });
    </script>
    <script th:inline="javascript">
        const ctx = document.getElementById('comparisonChart').getContext('2d');
        const kellyReturn = /*[[${result.kellyStrategy.totalReturnPct}]]*/ 0;
        const buyHoldReturn = /*[[${result.buyHoldStrategy.totalReturnPct}]]*/ 0;
        const initialCapital = /*[[${initialCapital}]]*/ 10000;

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['켈리 전략', '매수 후 보유'],
                datasets: [{
                    label: '총 수익률 (%)',
                    data: [kellyReturn, buyHoldReturn],
                    backgroundColor: [
                        kellyReturn >= buyHoldReturn ? 'rgba(40, 167, 69, 0.8)' : 'rgba(255, 193, 7, 0.8)',
                        buyHoldReturn >= kellyReturn ? 'rgba(40, 167, 69, 0.8)' : 'rgba(255, 193, 7, 0.8)'
                    ],
                    borderColor: [
                        kellyReturn >= buyHoldReturn ? 'rgba(40, 167, 69, 1)' : 'rgba(255, 193, 7, 1)',
                        buyHoldReturn >= kellyReturn ? 'rgba(40, 167, 69, 1)' : 'rgba(255, 193, 7, 1)'
                    ],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    },
                    title: {
                        display: true,
                        text: '전략 성과 비교',
                        font: {
                            size: 16,
                            weight: 'bold'
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                label += context.parsed.y.toFixed(2) + '%';
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: '수익률 (%)'
                        }
                    }
                }
            }
        });
    </script>
</body>
</html>
