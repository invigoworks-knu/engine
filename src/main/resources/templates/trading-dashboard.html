<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>거래 대시보드</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-main: #FFFFFF;
            --text-main: #313647;
            --nav-bg: #313647;
            --accent-dark: #435663;
            --accent-green: #A3B087; /* Sage Green */
            --accent-cream: #FFF8D4;
        }
        body { background-color: var(--bg-main); color: var(--text-main); font-family: 'Segoe UI', sans-serif; }

        /* Navbar 수정: 현재 페이지(active) 강조 스타일 복구 */
        .navbar { background-color: var(--nav-bg) !important; padding: 1rem 0; }
        .navbar-brand { color: #FFFFFF !important; font-weight: 800; }

        .navbar .nav-link {
            color: rgba(255,255,255,0.6) !important;
            padding: 0.5rem 1rem;
            margin: 0 0.2rem;
            transition: all 0.3s;
        }
        .navbar .nav-link:hover { color: #FFFFFF !important; }

        /* 활성화된 메뉴: 초록색 배경 + 흰색 글씨 */
        .navbar .nav-link.active {
            background-color: var(--accent-green) !important;
            color: #FFFFFF !important;
            font-weight: 700;
            border-radius: 8px;
        }

        .card { border: 1px solid #e0e0e0; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); background: #FFFFFF; margin-bottom: 20px; }
        .card-header { background-color: var(--text-main); color: #FFFFFF; border-bottom: none; font-weight: 600; border-radius: 12px 12px 0 0 !important; padding: 1rem 1.5rem; }

        .balance-text { color: var(--text-main); font-weight: 800; }

        /* 버튼 스타일 */
        .btn-primary { background-color: var(--accent-dark); border: none; color: #FFFFFF; }
        .btn-primary:hover { background-color: var(--text-main); }

        .btn-success { background-color: var(--accent-green); border: none; color: #FFFFFF; font-weight: bold; }
        .btn-success:hover { background-color: #8f9b75; color: #FFFFFF; }

        .badge-buy { background-color: var(--accent-green); color: #FFFFFF; }
        .badge-sell { background-color: var(--accent-cream); color: var(--text-main); }

        /* 탭 디자인: 매수/매도 모두 초록색(Green)으로 통일 */
        .nav-pills .nav-link {
            color: #999;
            background-color: #f8f9fa;
            border-radius: 8px;
            margin: 0 2px;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        /* 탭 활성화 시 공통 스타일 */
        .nav-pills .nav-link.active {
            background-color: var(--accent-green) !important;
            color: #FFFFFF !important;
        }

        /* Tooltip & Modal */
        [data-bs-toggle="tooltip"] { cursor: help; text-decoration: underline dotted; text-decoration-color: #ccc; }
        .tooltip-inner { max-width: none; white-space: nowrap; }

        .modal-content { border-radius: 15px; border: none; overflow: hidden; }
        .modal-header { background-color: var(--text-main); color: white; border-bottom: none; }
        .modal-footer { border-top: none; background-color: #f8f9fa; }
        .btn-modal-cancel { background-color: #e0e0e0; color: var(--text-main); font-weight: 600; border: none; }
        .btn-modal-confirm { background-color: var(--accent-green); color: white; font-weight: 600; border: none; }
        .btn-modal-confirm:hover { background-color: #8f9b75; }
        /* 모달 버튼도 통일성을 위해 danger 대신 confirm 클래스 사용 가능하나, 로직 유지를 위해 스타일만 맞춤 */
        .btn-modal-confirm-danger { background-color: var(--accent-green); color: white; font-weight: 600; border: none; }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark sticky-top">
    <div class="container">
        <a class="navbar-brand" href="/trading/dashboard"><i class="fas fa-chart-line me-2"></i>AI Engine</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"><span class="navbar-toggler-icon"></span></button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link active" href="/trading/dashboard">대시보드</a></li>
                <li class="nav-item"><a class="nav-link" href="/trading/history">거래내역</a></li>
                <li class="nav-item"><a class="nav-link" href="/trading/mypage">마이페이지</a></li>
                <li class="nav-item"><a class="nav-link" href="/backtest">백테스팅</a></li>
            </ul>
        </div>
    </div>
</nav>

<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1100; margin-top: 60px;">
    <div id="dashToast" class="toast" role="alert">
        <div class="toast-header">
            <i id="toastIcon" class="fas fa-info-circle me-2"></i>
            <strong class="me-auto" id="toastTitle">알림</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="toastMessage"></div>
    </div>
</div>

<div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold" id="modalTitle">확인</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body py-4 text-center">
                <p class="fs-5 mb-0" id="modalMessage">내용</p>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-modal-cancel px-4" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-modal-confirm px-4" id="btnModalConfirm">확인</button>
            </div>
        </div>
    </div>
</div>

<div class="container py-4">
    <div class="row g-4 mb-4">
        <div class="col-lg-8">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-wallet me-2"></i>보유 자산</span>
                    <button class="btn btn-sm btn-outline-light" onclick="loadBalance()"><i class="fas fa-sync-alt"></i></button>
                </div>
                <div class="card-body d-flex align-items-center justify-content-around text-center">
                    <div>
                        <small class="text-muted d-block mb-1">KRW (원화)</small>
                        <h2 class="balance-text" id="krwBalance">-</h2>
                    </div>
                    <div style="width: 1px; height: 50px; background: #e0e0e0;"></div>
                    <div>
                        <small class="text-muted d-block mb-1">ETH (이더리움)</small>
                        <h2 class="balance-text" id="ethBalance">-</h2>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center" style="background-color: var(--accent-dark);">
                    <span><i class="fas fa-coins me-2"></i>현재가 (KRW-ETH)</span>
                    <button class="btn btn-sm btn-outline-light" onclick="loadMarketInfo()"><i class="fas fa-sync-alt"></i></button>
                </div>
                <div class="card-body text-center d-flex flex-column justify-content-center">
                    <h3 class="fw-bold mb-0" id="currentPrice" style="color: var(--text-main);"
                        data-bs-toggle="tooltip" data-bs-placement="top" title="현재 거래되고 있는 실시간 가격입니다.">-</h3>

                    <span id="changeRate" class="fs-5 fw-bold"
                          data-bs-toggle="tooltip" data-bs-placement="bottom" title="금일 오전 9시 시가 기준 등락률입니다.">-</span>

                    <div class="d-flex justify-content-between mt-3 px-4 text-muted small">
                            <span data-bs-toggle="tooltip" title="최근 24시간 내 가장 높은 가격입니다.">
                                고: <span id="highPrice">-</span>
                            </span>
                        <span data-bs-toggle="tooltip" title="최근 24시간 내 가장 낮은 가격입니다.">
                                저: <span id="lowPrice">-</span>
                            </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-5">
            <div class="card h-100">
                <div class="card-header"><i class="fas fa-bolt me-2"></i>빠른 거래</div>
                <div class="card-body">
                    <div class="alert py-2 mb-3" style="background-color: var(--accent-cream); color: var(--text-main); border: 1px solid #e0e0e0;">
                        <small><i class="fas fa-exclamation-triangle me-1"></i> <strong>주의:</strong> 실제 자금이 이동합니다.</small>
                    </div>

                    <ul class="nav nav-pills mb-3 nav-fill" id="pills-tab" role="tablist">
                        <li class="nav-item">
                            <button class="nav-link active" id="pills-buy-tab" data-bs-toggle="pill" data-bs-target="#pills-buy" type="button">매수</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" id="pills-sell-tab" data-bs-toggle="pill" data-bs-target="#pills-sell" type="button">매도</button>
                        </li>
                    </ul>

                    <div class="tab-content" id="pills-tabContent">
                        <div class="tab-pane fade show active" id="pills-buy" role="tabpanel">
                            <label class="form-label fw-bold">매수 금액 (KRW)</label>
                            <div class="input-group mb-3">
                                <input type="number" class="form-control" id="buyAmount" placeholder="5000" min="5000" step="1000">
                                <button class="btn btn-success" onclick="marketBuy()">시장가 매수</button>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="pills-sell" role="tabpanel">
                            <label class="form-label fw-bold">매도 수량 (ETH)</label>
                            <div class="input-group mb-3">
                                <input type="number" class="form-control" id="sellVolume" placeholder="0.001" min="0.0001" step="0.0001">
                                <button class="btn btn-success" onclick="marketSell()">시장가 매도</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-7">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-list me-2"></i>최근 주문 (5건)</span>
                    <button class="btn btn-sm btn-outline-light" onclick="loadRecentOrders()"><i class="fas fa-sync-alt"></i></button>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0 align-middle">
                            <thead class="table-light">
                            <tr>
                                <th>시간</th>
                                <th>구분</th>
                                <th>금액/수량</th>
                                <th>상태</th>
                            </tr>
                            </thead>
                            <tbody id="recentOrdersTable">
                            <tr><td colspan="4" class="text-center text-muted py-4">불러오는 중...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer bg-white border-top text-center">
                    <a href="/trading/history" class="text-decoration-none fw-bold" style="color: var(--accent-dark);">전체 내역 보기 <i class="fas fa-arrow-right"></i></a>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
    let modalCallback = null;
    const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));

    document.addEventListener('DOMContentLoaded', function() {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        });

        loadBalance(); loadMarketInfo(); loadRecentOrders();

        document.getElementById('btnModalConfirm').addEventListener('click', function() {
            if (modalCallback) modalCallback();
            confirmModal.hide();
        });
    });

    function showConfirmModal(title, msg, callback, type = 'success') {
        document.getElementById('modalTitle').innerText = title;
        document.getElementById('modalMessage').innerText = msg;
        modalCallback = callback;

        const btn = document.getElementById('btnModalConfirm');
        // 매수/매도 모두 녹색 버튼 사용
        if (type === 'danger') {
            btn.className = 'btn btn-modal-confirm-danger px-4'; // CSS에서 녹색으로 덮어씌움
        } else {
            btn.className = 'btn btn-modal-confirm px-4';
        }

        confirmModal.show();
    }

    function showToast(msg, isSuccess = true) {
        const t = document.getElementById('dashToast');
        document.getElementById('toastMessage').textContent = msg;
        const icon = document.getElementById('toastIcon');
        if (isSuccess) {
            icon.className = "fas fa-check-circle me-2 text-success";
            document.getElementById('toastTitle').innerText = "성공";
        } else {
            icon.className = "fas fa-exclamation-circle me-2 text-danger";
            document.getElementById('toastTitle').innerText = "오류";
        }
        new bootstrap.Toast(t, { delay: 3000 }).show();
    }

    function loadBalance() {
        fetch('/api/v1/account/balance/summary').then(r=>r.json()).then(d => {
            const krw = parseFloat(d.krw_balance||d.krwBalance||0), eth = parseFloat(d.eth_balance||d.ethBalance||0);
            document.getElementById('krwBalance').textContent = krw.toLocaleString('ko-KR',{maximumFractionDigits:0}) + ' KRW';
            document.getElementById('ethBalance').textContent = eth.toFixed(6) + ' ETH';
        });
    }
    function loadMarketInfo() {
        fetch('/api/v1/market/ticker/KRW-ETH').then(r=>r.json()).then(d => {
            document.getElementById('currentPrice').textContent = parseFloat(d.trade_price||0).toLocaleString('ko-KR') + ' KRW';
            const rate = ((d.signed_change_rate||0)*100).toFixed(2);
            const el = document.getElementById('changeRate');
            el.textContent = (rate > 0 ? '+' : '') + rate + '%';
            el.style.color = d.change==='RISE' ? '#c0392b' : (d.change==='FALL' ? '#2980b9' : '#333');
            document.getElementById('highPrice').textContent = parseFloat(d.high_price).toLocaleString('ko-KR');
            document.getElementById('lowPrice').textContent = parseFloat(d.low_price).toLocaleString('ko-KR');
        });
    }
    function loadRecentOrders() {
        fetch('/api/v1/trading/orders/local').then(r=>r.json()).then(orders => {
            const tbody = document.getElementById('recentOrdersTable'); tbody.innerHTML = '';
            if(!orders.length) { tbody.innerHTML = '<tr><td colspan="4" class="text-center py-3">내역 없음</td></tr>'; return; }
            orders.slice(-5).reverse().forEach(o => {
                const row = document.createElement('tr');
                const sideBadge = o.side==='BUY' ? '<span class="badge badge-buy">매수</span>' : '<span class="badge badge-sell">매도</span>';
                const statusClass = o.status==='FILLED' ? 'text-success' : 'text-muted';
                const amount = o.amount ? parseFloat(o.amount).toFixed(4) : '-';
                row.innerHTML = `<td><small>${new Date(o.createdAt).toLocaleTimeString()}</small></td><td>${sideBadge}</td><td>${amount}</td><td class="${statusClass} fw-bold"><small>${o.status}</small></td>`;
                tbody.appendChild(row);
            });
        });
    }

    function marketBuy() {
        const amt = document.getElementById('buyAmount').value;
        if(!amt) return showToast('매수할 금액을 입력해주세요.', false);

        showConfirmModal('매수 확인', '정말 ' + parseInt(amt).toLocaleString() + ' KRW 매수를 진행하시겠습니까?', function() {
            fetch('/api/v1/trading/market-buy', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({market:'KRW-ETH',amount:amt})})
            .then(r=>r.json()).then(d=>{
                if(d.status==='error') showToast(d.message, false);
                else { showToast('매수 주문이 정상적으로 체결되었습니다.', true); loadBalance(); loadRecentOrders(); document.getElementById('buyAmount').value=''; }
            });
        }, 'success');
    }

    function marketSell() {
        const vol = document.getElementById('sellVolume').value;
        if(!vol) return showToast('매도할 수량을 입력해주세요.', false);

        // type='danger'를 넘겨도 CSS에서 녹색으로 처리됨
        showConfirmModal('매도 확인', '정말 ' + vol + ' ETH 매도를 진행하시겠습니까?', function() {
            fetch('/api/v1/trading/market-sell', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({market:'KRW-ETH',volume:vol})})
            .then(r=>r.json()).then(d=>{
                if(d.status==='error') showToast(d.message, false);
                else { showToast('매도 주문이 정상적으로 체결되었습니다.', true); loadBalance(); loadRecentOrders(); document.getElementById('sellVolume').value=''; }
            });
        }, 'danger');
    }
</script>
</body>
</html>