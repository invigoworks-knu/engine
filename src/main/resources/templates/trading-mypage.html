<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>마이페이지</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --bg-main: #FFFFFF; --text-main: #313647; --nav-bg: #313647; --accent-dark: #435663; --accent-green: #A3B087; --accent-cream: #FFF8D4; }
        body { background-color: var(--bg-main); color: var(--text-main); font-family: 'Segoe UI', sans-serif; }
        /* Navbar 수정됨 */
        .navbar { background-color: var(--nav-bg) !important; padding: 1rem 0; }
        .navbar-brand { color: #FFFFFF !important; font-weight: 800; }
        .navbar .nav-link { color: rgba(255,255,255,0.6) !important; padding: 0.5rem 1rem; margin: 0 0.2rem; transition: all 0.3s; }
        .navbar .nav-link:hover { color: #FFFFFF !important; }
        .navbar .nav-link.active { background-color: var(--accent-green); color: #FFFFFF !important; font-weight: 700; border-radius: 8px; }

        .card { border: 1px solid #e0e0e0; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); background: #FFFFFF; margin-bottom: 20px; }
        .card-header { background-color: var(--text-main); color: #FFFFFF; border-radius: 12px 12px 0 0 !important; font-weight: 600; padding: 1rem 1.5rem; }
        .btn-primary { background-color: var(--accent-dark); border: none; }

        /* Modal Styling */
        .modal-content { border-radius: 15px; border: none; overflow: hidden; }
        .modal-header { background-color: var(--text-main); color: white; border-bottom: none; }
        .modal-footer { border-top: none; background-color: #f8f9fa; }
        .btn-modal-cancel { background-color: #e0e0e0; color: var(--text-main); font-weight: 600; border: none; }
        .btn-modal-confirm { background-color: var(--accent-green); color: white; font-weight: 600; border: none; }
        .btn-modal-confirm-danger { background-color: var(--accent-cream); color: var(--text-main); font-weight: 600; border: 1px solid #ccc; }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark sticky-top">
    <div class="container">
        <a class="navbar-brand" href="/trading/dashboard"><i class="fas fa-chart-line me-2"></i>AI Engine</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"><span class="navbar-toggler-icon"></span></button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link" href="/trading/dashboard">대시보드</a></li>
                <li class="nav-item"><a class="nav-link" href="/trading/history">거래내역</a></li>
                <li class="nav-item"><a class="nav-link active" href="/trading/mypage">마이페이지</a></li>
                <li class="nav-item"><a class="nav-link" href="/backtest">백테스팅</a></li>
            </ul>
        </div>
    </div>
</nav>

<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1100; margin-top: 60px;">
    <div id="myToast" class="toast" role="alert">
        <div class="toast-header">
            <i id="toastIcon" class="fas fa-info-circle me-2"></i>
            <strong class="me-auto" id="toastTitle">알림</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="toastMessage"></div>
    </div>
</div>

<div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold" id="modalTitle">확인</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body py-4 text-center">
                <p class="fs-5 mb-0" id="modalMessage">내용</p>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-modal-cancel px-4" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-modal-confirm px-4" id="btnModalConfirm">확인</button>
            </div>
        </div>
    </div>
</div>

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-6">
            <div class="card text-center mb-4">
                <div class="card-body py-4">
                    <h5 class="mb-3 fw-bold">안전장치 (Circuit Breaker)</h5>
                    <div class="mb-4">
                        <span id="statusBadge" class="badge rounded-pill fs-5 px-4 py-2">확인 중...</span>
                    </div>
                    <button class="btn btn-lg w-75 fw-bold shadow-sm" id="toggleBtn" onclick="toggleSafety()"><span id="toggleText">전환</span></button>
                    <p class="mt-3 small text-muted">비활성화 시 모든 신규 거래가 차단됩니다.</p>
                </div>
            </div>

            <div class="card">
                <div class="card-header"><i class="fas fa-cog me-2"></i>거래 환경 설정</div>
                <div class="card-body p-4">
                    <form id="settingsForm">
                        <div class="mb-3">
                            <label class="form-label fw-bold">최소 주문 금액 (KRW)</label>
                            <input type="number" class="form-control" id="minOrderAmount" min="5000">
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">최대 주문 금액 (KRW)</label>
                            <input type="number" class="form-control" id="maxOrderAmount">
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">일일 최대 거래 횟수</label>
                            <input type="number" class="form-control" id="maxDailyTrades">
                        </div>
                        <div class="mb-4">
                            <label class="form-label fw-bold">허용 마켓</label>
                            <select class="form-select" id="allowedMarket">
                                <option value="KRW-ETH">KRW-ETH</option>
                            </select>
                        </div>
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-primary py-2 fw-bold" onclick="saveSettings()">설정 저장</button>
                            <button type="button" class="btn btn-outline-secondary" onclick="resetSettings()">기본값 복원</button>
                        </div>
                    </form>
                </div>
            </div>
            <div class="text-center text-muted small mt-3">Last Updated: <span id="lastUpdate">-</span></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // 모달 및 상태 변수
    let modalCallback = null;
    const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));

    document.addEventListener('DOMContentLoaded', function() {
        loadSettings();
        // 모달 확인 버튼 이벤트 리스너
        document.getElementById('btnModalConfirm').addEventListener('click', function() {
            if (modalCallback) modalCallback();
            confirmModal.hide();
        });
    });

    // 커스텀 모달 함수
    function showConfirmModal(title, msg, callback, type = 'success') {
        document.getElementById('modalTitle').innerText = title;
        document.getElementById('modalMessage').innerText = msg;
        modalCallback = callback;

        const btn = document.getElementById('btnModalConfirm');
        if (type === 'danger') {
            btn.className = 'btn btn-modal-confirm-danger px-4';
        } else {
            btn.className = 'btn btn-modal-confirm px-4';
        }

        confirmModal.show();
    }

    function showToast(msg, isSuccess = true) {
        const t = document.getElementById('myToast');
        document.getElementById('toastMessage').textContent = msg;
        const icon = document.getElementById('toastIcon');
        if (isSuccess) {
            icon.className = "fas fa-check-circle me-2 text-success";
            document.getElementById('toastTitle').innerText = "완료";
        } else {
            icon.className = "fas fa-exclamation-circle me-2 text-danger";
            document.getElementById('toastTitle').innerText = "알림";
        }
        new bootstrap.Toast(t, { delay: 3000 }).show();
    }

    function loadSettings() {
        fetch('/api/v1/settings').then(r=>r.json()).then(s=>{
            document.getElementById('minOrderAmount').value=s.minOrderAmount;
            document.getElementById('maxOrderAmount').value=s.maxOrderAmount;
            document.getElementById('maxDailyTrades').value=s.maxDailyTrades;
            document.getElementById('allowedMarket').value=s.allowedMarket;
            document.getElementById('lastUpdate').textContent=new Date(s.updatedAt).toLocaleString();
            updateBadge(s.isEnabled);
        });
    }
    function updateBadge(on) {
        const b=document.getElementById('statusBadge'), btn=document.getElementById('toggleBtn'), txt=document.getElementById('toggleText');
        if(on){ b.textContent='정상 작동 중'; b.className='badge rounded-pill bg-success fs-5 px-4 py-2'; btn.className='btn btn-lg btn-outline-danger w-75'; txt.textContent='거래 차단하기'; }
        else{ b.textContent='거래 중지됨'; b.className='badge rounded-pill bg-danger fs-5 px-4 py-2'; btn.className='btn btn-lg btn-success w-75'; txt.textContent='거래 재개하기'; }
    }

    function toggleSafety() {
        fetch('/api/v1/settings').then(r=>r.json()).then(s=>{
            const msg = s.isEnabled ? '안전장치를 끄고 거래를 차단하시겠습니까?' : '안전장치를 켜고 거래를 재개하시겠습니까?';
            const type = s.isEnabled ? 'danger' : 'success';

            showConfirmModal('안전장치 변경', msg, function() {
                fetch('/api/v1/settings/toggle',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({enabled:!s.isEnabled})}).then(r=>r.json()).then(d=>{
                    updateBadge(d.isEnabled);
                    showToast(d.isEnabled ? '안전장치가 활성화되었습니다.' : '안전장치가 비활성화되었습니다.', true);
                });
            }, type);
        });
    }

    function saveSettings() {
        showConfirmModal('설정 저장', '현재 설정을 저장하시겠습니까?', function() {
            const d={minOrderAmount:document.getElementById('minOrderAmount').value,maxOrderAmount:document.getElementById('maxOrderAmount').value,maxDailyTrades:document.getElementById('maxDailyTrades').value,allowedMarket:document.getElementById('allowedMarket').value};
            fetch('/api/v1/settings',{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(d)})
            .then(r=>r.json()).then(d=>{
                if(d.status==='error') showToast(d.message, false);
                else{ showToast('설정이 저장되었습니다.', true); loadSettings(); }
            });
        }, 'success');
    }

    function resetSettings() {
        showConfirmModal('초기화', '설정을 기본값으로 복원하시겠습니까?', function() {
            fetch('/api/v1/settings/reset',{method:'POST'}).then(r=>r.json()).then(()=>{ showToast('설정이 초기화되었습니다.', true); loadSettings(); });
        }, 'danger');
    }
</script>
</body>
</html>