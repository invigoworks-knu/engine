<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>거래 내역</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --bg-main: #FFFFFF; --text-main: #313647; --nav-bg: #313647; --accent-dark: #435663; --accent-green: #A3B087; --accent-cream: #FFF8D4; }
        body { background-color: var(--bg-main); color: var(--text-main); font-family: 'Segoe UI', sans-serif; }
        /* Navbar 수정됨 */
        .navbar { background-color: var(--nav-bg) !important; padding: 1rem 0; }
        .navbar-brand { color: #FFFFFF !important; font-weight: 800; }
        .navbar .nav-link { color: rgba(255,255,255,0.6) !important; padding: 0.5rem 1rem; margin: 0 0.2rem; transition: all 0.3s; }
        .navbar .nav-link:hover { color: #FFFFFF !important; }
        .navbar .nav-link.active { background-color: var(--accent-green); color: #FFFFFF !important; font-weight: 700; border-radius: 8px; }

        .card { border: 1px solid #e0e0e0; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); background: #FFFFFF; margin-bottom: 20px; }
        .card-header { background-color: var(--accent-dark); color: #FFFFFF; border-radius: 12px 12px 0 0 !important; font-weight: 600; padding: 1rem 1.5rem; }

        .table thead th { background-color: #f8f9fa; border-bottom: 2px solid var(--accent-dark); }
        .btn-primary { background-color: var(--text-main); border: none; }

        /* Modal Styling */
        .modal-content { border-radius: 15px; border: none; overflow: hidden; }
        .modal-header { background-color: var(--text-main); color: white; border-bottom: none; }
        .modal-footer { border-top: none; background-color: #f8f9fa; }
        .btn-modal-cancel { background-color: #e0e0e0; color: var(--text-main); font-weight: 600; border: none; }
        .btn-modal-confirm { background-color: var(--accent-green); color: white; font-weight: 600; border: none; }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark sticky-top">
    <div class="container">
        <a class="navbar-brand" href="/trading/dashboard"><i class="fas fa-chart-line me-2"></i>AI Engine</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"><span class="navbar-toggler-icon"></span></button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link" href="/trading/dashboard">대시보드</a></li>
                <li class="nav-item"><a class="nav-link active" href="/trading/history">거래내역</a></li>
                <li class="nav-item"><a class="nav-link" href="/trading/mypage">마이페이지</a></li>
                <li class="nav-item"><a class="nav-link" href="/backtest">백테스팅</a></li>
            </ul>
        </div>
    </div>
</nav>

<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1100; margin-top: 60px;">
    <div id="histToast" class="toast" role="alert">
        <div class="toast-header">
            <i id="toastIcon" class="fas fa-info-circle me-2"></i>
            <strong class="me-auto" id="toastTitle">알림</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="toastMessage"></div>
    </div>
</div>

<div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold" id="modalTitle">확인</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body py-4 text-center">
                <p class="fs-5 mb-0" id="modalMessage">내용</p>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-modal-cancel px-4" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-modal-confirm px-4" id="btnModalConfirm">확인</button>
            </div>
        </div>
    </div>
</div>

<div class="container py-4">
    <div class="row mb-4 text-center">
        <div class="col-4"><div class="card py-3"><h3 id="totalOrders">-</h3><small class="text-muted">총 주문</small></div></div>
        <div class="col-4"><div class="card py-3"><h3 id="totalBuy" class="text-success">-</h3><small class="text-muted">매수</small></div></div>
        <div class="col-4"><div class="card py-3"><h3 id="totalSell" class="text-danger">-</h3><small class="text-muted">매도</small></div></div>
    </div>

    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span><i class="fas fa-list me-2"></i>거래 기록</span>
            <span id="orderCount" class="badge bg-light text-dark">0건</span>
        </div>
        <div class="card-body">
            <div class="row g-2 mb-4">
                <div class="col-md-3">
                    <select class="form-select" id="sideFilter" onchange="filterOrders()">
                        <option value="ALL">전체 타입</option>
                        <option value="BUY">매수</option>
                        <option value="SELL">매도</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="statusFilter" onchange="filterOrders()">
                        <option value="ALL">전체 상태</option>
                        <option value="FILLED">체결</option>
                        <option value="PENDING">대기</option>
                        <option value="CANCELED">취소</option>
                    </select>
                </div>
                <div class="col-md-6 text-end">
                    <button class="btn btn-primary" onclick="loadOrders()"><i class="fas fa-sync me-1"></i> 새로고침</button>
                    <button class="btn btn-outline-dark ms-2" onclick="syncAllOrders()"><i class="fas fa-cloud-download-alt me-1"></i> 동기화</button>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead>
                    <tr>
                        <th>시간</th>
                        <th>구분</th>
                        <th>마켓</th>
                        <th>가격</th>
                        <th>수량</th>
                        <th>상태</th>
                        <th>UUID</th>
                    </tr>
                    </thead>
                    <tbody id="ordersTableBody">
                    <tr><td colspan="7" class="text-center py-4">로딩 중...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let allOrders=[];
    let modalCallback = null;
    const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));

    document.addEventListener('DOMContentLoaded', function() {
        loadOrders();
        document.getElementById('btnModalConfirm').addEventListener('click', function() {
            if (modalCallback) modalCallback();
            confirmModal.hide();
        });
    });

    function showConfirmModal(title, msg, callback) {
        document.getElementById('modalTitle').innerText = title;
        document.getElementById('modalMessage').innerText = msg;
        modalCallback = callback;
        confirmModal.show();
    }

    function showToast(msg, isSuccess = true) {
        const t = document.getElementById('histToast');
        document.getElementById('toastMessage').textContent = msg;
        const icon = document.getElementById('toastIcon');
        if (isSuccess) {
            icon.className = "fas fa-check-circle me-2 text-success";
            document.getElementById('toastTitle').innerText = "완료";
        } else {
            icon.className = "fas fa-exclamation-circle me-2 text-danger";
            document.getElementById('toastTitle').innerText = "알림";
        }
        new bootstrap.Toast(t, { delay: 3000 }).show();
    }

    function loadOrders() { fetch('/api/v1/trading/orders/local').then(r=>r.json()).then(d=>{ allOrders=d; displayOrders(d); updateStats(d); }); }
    function displayOrders(d) {
        const b=document.getElementById('ordersTableBody'); b.innerHTML='';
        if(!d.length){ b.innerHTML='<tr><td colspan="7" class="text-center py-4">내역 없음</td></tr>'; return; }
        d.sort((x,y)=>new Date(y.createdAt)-new Date(x.createdAt));
        d.forEach(o=>{
            const r=document.createElement('tr');
            const sb=o.side==='BUY'?'<span class="badge bg-success">매수</span>':'<span class="badge bg-danger">매도</span>';
            r.innerHTML=`<td>${new Date(o.createdAt).toLocaleString()}</td><td>${sb}</td><td>${o.market}</td><td>${o.price?parseFloat(o.price).toLocaleString():'-'}</td><td>${o.amount?parseFloat(o.amount).toFixed(6):'-'}</td><td><span class="badge bg-secondary">${o.status}</span></td><td><small class="text-muted">${o.upbitOrderUuid?o.upbitOrderUuid.substring(0,8)+'...':'-'}</small></td>`;
            b.appendChild(r);
        });
        document.getElementById('orderCount').textContent=`총 ${d.length}건`;
    }
    function updateStats(d) {
        document.getElementById('totalOrders').textContent=d.length;
        document.getElementById('totalBuy').textContent=d.filter(o=>o.side==='BUY').length;
        document.getElementById('totalSell').textContent=d.filter(o=>o.side==='SELL').length;
    }
    function filterOrders() {
        const s=document.getElementById('sideFilter').value, st=document.getElementById('statusFilter').value;
        displayOrders(allOrders.filter(o=>(s==='ALL'||o.side===s)&&(st==='ALL'||o.status===st)));
    }

    function syncAllOrders() {
        showConfirmModal('동기화 확인', '업비트 주문 상태를 동기화하시겠습니까?', function() {
            fetch('/api/v1/trading/orders/sync-all',{method:'POST'})
            .then(r=>r.json())
            .then(d=>{
                if(d.status === 'error') showToast(d.message, false);
                else { showToast(`동기화 완료: ${d.synced_count}건`, true); loadOrders(); }
            })
            .catch(e => showToast('동기화 중 오류 발생', false));
        });
    }
</script>
</body>
</html>